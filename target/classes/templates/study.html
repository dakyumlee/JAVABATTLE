<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>ì˜¤ëŠ˜ì˜ í•™ìŠµ - Java Battle Arena</title>
   <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" rel="stylesheet">
   <style>
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }

       body {
           font-family: 'Pretendard', sans-serif;
           background: #0a0a0a;
           color: #ffffff;
           min-height: 100vh;
       }

       .header {
           background: #1a1a1a;
           padding: 1rem 2rem;
           border-bottom: 1px solid #333;
           display: flex;
           justify-content: space-between;
           align-items: center;
       }

       .logo {
           display: flex;
           align-items: center;
           gap: 0.5rem;
           font-size: 1.2rem;
           font-weight: 600;
           color: #3498db;
       }

       .back-btn {
           background: #6c757d;
           color: white;
           padding: 0.5rem 1rem;
           border: none;
           border-radius: 6px;
           cursor: pointer;
           text-decoration: none;
           transition: background-color 0.2s ease;
       }

       .back-btn:hover {
           background: #5a6268;
       }

       .container {
           max-width: 1200px;
           margin: 0 auto;
           padding: 2rem;
       }

       .shared-materials-section {
           margin-bottom: 3rem;
           background: #1a1a1a;
           border-radius: 16px;
           padding: 2rem;
           border: 1px solid #333;
       }

       .section-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 1.5rem;
       }

       .section-title {
           color: #3498db;
           font-size: 1.5rem;
           font-weight: 600;
           display: flex;
           align-items: center;
           gap: 0.5rem;
       }

       .material-notification {
           background: #e74c3c;
           color: white;
           padding: 0.5rem 1rem;
           border-radius: 20px;
           font-size: 0.9rem;
           font-weight: 600;
           animation: pulse 2s infinite;
           display: none;
       }

       @keyframes pulse {
           0% { opacity: 1; transform: scale(1); }
           50% { opacity: 0.7; transform: scale(1.05); }
           100% { opacity: 1; transform: scale(1); }
       }

       .materials-grid {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
           gap: 1.5rem;
           margin-bottom: 1rem;
       }

       .material-card {
           background: #2d2d2d;
           border: 1px solid #333;
           border-radius: 12px;
           padding: 1.5rem;
           transition: all 0.3s ease;
           cursor: pointer;
           position: relative;
           overflow: hidden;
       }

       .material-card:hover {
           border-color: #3498db;
           transform: translateY(-3px);
           box-shadow: 0 8px 20px rgba(52, 152, 219, 0.2);
       }

       .material-card.new {
           border-color: #e74c3c;
           box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
       }

       .material-header {
           display: flex;
           justify-content: space-between;
           align-items: flex-start;
           margin-bottom: 1rem;
       }

       .material-title {
           font-size: 1.1rem;
           font-weight: 600;
           color: #3498db;
           margin-bottom: 0.5rem;
       }

       .material-category {
           background: #3498db;
           color: white;
           padding: 0.25rem 0.75rem;
           border-radius: 12px;
           font-size: 0.8rem;
           font-weight: 500;
       }

       .material-description {
           color: #95a5a6;
           margin-bottom: 1rem;
           line-height: 1.5;
           font-size: 0.9rem;
       }

       .material-meta {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 1rem;
       }

       .material-type {
           display: flex;
           align-items: center;
           gap: 0.5rem;
           color: #95a5a6;
           font-size: 0.9rem;
       }

       .material-date {
           color: #6c757d;
           font-size: 0.8rem;
       }

       .material-actions {
           display: flex;
           gap: 0.5rem;
       }

       .action-btn {
           background: #3498db;
           color: white;
           border: none;
           padding: 0.5rem 1rem;
           border-radius: 6px;
           cursor: pointer;
           font-size: 0.9rem;
           transition: background-color 0.2s ease;
           flex: 1;
       }

       .action-btn:hover {
           background: #2980b9;
       }

       .action-btn.secondary {
           background: #6c757d;
       }

       .action-btn.secondary:hover {
           background: #5a6268;
       }

       .no-materials {
           text-align: center;
           padding: 3rem 2rem;
           background: #2d2d2d;
           border-radius: 12px;
           color: #95a5a6;
           border: 2px dashed #333;
       }

       .no-materials-icon {
           font-size: 3rem;
           margin-bottom: 1rem;
           opacity: 0.5;
       }

       .my-submissions-section {
           margin-bottom: 3rem;
           background: #1a1a1a;
           border-radius: 16px;
           padding: 2rem;
           border: 1px solid #333;
       }

       .submissions-tabs {
           display: flex;
           gap: 0.5rem;
           margin-bottom: 2rem;
           padding: 0.25rem;
           background: #2d2d2d;
           border-radius: 12px;
           border: 1px solid #333;
       }

       .submission-tab {
           padding: 0.75rem 1.5rem;
           background: transparent;
           border: none;
           border-radius: 8px;
           cursor: pointer;
           transition: all 0.3s ease;
           color: #95a5a6;
           font-size: 0.9rem;
           font-weight: 500;
           flex: 1;
           text-align: center;
       }

       .submission-tab.active {
           background: #3498db;
           color: white;
           box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
       }

       .submission-tab:hover:not(.active) {
           background: rgba(52, 152, 219, 0.1);
           color: #3498db;
       }

       .my-submissions-grid, .my-quiz-submissions-grid {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
           gap: 1.5rem;
       }

       .submission-card {
           background: linear-gradient(145deg, #2d2d2d, #242424);
           border: 1px solid #333;
           border-radius: 16px;
           padding: 1.8rem;
           transition: all 0.3s ease;
           position: relative;
           overflow: hidden;
           box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
       }

       .submission-card::before {
           content: '';
           position: absolute;
           top: 0;
           left: 0;
           right: 0;
           height: 3px;
           background: linear-gradient(90deg, #3498db, #2980b9);
           border-radius: 16px 16px 0 0;
       }

       .submission-card:hover {
           border-color: #3498db;
           transform: translateY(-4px);
           box-shadow: 0 12px 24px rgba(52, 152, 219, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
       }

       .submission-header {
           margin-bottom: 1rem;
       }

       .submission-title {
           font-size: 1.1rem;
           font-weight: 600;
           color: #3498db;
           margin-bottom: 0.5rem;
       }

       .submission-meta {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 1rem;
       }

       .submission-date {
           color: #6c757d;
           font-size: 0.8rem;
       }

       .score-badge {
           padding: 0.3rem 0.8rem;
           border-radius: 12px;
           font-size: 0.8rem;
           font-weight: 600;
       }

       .score-excellent {
           background: #27ae60;
           color: white;
       }

       .score-good {
           background: #3498db;
           color: white;
       }

       .score-fair {
           background: #f39c12;
           color: white;
       }

       .score-poor {
           background: #e74c3c;
           color: white;
       }

       .score-ungraded {
           background: #6c757d;
           color: white;
       }

       .submission-answer {
           background: #1a1a1a;
           border-radius: 8px;
           padding: 1rem;
           margin-bottom: 1rem;
           border-left: 4px solid #3498db;
       }

       .submission-answer-label {
           font-size: 0.85rem;
           color: #95a5a6;
           margin-bottom: 0.5rem;
           font-weight: 500;
       }

       .submission-answer-content {
           color: #ffffff;
           line-height: 1.5;
           font-size: 0.9rem;
           white-space: pre-wrap;
           max-height: 120px;
           overflow-y: auto;
       }

       .submission-feedback {
           background: linear-gradient(135deg, #27ae60, #2ecc71);
           border-radius: 12px;
           padding: 1.2rem;
           margin-top: 1rem;
           border-left: 4px solid #1e8449;
           box-shadow: 0 2px 8px rgba(39, 174, 96, 0.2);
       }

       .submission-feedback-label {
           font-size: 0.85rem;
           color: #ffffff;
           margin-bottom: 0.5rem;
           font-weight: 600;
           opacity: 0.9;
       }

       .submission-feedback-content {
           color: #ffffff;
           line-height: 1.5;
           font-size: 0.9rem;
           white-space: pre-wrap;
       }

       .quiz-result {
           display: flex;
           align-items: center;
           gap: 0.8rem;
           margin-bottom: 1rem;
       }

       .quiz-result-icon {
           font-size: 1.5rem;
       }

       .quiz-result-text {
           flex: 1;
       }

       .quiz-result-status {
           font-size: 0.9rem;
           font-weight: 600;
       }

       .quiz-correct {
           color: #27ae60;
       }

       .quiz-incorrect {
           color: #e74c3c;
       }

       .quiz-answer-details {
           background: #1a1a1a;
           border-radius: 8px;
           padding: 1rem;
           margin-bottom: 1rem;
           border-left: 4px solid #3498db;
       }

       .quiz-answer-row {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 0.5rem;
       }

       .quiz-answer-row:last-child {
           margin-bottom: 0;
       }

       .quiz-answer-label {
           font-size: 0.85rem;
           color: #95a5a6;
           font-weight: 500;
       }

       .quiz-answer-value {
           color: #ffffff;
           font-size: 0.9rem;
           font-weight: 600;
       }

       .loading-message {
           text-align: center;
           padding: 3rem 2rem;
           background: #2d2d2d;
           border-radius: 12px;
           color: #95a5a6;
           border: 2px dashed #333;
           grid-column: 1 / -1;
       }

       .no-submissions {
           text-align: center;
           padding: 3rem 2rem;
           background: #2d2d2d;
           border-radius: 12px;
           color: #95a5a6;
           border: 2px dashed #333;
           grid-column: 1 / -1;
       }

       .no-submissions-icon {
           font-size: 3rem;
           margin-bottom: 1rem;
           opacity: 0.5;
       }

       @media (max-width: 768px) {
           .container {
               padding: 1rem;
           }
           
           .problems-grid, .materials-grid, .my-submissions-grid, .my-quiz-submissions-grid {
               grid-template-columns: 1fr;
           }

           .section-header {
               flex-direction: column;
               align-items: flex-start;
               gap: 1rem;
           }

           .material-header {
               flex-direction: column;
               align-items: flex-start;
               gap: 0.5rem;
           }

           .material-actions {
               width: 100%;
               justify-content: stretch;
           }

           .action-btn {
               flex: 1;
           }
       }
   </style>
</head>
<body>
   <div class="header">
       <div class="logo">
           ğŸ“š ì˜¤ëŠ˜ì˜ í•™ìŠµ
       </div>
       <a href="/" class="back-btn">â† í™ˆìœ¼ë¡œ</a>
   </div>

   <div class="container">
       <div class="shared-materials-section">
           <div class="section-header">
               <h2 class="section-title">
                   ğŸ“š ê³µìœ ëœ í•™ìŠµìë£Œ
               </h2>
               <div class="material-notification" id="materialNotification">
                   ìƒˆ ìë£Œ ë„ì°©!
               </div>
           </div>
           
           <div class="materials-grid" id="sharedMaterialsGrid">
           </div>
           
           <div class="no-materials" id="noMaterials">
               <div class="no-materials-icon">ğŸ“„</div>
               <p><strong>ì•„ì§ ê³µìœ ëœ í•™ìŠµìë£Œê°€ ì—†ìŠµë‹ˆë‹¤</strong></p>
               <p>ê°•ì‚¬ë‹˜ì´ ìë£Œë¥¼ ê³µìœ í•˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤</p>
           </div>
       </div>

       <div class="my-submissions-section">
           <div class="section-header">
               <h2 class="section-title">
                   ğŸ“ ë‚´ ë‹µì•ˆ ë° í”¼ë“œë°±
               </h2>
           </div>
           
           <div class="submissions-tabs">
               <button class="submission-tab active" onclick="switchMySubmissionTab('problems')">ë¬¸ì œ ë‹µì•ˆ</button>
               <button class="submission-tab" onclick="switchMySubmissionTab('quiz')">í€´ì¦ˆ ë‹µì•ˆ</button>
           </div>
           
           <div class="my-submissions-grid" id="mySubmissionsGrid">
               <div class="loading-message">ë‹µì•ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
           </div>
           
           <div class="my-quiz-submissions-grid" id="myQuizSubmissionsGrid" style="display: none;">
               <div class="loading-message">í€´ì¦ˆ ë‹µì•ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
           </div>
       </div>
   </div>

   <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
   <script src="/js/student-activity.js"></script>

<script>
    let sharedMaterials = [];
    let mySubmissions = [];
    let myQuizSubmissions = [];
    let currentSubmissionTab = 'problems';

    function getAuthToken() {
        return localStorage.getItem('token') || 
               localStorage.getItem('jwtToken') || 
               localStorage.getItem('authToken') || 
               sessionStorage.getItem('token') ||
               sessionStorage.getItem('jwtToken') ||
               sessionStorage.getItem('authToken');
    }

    function getCurrentUserId() {
        const storedUserId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
        if (storedUserId) {
            return storedUserId;
        }
        
        const token = getAuthToken();
        if (!token) return null;
        
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const userId = payload.userId || payload.id || payload.sub;
            
            if (userId) {
                localStorage.setItem('userId', userId);
            }
            
            return userId;
        } catch (e) {
            console.error('í† í° íŒŒì‹± ì˜¤ë¥˜:', e);
            return null;
        }
    }

    function switchMySubmissionTab(tab) {
        currentSubmissionTab = tab;
        
        const problemsGrid = document.getElementById('mySubmissionsGrid');
        const quizGrid = document.getElementById('myQuizSubmissionsGrid');
        const tabs = document.querySelectorAll('.submission-tab');
        
        tabs.forEach(t => t.classList.remove('active'));
        
        if (tab === 'problems') {
            problemsGrid.style.display = 'grid';
            quizGrid.style.display = 'none';
            tabs[0].classList.add('active');
            loadMySubmissions();
        } else {
            problemsGrid.style.display = 'none';
            quizGrid.style.display = 'grid';
            tabs[1].classList.add('active');
            loadMyQuizSubmissions();
        }
    }

    async function loadMySubmissions() {
        try {
            const token = getAuthToken();
            const userId = getCurrentUserId();
            
            console.log('ğŸ“ ë‹µì•ˆ ì¡°íšŒ ë””ë²„ê¹…:');
            console.log('í† í°:', token ? 'ìˆìŒ (' + token.substring(0, 20) + '...)' : 'ì—†ìŒ');
            console.log('ì‚¬ìš©ìID:', userId);
            
            if (!token || !userId) {
                console.log('â›” í† í° ë˜ëŠ” ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤');
                renderMySubmissions();
                return;
            }

            const url = `/api/student/submissions?userId=${userId}`;
            console.log('ğŸ“¤ ìš”ì²­ URL:', url);

            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('ğŸ“¥ ì‘ë‹µ ìƒíƒœ:', response.status);

            if (response.ok) {
                const data = await response.json();
                console.log('ğŸ“¥ ë°›ì€ ë°ì´í„°:', data);
                mySubmissions = data.submissions || [];
                console.log('ğŸ“Š ë‹µì•ˆ ìˆ˜:', mySubmissions.length);
                renderMySubmissions();
            } else {
                const errorText = await response.text();
                console.error('â›” ë‹µì•ˆ ì¡°íšŒ ì‹¤íŒ¨:', response.status, errorText);
                renderMySubmissions();
            }
        } catch (error) {
            console.error('â›” ë‹µì•ˆ ì¡°íšŒ ì˜¤ë¥˜:', error);
            renderMySubmissions();
        }
    }

    async function loadMyQuizSubmissions() {
        try {
            const token = getAuthToken();
            const userId = getCurrentUserId();
            
            if (!token || !userId) {
                console.log('í† í° ë˜ëŠ” ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤');
                renderMyQuizSubmissions();
                return;
            }

            const response = await fetch(`/api/student/quiz-submissions?userId=${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                myQuizSubmissions = data.submissions || [];
                renderMyQuizSubmissions();
            } else {
                console.error('í€´ì¦ˆ ë‹µì•ˆ ì¡°íšŒ ì‹¤íŒ¨:', response.status);
                renderMyQuizSubmissions();
            }
        } catch (error) {
            console.error('í€´ì¦ˆ ë‹µì•ˆ ì¡°íšŒ ì˜¤ë¥˜:', error);
            renderMyQuizSubmissions();
        }
    }

    function renderMySubmissions() {
        const grid = document.getElementById('mySubmissionsGrid');
        
        if (mySubmissions.length === 0) {
            grid.innerHTML = `
                <div class="no-submissions">
                    <div class="no-submissions-icon">ğŸ“</div>
                    <p><strong>ì œì¶œí•œ ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤</strong></p>
                    <p>ë¬¸ì œë¥¼ í’€ê³  ë‹µì•ˆì„ ì œì¶œí•´ë³´ì„¸ìš”!</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = mySubmissions.map(submission => {
            const submitDate = new Date(submission.submittedAt);
            const scoreClass = getScoreClass(submission.score);
            const scoreText = submission.score !== null ? `${submission.score}ì ` : 'ë¯¸ì±„ì ';
            
            return `
                <div class="submission-card">
                    <div class="submission-header">
                        <div class="submission-title">${submission.problemTitle || 'ì œëª© ì—†ìŒ'}</div>
                        <div class="submission-meta">
                            <div class="submission-date">${formatSubmissionDate(submitDate)}</div>
                            <div class="score-badge ${scoreClass}">${scoreText}</div>
                        </div>
                    </div>
                    
                    <div class="submission-answer">
                        <div class="submission-answer-label">ë‚´ ë‹µì•ˆ:</div>
                        <div class="submission-answer-content">${submission.answer || 'ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                    </div>
                    
                    ${submission.feedback ? `
                        <div class="submission-feedback">
                            <div class="submission-feedback-label">ê°•ì‚¬ë‹˜ í”¼ë“œë°±:</div>
                            <div class="submission-feedback-content">${submission.feedback}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    function renderMyQuizSubmissions() {
        const grid = document.getElementById('myQuizSubmissionsGrid');
        
        if (myQuizSubmissions.length === 0) {
            grid.innerHTML = `
                <div class="no-submissions">
                    <div class="no-submissions-icon">âš¡</div>
                    <p><strong>ì°¸ì—¬í•œ í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤</strong></p>
                    <p>ê°•ì‚¬ë‹˜ì˜ ê¹œì§ í€´ì¦ˆë¥¼ ê¸°ë‹¤ë ¤ë³´ì„¸ìš”!</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = myQuizSubmissions.map(submission => {
            const submitDate = new Date(submission.submittedAt);
            const isCorrect = submission.isCorrect;
            
            return `
                <div class="submission-card">
                    <div class="submission-header">
                        <div class="submission-title">${submission.quizTitle || 'í€´ì¦ˆ'}</div>
                        <div class="submission-meta">
                            <div class="submission-date">${formatSubmissionDate(submitDate)}</div>
                        </div>
                    </div>
                    
                    <div class="quiz-result">
                        <div class="quiz-result-icon">${isCorrect ? 'ğŸ‰' : 'ğŸ˜…'}</div>
                        <div class="quiz-result-text">
                            <div class="quiz-result-status ${isCorrect ? 'quiz-correct' : 'quiz-incorrect'}">
                                ${isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'í‹€ë ¸ìŠµë‹ˆë‹¤'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="quiz-answer-details">
                        <div class="quiz-answer-row">
                            <span class="quiz-answer-label">ë‚´ ë‹µì•ˆ:</span>
                            <span class="quiz-answer-value">${submission.userAnswer + 1}ë²ˆ</span>
                        </div>
                        <div class="quiz-answer-row">
                            <span class="quiz-answer-label">ì •ë‹µ:</span>
                            <span class="quiz-answer-value">${submission.correctAnswer + 1}ë²ˆ</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getScoreClass(score) {
        if (score === null) return 'score-ungraded';
        if (score >= 90) return 'score-excellent';
        if (score >= 70) return 'score-good';
        if (score >= 50) return 'score-fair';
        return 'score-poor';
    }

    function formatSubmissionDate(date) {
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) return 'ì˜¤ëŠ˜ ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        if (diffDays === 2) return 'ì–´ì œ ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        if (diffDays <= 7) return `${diffDays - 1}ì¼ ì „`;
        
        return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }

    function handleNewMaterial(notification) {
        console.log('ìƒˆ ìë£Œ ì²˜ë¦¬:', notification);
        
        const materialNotification = document.getElementById('materialNotification');
        if (materialNotification) {
            materialNotification.style.display = 'block';
            materialNotification.textContent = notification.message || 'ìƒˆ ìë£Œê°€ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!';
            
            materialNotification.style.animation = 'pulse 2s infinite';
            
            setTimeout(() => {
                materialNotification.style.display = 'none';
                materialNotification.style.animation = '';
            }, 8000);
        }
        
        if (Notification.permission === 'granted') {
            new Notification('ìƒˆ í•™ìŠµìë£Œ ê³µìœ ', {
                body: notification.message,
                icon: '/favicon.ico'
            });
        }
        
        setTimeout(() => {
            console.log('ìë£Œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
            loadSharedMaterials();
        }, 1000);
    }

    async function loadSharedMaterials() {
        try {
            const token = getAuthToken();
            console.log('í† í° ìƒíƒœ:', token ? 'ìˆìŒ' : 'ì—†ìŒ');
            
            if (!token) {
                console.log('í† í°ì´ ì—†ì–´ì„œ ê³µìœ  ìë£Œë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                renderSharedMaterials();
                return;
            }
            
            const response = await fetch('/api/teacher/materials/shared', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('ë°›ì€ ë°ì´í„°:', data);
                
                sharedMaterials = data.materials || data;
                console.log('ë°›ì€ ìë£Œ ìˆ˜:', sharedMaterials.length);
                renderSharedMaterials();
            } else {
                const errorText = await response.text();
                console.error('ê³µìœ  ìë£Œ ë¡œë”© ì‹¤íŒ¨:', response.status, errorText);
                renderSharedMaterials();
            }
        } catch (error) {
            console.error('ê³µìœ  ìë£Œ ë¡œë”© ì‹¤íŒ¨:', error);
            renderSharedMaterials();
        }
    }
    
    function renderSharedMaterials() {
        const grid = document.getElementById('sharedMaterialsGrid');
        const noMaterials = document.getElementById('noMaterials');
        
        if (sharedMaterials.length === 0) {
            grid.style.display = 'none';
            noMaterials.style.display = 'block';
            return;
        }
        
        grid.style.display = 'grid';
        noMaterials.style.display = 'none';
        grid.innerHTML = '';
        
        sharedMaterials.forEach(material => {
            const card = createMaterialCard(material);
            grid.appendChild(card);
        });
    }

    function createMaterialCard(material) {
        const card = document.createElement('div');
        card.className = 'material-card';
        
        const isNew = isNewMaterial(material.createdAt);
        if (isNew) {
            card.classList.add('new');
        }
        
        const fileIcon = getFileIcon(material.materialType || material.fileType || material.type);
        const fileSize = material.fileSize ? formatFileSize(material.fileSize) : '';
        
        card.innerHTML = `
            <div class="material-header">
                <div class="material-title">${material.title}</div>
                <div class="material-category">${material.category || 'ì¼ë°˜'}</div>
            </div>
            <div class="material-description">${material.content || material.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
            <div class="material-meta">
                <div class="material-type">
                    <span>${fileIcon}</span>
                    <span>${(material.materialType || material.fileType || material.type || 'file').toUpperCase()}</span>
                    ${fileSize ? `<span>(${fileSize})</span>` : ''}
                </div>
                <div class="material-date">${formatDate(material.createdAt)}</div>
            </div>
            <div class="material-actions">
                ${(material.materialType === 'youtube' || material.type === 'youtube') ? 
                    `<button class="action-btn" onclick="openYoutube('${material.youtubeUrl || material.url}')">â–¶ï¸ ì‹œì²­í•˜ê¸°</button>` :
                    `<button class="action-btn" onclick="downloadMaterial(${material.id})">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>`
                }
                <button class="action-btn secondary" onclick="viewMaterial(${material.id})">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</button>
            </div>
        `;
        
        return card;
    }

    function getFileIcon(fileType) {
        const icons = {
            'pdf': 'ğŸ“„',
            'application/pdf': 'ğŸ“„',
            'ppt': 'ğŸ“Š',
            'pptx': 'ğŸ“Š',
            'application/vnd.ms-powerpoint': 'ğŸ“Š',
            'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'ğŸ“Š',
            'doc': 'ğŸ“',
            'docx': 'ğŸ“',
            'application/msword': 'ğŸ“',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'ğŸ“',
            'jpg': 'ğŸ–¼ï¸',
            'jpeg': 'ğŸ–¼ï¸',
            'png': 'ğŸ–¼ï¸',
            'gif': 'ğŸ–¼ï¸',
            'image/jpeg': 'ğŸ–¼ï¸',
            'image/jpg': 'ğŸ–¼ï¸',
            'image/png': 'ğŸ–¼ï¸',
            'image/gif': 'ğŸ–¼ï¸',
            'mp4': 'ğŸ¥',
            'avi': 'ğŸ¥',
            'mov': 'ğŸ¥',
            'video/mp4': 'ğŸ¥',
            'video/avi': 'ğŸ¥',
            'video/quicktime': 'ğŸ¥',
            'youtube': 'ğŸ“º',
            'zip': 'ğŸ“¦',
            'rar': 'ğŸ“¦',
            'application/zip': 'ğŸ“¦',
            'application/x-rar-compressed': 'ğŸ“¦',
            'text': 'ğŸ“',
            'text/plain': 'ğŸ“'
        };
        return icons[fileType?.toLowerCase()] || 'ğŸ“„';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) return 'ì˜¤ëŠ˜';
        if (diffDays === 2) return 'ì–´ì œ';
        if (diffDays <= 7) return `${diffDays - 1}ì¼ ì „`;
        
        return date.toLocaleDateString('ko-KR');
    }

    function isNewMaterial(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffHours = diffTime / (1000 * 60 * 60);
        return diffHours <= 24;
    }

    function openYoutube(url) {
        window.open(url, '_blank');
    }

    async function downloadMaterial(materialId) {
        try {
            const token = getAuthToken();
            const response = await fetch(`/api/teacher/materials/${materialId}/download`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `material_${materialId}`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                alert('íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function viewMaterial(materialId) {
        console.log('ë¯¸ë¦¬ë³´ê¸° í´ë¦­:', materialId);
        const newWindow = window.open(`/material-preview/${materialId}`, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
            console.log('íŒì—… ì°¨ë‹¨ë¨, í˜„ì¬ íƒ­ì—ì„œ ì—´ê¸°');
            window.open(`/material-preview/${materialId}`, '_self');
        }
    }

    function initializePage() {
        console.log('í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
        
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                console.log('ì•Œë¦¼ ê¶Œí•œ:', permission);
            });
        }
        
        loadSharedMaterials();
        loadMySubmissions();
        
        console.log('í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
    }

    function addActivity(message) {
        console.log('í™œë™ ì¶”ê°€:', message);
    }

    function loadLearningStats() {
        console.log('í•™ìŠµ í†µê³„ ë¡œë“œ');
    }

    window.loadSharedMaterials = loadSharedMaterials;

    document.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>