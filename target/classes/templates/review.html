<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³µìŠµ ë…¸íŠ¸ - Java Battle Arena</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
        }
        .header {
            background: #1a1a1a;
            padding: 1rem 2rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: #3498db;
        }
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        .btn {
            background: #3498db;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .btn.secondary { background: #6c757d; }
        .btn.danger { background: #dc3545; }
        .btn:hover { opacity: 0.9; }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem;
            background: #2d2d2d;
            border: 1px solid #333;
            border-radius: 6px;
            color: white;
            font-family: inherit;
        }
        
        .category-filter select {
            padding: 0.75rem;
            background: #2d2d2d;
            border: 1px solid #333;
            border-radius: 6px;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #95a5a6;
        }
        .empty-icon { font-size: 4rem; margin-bottom: 1rem; }
        
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .note-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }
        .note-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }
        .note-card.favorite {
            border-color: #f39c12;
        }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        .note-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #3498db;
            flex: 1;
            cursor: pointer;
        }
        .note-actions {
            display: flex;
            gap: 0.5rem;
        }
        .note-action-btn {
            background: none;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .note-action-btn:hover { color: #3498db; background: #2d2d2d; }
        .note-action-btn.favorite.active { color: #f39c12; }
        
        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #95a5a6;
        }
        
        .note-category {
            background: #2d2d2d;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .note-content {
            color: #e0e0e0;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .note-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .tag {
            background: #2d2d2d;
            color: #95a5a6;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .add-note-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        .modal-content {
            background: #1a1a1a;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
            border: 1px solid #333;
        }
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #3498db;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #e0e0e0;
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            background: #2d2d2d;
            border: 1px solid #333;
            border-radius: 6px;
            color: white;
            font-family: inherit;
        }
        .form-textarea {
            min-height: 200px;
            resize: vertical;
        }
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #95a5a6;
        }
        .error, .success {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        .error { background: #dc3545; color: white; }
        .success { background: #28a745; color: white; }
        .close-btn {
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            color: #95a5a6;
            cursor: pointer;
        }
        .close-btn:hover { color: #fff; }
        .detail-modal .modal-content { max-width: 800px; }
        .detail-content { line-height: 1.6; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ğŸ“ ë³µìŠµ ë…¸íŠ¸</div>
        <div class="header-actions">
            <a href="/study" class="btn secondary">â† í•™ìŠµí•˜ê¸°</a>
            <a href="/" class="btn secondary">í™ˆìœ¼ë¡œ</a>
        </div>
    </div>

    <div class="container">
        <div class="filters">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="ì œëª©, ë‚´ìš©, íƒœê·¸ë¡œ ê²€ìƒ‰...">
            </div>
            <div class="category-filter">
                <select id="categoryFilter">
                    <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                </select>
            </div>
            <button class="btn" onclick="showFavorites()">ì¦ê²¨ì°¾ê¸°ë§Œ</button>
            <button class="btn secondary" onclick="showAll()">ì „ì²´ ë³´ê¸°</button>
        </div>
        
        <div id="loadingState" class="loading">ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div id="errorState" class="error" style="display: none;">ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">ğŸ“</div>
            <h3>ì•„ì§ ì‘ì„±ëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì•„ë˜ + ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
        </div>
        <div class="notes-grid" id="notesGrid" style="display: none;"></div>
    </div>

    <button class="add-note-btn" onclick="openNoteModal()">+</button>

    <div id="noteModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeNoteModal()">&times;</span>
            <h2 class="modal-title" id="modalTitle">ìƒˆ ë…¸íŠ¸ ì‘ì„±</h2>
            <form id="noteForm">
                <input type="hidden" id="noteId" value="">
                <div class="form-group">
                    <label class="form-label">ì œëª©</label>
                    <input type="text" id="noteTitle" class="form-input" placeholder="ë…¸íŠ¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                    <input type="text" id="noteCategory" class="form-input" placeholder="ì¹´í…Œê³ ë¦¬ (ì˜ˆ: Java, ì•Œê³ ë¦¬ì¦˜)">
                </div>
                <div class="form-group">
                    <label class="form-label">ë‚´ìš©</label>
                    <textarea id="noteContent" class="form-textarea" placeholder="í•™ìŠµ ë‚´ìš©ì„ ì •ë¦¬í•´ë³´ì„¸ìš”..." required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                    <input type="text" id="noteTags" class="form-input" placeholder="ë³€ìˆ˜, ì¡°ê±´ë¬¸, ë°˜ë³µë¬¸">
                </div>
                <div class="form-group">
                    <label class="form-label">ë‚œì´ë„</label>
                    <select id="noteDifficulty" class="form-select">
                        <option value="">ì„ íƒí•˜ì§€ ì•ŠìŒ</option>
                        <option value="1">ì‰¬ì›€</option>
                        <option value="2">ë³´í†µ</option>
                        <option value="3">ì–´ë ¤ì›€</option>
                        <option value="4">ë§¤ìš° ì–´ë ¤ì›€</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn secondary" onclick="closeNoteModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <div id="noteDetailModal" class="modal detail-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDetailModal()">&times;</span>
            <div id="noteDetailContent"></div>
        </div>
    </div>

    <script>
        let currentUserId = 1;
        let allNotes = [];
        let categories = [];
        let currentFilter = 'all';

        async function loadNotes() {
            try {
                const response = await fetch(`/api/study-notes?userId=${currentUserId}`);
                if (!response.ok) throw new Error('Failed to load notes');
                
                const data = await response.json();
                if (data.success) {
                    allNotes = data.notes;
                    categories = data.categories || [];
                    updateCategoryFilter();
                    renderNotes(allNotes);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('ë…¸íŠ¸ ë¡œë”© ì˜¤ë¥˜:', error);
                showError();
            }
        }

        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>';
            
            const uniqueCategories = [...new Set(allNotes.map(note => note.category).filter(cat => cat))];
            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        function renderNotes(notes) {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const emptyState = document.getElementById('emptyState');
            const notesGrid = document.getElementById('notesGrid');

            loadingState.style.display = 'none';
            errorState.style.display = 'none';

            if (notes.length === 0) {
                emptyState.style.display = 'block';
                notesGrid.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            notesGrid.style.display = 'grid';
            notesGrid.innerHTML = '';
            
            notes.forEach(note => {
                const card = document.createElement('div');
                card.className = `note-card ${note.isFavorite ? 'favorite' : ''}`;
                
                const tags = note.tags ? note.tags.split(',').map(tag => tag.trim()) : [];
                const tagsHtml = tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('');
                const formattedDate = new Date(note.createdAt).toLocaleDateString('ko-KR');
                const difficultyText = note.difficultyLevel ? ['', 'ì‰¬ì›€', 'ë³´í†µ', 'ì–´ë ¤ì›€', 'ë§¤ìš° ì–´ë ¤ì›€'][note.difficultyLevel] : '';
                
                card.innerHTML = `
                    <div class="note-header">
                        <div class="note-title" onclick="viewNote(${note.id})">${escapeHtml(note.title)}</div>
                        <div class="note-actions">
                            <button class="note-action-btn favorite ${note.isFavorite ? 'active' : ''}" 
                                    onclick="toggleFavorite(${note.id})" title="ì¦ê²¨ì°¾ê¸°">â­</button>
                            <button class="note-action-btn" onclick="editNote(${note.id})" title="ìˆ˜ì •">âœï¸</button>
                            <button class="note-action-btn" onclick="deleteNote(${note.id})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="note-meta">
                        <span>${formattedDate}</span>
                        ${note.category ? `<span class="note-category">${escapeHtml(note.category)}</span>` : ''}
                        ${difficultyText ? `<span class="note-category">${difficultyText}</span>` : ''}
                    </div>
                    <div class="note-content">${escapeHtml(note.content)}</div>
                    <div class="note-tags">${tagsHtml}</div>
                `;
                
                notesGrid.appendChild(card);
            });
        }

        function showError() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('notesGrid').style.display = 'none';
        }

        function openNoteModal(note = null) {
            const modal = document.getElementById('noteModal');
            const modalTitle = document.getElementById('modalTitle');
            const noteForm = document.getElementById('noteForm');
            
            if (note) {
                modalTitle.textContent = 'ë…¸íŠ¸ ìˆ˜ì •';
                document.getElementById('noteId').value = note.id;
                document.getElementById('noteTitle').value = note.title;
                document.getElementById('noteCategory').value = note.category || '';
                document.getElementById('noteContent').value = note.content;
                document.getElementById('noteTags').value = note.tags || '';
                document.getElementById('noteDifficulty').value = note.difficultyLevel || '';
            } else {
                modalTitle.textContent = 'ìƒˆ ë…¸íŠ¸ ì‘ì„±';
                noteForm.reset();
                document.getElementById('noteId').value = '';
            }
            
            modal.style.display = 'block';
        }

        function closeNoteModal() {
            document.getElementById('noteModal').style.display = 'none';
        }

        function viewNote(noteId) {
            const note = allNotes.find(n => n.id === noteId);
            if (!note) return;
            
            const modal = document.getElementById('noteDetailModal');
            const content = document.getElementById('noteDetailContent');
            
            const tags = note.tags ? note.tags.split(',').map(tag => tag.trim()) : [];
            const tagsHtml = tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('');
            const formattedDate = new Date(note.createdAt).toLocaleDateString('ko-KR');
            const difficultyText = note.difficultyLevel ? ['', 'ì‰¬ì›€', 'ë³´í†µ', 'ì–´ë ¤ì›€', 'ë§¤ìš° ì–´ë ¤ì›€'][note.difficultyLevel] : '';
            
            content.innerHTML = `
                <h2 class="note-title">${escapeHtml(note.title)}</h2>
                <div class="note-meta" style="margin: 1rem 0;">
                    <span>${formattedDate}</span>
                    ${note.category ? `<span class="note-category">${escapeHtml(note.category)}</span>` : ''}
                    ${difficultyText ? `<span class="note-category">${difficultyText}</span>` : ''}
                </div>
                <div class="note-tags" style="margin-bottom: 1rem;">${tagsHtml}</div>
                <div class="detail-content">${escapeHtml(note.content)}</div>
            `;
            
            modal.style.display = 'block';
        }

        function closeDetailModal() {
            document.getElementById('noteDetailModal').style.display = 'none';
        }

        async function editNote(noteId) {
            const note = allNotes.find(n => n.id === noteId);
            if (note) {
                openNoteModal(note);
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('ì •ë§ë¡œ ì´ ë…¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/study-notes/${noteId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadNotes();
                } else {
                    alert('ë…¸íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë…¸íŠ¸ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ë…¸íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function toggleFavorite(noteId) {
            try {
                const response = await fetch(`/api/study-notes/${noteId}/favorite`, { method: 'POST' });
                if (response.ok) {
                    loadNotes();
                } else {
                    alert('ì¦ê²¨ì°¾ê¸° ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì¦ê²¨ì°¾ê¸° í† ê¸€ ì˜¤ë¥˜:', error);
                alert('ì¦ê²¨ì°¾ê¸° ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function showFavorites() {
            try {
                const response = await fetch(`/api/study-notes/favorites?userId=${currentUserId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        renderNotes(data.notes);
                        currentFilter = 'favorites';
                    }
                }
            } catch (error) {
                console.error('ì¦ê²¨ì°¾ê¸° ì¡°íšŒ ì˜¤ë¥˜:', error);
            }
        }

        function showAll() {
            renderNotes(allNotes);
            currentFilter = 'all';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('searchInput').value = '';
        }

        async function searchNotes(keyword) {
            if (!keyword.trim()) {
                renderNotes(allNotes);
                return;
            }

            try {
                const response = await fetch(`/api/study-notes/search?userId=${currentUserId}&keyword=${encodeURIComponent(keyword)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        renderNotes(data.notes);
                    }
                }
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
        }

        async function filterByCategory(category) {
            if (!category) {
                renderNotes(allNotes);
                return;
            }

            try {
                const response = await fetch(`/api/study-notes/category/${encodeURIComponent(category)}?userId=${currentUserId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        renderNotes(data.notes);
                    }
                }
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ í•„í„°ë§ ì˜¤ë¥˜:', error);
            }
        }

        document.getElementById('noteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const noteId = document.getElementById('noteId').value;
            const title = document.getElementById('noteTitle').value.trim();
            const category = document.getElementById('noteCategory').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const tags = document.getElementById('noteTags').value.trim();
            const difficultyLevel = document.getElementById('noteDifficulty').value;
            
            if (!title || !content) {
                alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const noteData = {
                userId: currentUserId,
                title: title,
                category: category,
                content: content,
                tags: tags,
                difficultyLevel: difficultyLevel ? parseInt(difficultyLevel) : null
            };

            try {
                let response;
                if (noteId) {
                    response = await fetch(`/api/study-notes/${noteId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(noteData)
                    });
                } else {
                    response = await fetch('/api/study-notes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(noteData)
                    });
                }

                if (response.ok) {
                    closeNoteModal();
                    loadNotes();
                } else {
                    alert('ë…¸íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë…¸íŠ¸ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ë…¸íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            searchNotes(e.target.value);
        });

        document.getElementById('categoryFilter').addEventListener('change', function(e) {
            filterByCategory(e.target.value);
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.onclick = function(event) {
            const noteModal = document.getElementById('noteModal');
            const detailModal = document.getElementById('noteDetailModal');
            
            if (event.target === noteModal) closeNoteModal();
            if (event.target === detailModal) closeDetailModal();
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadNotes();
        });
    </script>
</body>
</html>