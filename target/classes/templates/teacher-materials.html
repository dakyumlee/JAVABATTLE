<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학습자료 관리</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #2c3e50;
        }
        .header {
            background: white;
            padding: 2rem;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 700;
        }
        .header p {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
        }
        .nav-tabs {
            background: white;
            padding: 0 2rem;
            border-bottom: 1px solid #e9ecef;
        }
        .nav-tab {
            display: inline-block;
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: #6c757d;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .nav-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        .nav-tab:hover {
            color: #3498db;
        }
        .content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #3498db;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: #3498db;
            line-height: 1;
        }
        .stat-label {
            color: #6c757d;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        .upload-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid #e9ecef;
            margin-bottom: 2rem;
        }
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            background: rgba(52, 152, 219, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        .upload-area:hover {
            border-color: #2980b9;
            background: rgba(52, 152, 219, 0.1);
        }
        .upload-area.dragging {
            border-color: #2980b9;
            background: rgba(52, 152, 219, 0.15);
            transform: scale(1.02);
        }
        .upload-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 1rem;
        }
        .upload-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .upload-hint {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .form-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid #e9ecef;
            margin-bottom: 2rem;
        }
        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Pretendard Variable', sans-serif;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Pretendard Variable', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #229954;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .material-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .material-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        .material-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .material-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 1rem;
        }
        .material-icon.pdf { background: rgba(244, 67, 54, 0.1); color: #f44336; }
        .material-icon.ppt { background: rgba(255, 152, 0, 0.1); color: #ff9800; }
        .material-icon.video { background: rgba(76, 175, 80, 0.1); color: #4caf50; }
        .material-icon.image { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
        .material-icon.youtube { background: rgba(244, 67, 54, 0.1); color: #f44336; }
        .material-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }
        .material-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .material-description {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }
        .material-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .tag {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .material-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }
        .category-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid #e9ecef;
            margin-bottom: 2rem;
        }
        .category-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .category-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .category-item:hover {
            background: rgba(52, 152, 219, 0.1);
            border-color: #3498db;
        }
        .category-item.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        .category-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.3rem;
        }
        .category-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            color: #6c757d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: all 0.3s ease;
        }
        .category-action-btn:hover {
            background: white;
            color: #e74c3c;
        }
        .version-history {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid #e9ecef;
        }
        .version-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #f8f9fa;
            transition: all 0.3s ease;
        }
        .version-item:last-child {
            border-bottom: none;
        }
        .version-item:hover {
            background: #f8f9fa;
        }
        .version-info {
            flex: 1;
        }
        .version-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }
        .version-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .version-badge {
            background: #27ae60;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .progress-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid #e9ecef;
        }
        .upload-progress {
            background: #f8f9fa;
            border-radius: 10px;
            height: 20px;
            margin: 1rem 0;
            overflow: hidden;
            display: none;
        }
        .upload-progress.active {
            display: block;
        }
        .progress-bar {
            height: 100%;
            background: #3498db;
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }
        .progress-text {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .modal-close:hover {
            background: #f8f9fa;
            color: #2c3e50;
        }
        .youtube-preview {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }
        .no-materials {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .materials-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>학습자료 관리</h1>
        <p>강의 자료를 업로드하고 학생들에게 배포하세요</p>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('upload')">자료 업로드</button>
        <button class="nav-tab" onclick="switchTab('manage')">자료 관리</button>
        <button class="nav-tab" onclick="switchTab('categories')">카테고리 관리</button>
        <button class="nav-tab" onclick="switchTab('history')">버전 관리</button>
    </div>

    <div class="content">
        <div id="upload" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMaterials">0</div>
                    <div class="stat-label">전체 자료 수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSize">0MB</div>
                    <div class="stat-label">전체 파일 크기</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recentUploads">0</div>
                    <div class="stat-label">최근 업로드 (7일)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeShares">0</div>
                    <div class="stat-label">활성 공유</div>
                </div>
            </div>

            <div class="upload-section">
                <div class="section-title">파일 업로드</div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">파일을 드래그하거나 클릭하여 업로드</div>
                    <div class="upload-hint">PDF, PPT, 이미지, 동영상 파일을 지원합니다 (최대 100MB)</div>
                    <input type="file" class="file-input" id="fileInput" multiple accept=".pdf,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.mp4,.avi,.mov">
                </div>
                
                <div class="upload-progress" id="uploadProgress">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">자료 정보</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">제목</label>
                        <input type="text" class="form-input" id="materialTitle" placeholder="자료 제목">
                    </div>
                    <div class="form-group">
                        <label class="form-label">카테고리</label>
                        <select class="form-select" id="materialCategory">
                            <option value="">카테고리 선택</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">설명</label>
                    <textarea class="form-textarea" id="materialDescription" placeholder="자료에 대한 설명을 입력하세요"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">태그 (쉼표로 구분)</label>
                    <input type="text" class="form-input" id="materialTags" placeholder="예: 변수, 조건문, 반복문">
                </div>
                <button class="btn btn-primary" onclick="uploadMaterial()">자료 업로드</button>
            </div>
        </div>

        <div id="manage" class="tab-content">
            <div class="form-section">
                <div class="section-title">자료 검색 및 필터</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">검색</label>
                        <input type="text" class="form-input" id="searchInput" placeholder="제목, 설명, 태그로 검색" oninput="filterMaterials()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">카테고리 필터</label>
                        <select class="form-select" id="categoryFilter" onchange="filterMaterials()">
                            <option value="">전체 카테고리</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="materials-grid" id="materialsGrid">
                <div class="no-materials">
                    <p>아직 업로드된 자료가 없습니다.</p>
                    <p>자료 업로드 탭에서 새로운 자료를 추가해보세요.</p>
                </div>
            </div>
        </div>

        <div id="categories" class="tab-content">
            <div class="category-section">
                <div class="section-title">카테고리 관리</div>
                <div class="category-list" id="categoryList">
                </div>
                <button class="btn btn-primary" onclick="openCategoryModal()">새 카테고리 추가</button>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="version-history">
                <div class="section-title">버전 관리</div>
                <div id="versionList">
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="categoryModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">카테고리 추가</h3>
                <button class="modal-close" onclick="closeCategoryModal()">×</button>
            </div>
            
            <form id="categoryForm">
                <div class="form-group">
                    <label class="form-label">카테고리 이름</label>
                    <input type="text" class="form-input" id="categoryName" placeholder="카테고리 이름" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">설명</label>
                    <textarea class="form-textarea" id="categoryDescription" placeholder="카테고리 설명"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">색상</label>
                    <input type="color" class="form-input" id="categoryColor" value="#3498db">
                </div>
            </form>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">저장</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="versionModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">새 버전 생성</h3>
                <button class="modal-close" onclick="closeVersionModal()">×</button>
            </div>
            
            <form id="versionForm">
                <div class="form-group">
                    <label class="form-label">새 제목</label>
                    <input type="text" class="form-input" id="versionTitle" placeholder="새 버전의 제목">
                </div>
                
                <div class="form-group">
                    <label class="form-label">변경 사항</label>
                    <textarea class="form-textarea" id="versionDescription" placeholder="이번 버전에서 변경된 내용을 설명하세요"></textarea>
                </div>
            </form>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeVersionModal()">취소</button>
                <button type="button" class="btn btn-primary" onclick="createVersion()">새 버전 생성</button>
            </div>
        </div>
    </div>

    <script>
        let materials = [];
        let categories = [];
        let versions = [];
        let selectedFiles = [];
        let currentVersionMaterialId = null;

        function getAuthToken() {
            return localStorage.getItem('authToken') || 
                   localStorage.getItem('token') || 
                   sessionStorage.getItem('authToken') ||
                   sessionStorage.getItem('token');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'manage') {
                loadMaterials();
            } else if (tabName === 'categories') {
                loadCategories();
            } else if (tabName === 'history') {
                loadVersionHistory();
            }
        }

        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragging');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragging');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragging');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            const allowedTypes = [
                'application/pdf',
                'application/vnd.ms-powerpoint',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'image/jpeg', 'image/jpg', 'image/png', 'image/gif',
                'video/mp4', 'video/avi', 'video/mov'
            ];

            selectedFiles = [];
            for (let file of files) {
                if (!allowedTypes.includes(file.type)) {
                    alert(`지원하지 않는 파일 형식입니다: ${file.name}`);
                    continue;
                }

                if (file.size > 100 * 1024 * 1024) {
                    alert(`파일 크기가 너무 큽니다: ${file.name} (최대 100MB)`);
                    continue;
                }

                selectedFiles.push(file);
            }

            if (selectedFiles.length > 0) {
                document.getElementById('uploadArea').querySelector('.upload-text').textContent = 
                    `${selectedFiles.length}개 파일 선택됨`;
            }
        }

        function simulateUpload(callback) {
            const progressSection = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            progressSection.classList.add('active');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(() => {
                        progressSection.classList.remove('active');
                        if (callback) callback();
                    }, 500);
                }
                
                progressBar.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
            }, 200);
        }

        async function uploadMaterial() {
            const title = document.getElementById('materialTitle').value;
            const category = document.getElementById('materialCategory').value;
            const description = document.getElementById('materialDescription').value;
            const tags = document.getElementById('materialTags').value;

            if (!title) {
                alert('제목을 입력해주세요.');
                return;
            }

            try {
                const token = getAuthToken();
                let response;
                
                if (selectedFiles.length > 0) {
                    const formData = new FormData();
                    formData.append('file', selectedFiles[0]);
                    formData.append('title', title);
                    formData.append('category', category || '');
                    formData.append('description', description || '');
                    formData.append('tags', tags || '');

                    simulateUpload(async () => {
                        response = await fetch('/api/teacher/materials/upload', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });

                        if (response.ok) {
                            alert('자료가 업로드되었습니다!');
                            resetUploadForm();
                            loadMaterials();
                            updateStats();
                        } else {
                            const errorData = await response.text();
                            console.error('업로드 실패:', errorData);
                            throw new Error('업로드 실패');
                        }
                    });
                } else {
                    response = await fetch('/api/teacher/materials/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            title: title,
                            category: category || '',
                            description: description || '',
                            tags: tags || ''
                        })
                    });

                    if (response.ok) {
                        alert('자료가 업로드되었습니다!');
                        resetUploadForm();
                        loadMaterials();
                        updateStats();
                    } else {
                        const errorData = await response.text();
                        console.error('업로드 실패:', errorData);
                        throw new Error('업로드 실패');
                    }
                }
            } catch (error) {
                console.error('업로드 오류:', error);
                alert('업로드 중 오류가 발생했습니다.');
            }
        }

        function resetUploadForm() {
            document.getElementById('materialTitle').value = '';
            document.getElementById('materialCategory').value = '';
            document.getElementById('materialDescription').value = '';
            document.getElementById('materialTags').value = '';
            document.getElementById('fileInput').value = '';
            selectedFiles = [];
            document.getElementById('uploadArea').querySelector('.upload-text').textContent = 
                '파일을 드래그하거나 클릭하여 업로드';
        }

        async function loadMaterials() {
            try {
                const token = getAuthToken();
                const response = await fetch('/api/teacher/materials', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    materials = await response.json();
                    renderMaterials();
                } else {
                    console.error('자료 로딩 실패');
                }
            } catch (error) {
                console.error('자료 로딩 오류:', error);
            }
        }

        async function loadCategories() {
            try {
                const token = getAuthToken();
                const response = await fetch('/api/teacher/categories', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    categories = data.categories || [];
                    renderCategories();
                    updateCategorySelects();
                } else {
                    console.error('카테고리 로딩 실패');
                }
            } catch (error) {
                console.error('카테고리 로딩 오류:', error);
            }
        }

        async function loadVersionHistory() {
            const versionList = document.getElementById('versionList');
            
            if (materials.length === 0) {
                versionList.innerHTML = `
                    <div class="no-materials">
                        <p>버전 관리할 자료가 없습니다.</p>
                        <p>자료를 업로드한 후 버전 관리를 시작하세요.</p>
                    </div>
                `;
                return;
            }

            versionList.innerHTML = '';
            
            for (const material of materials) {
                try {
                    const token = getAuthToken();
                    const response = await fetch(`/api/teacher/materials/${material.id}/versions`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const versions = data.versions || [];
                        
                        if (versions.length > 1) {
                            const versionGroup = document.createElement('div');
                            versionGroup.innerHTML = `
                                <h4 style="margin: 2rem 0 1rem 0; color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 0.5rem;">
                                    ${material.title}
                                    <button class="btn btn-small btn-primary" style="float: right;" onclick="openVersionModal(${material.id})">새 버전 생성</button>
                                </h4>
                            `;
                            
                            versions.forEach(version => {
                                const versionItem = document.createElement('div');
                                versionItem.className = 'version-item';
                                versionItem.innerHTML = `
                                    <div class="version-info">
                                        <div class="version-title">${version.title} ${version.version}</div>
                                        <div class="version-meta">${formatDate(version.createdAt)}</div>
                                    </div>
                                    ${version.isLatestVersion ? '<div class="version-badge">최신</div>' : ''}
                                `;
                                versionGroup.appendChild(versionItem);
                            });
                            
                            versionList.appendChild(versionGroup);
                        }
                    }
                } catch (error) {
                    console.error('버전 로딩 오류:', error);
                }
            }
            
            if (versionList.innerHTML === '') {
                versionList.innerHTML = `
                    <div class="no-materials">
                        <p>버전 관리 이력이 없습니다.</p>
                        <p>자료를 수정하여 새 버전을 생성해보세요.</p>
                    </div>
                `;
            }
        }

        function renderMaterials() {
            const grid = document.getElementById('materialsGrid');
            grid.innerHTML = '';

            if (materials.length === 0) {
                grid.innerHTML = `
                    <div class="no-materials">
                        <p>아직 업로드된 자료가 없습니다.</p>
                        <p>자료 업로드 탭에서 새로운 자료를 추가해보세요.</p>
                    </div>
                `;
                return;
            }

            materials.forEach(material => {
                const card = createMaterialCard(material);
                grid.appendChild(card);
            });
        }

        function renderCategories() {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';

            if (categories.length === 0) {
                categoryList.innerHTML = `
                    <div class="no-materials">
                        <p>등록된 카테고리가 없습니다.</p>
                        <p>새 카테고리를 추가해보세요.</p>
                    </div>
                `;
                return;
            }

            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.style.borderColor = category.color;
                categoryItem.innerHTML = `
                    <div class="category-actions">
                        <button class="category-action-btn" onclick="deleteCategory(${category.id})" title="삭제">×</button>
                    </div>
                    <h4 style="color: ${category.color};">${category.name}</h4>
                    <p>${category.description || ''}</p>
                `;
                categoryList.appendChild(categoryItem);
            });
        }

        function createMaterialCard(material) {
            const card = document.createElement('div');
            card.className = 'material-card';
            
            const iconClass = getIconClass(material.materialType || material.fileType || material.type);
            const tags = (material.tags || '').split(',').filter(tag => tag.trim()).map(tag => `<span class="tag">${tag.trim()}</span>`).join('');
            
            card.innerHTML = `
                <div class="material-header">
                    <div class="material-icon ${iconClass}">${getIcon(material.materialType || material.fileType || material.type)}</div>
                    <div>
                        <div class="material-title">${material.title}</div>
                        <div class="material-meta">${formatDate(material.createdAt)} • ${formatSize(material.fileSize || material.size || 0)}</div>
                    </div>
                </div>
                <div class="material-description">${material.description || '설명이 없습니다.'}</div>
                <div class="material-tags">${tags}</div>
                <div class="material-actions">
                    <button class="btn btn-small btn-primary" onclick="shareMaterial(${material.id})">
                        ${material.shared ? '공유 중지' : '학생에게 공유'}
                    </button>
                    <button class="btn btn-small btn-secondary" onclick="openVersionModal(${material.id})">새 버전</button>
                    <button class="btn btn-small btn-danger" onclick="deleteMaterial(${material.id})">삭제</button>
                </div>
            `;
            
            return card;
        }

        function getIconClass(type) {
            const types = {
                'application/pdf': 'pdf',
                'application/vnd.ms-powerpoint': 'ppt',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'ppt',
                'video/mp4': 'video',
                'video/avi': 'video',
                'video/mov': 'video',
                'image/jpeg': 'image',
                'image/jpg': 'image',
                'image/png': 'image',
                'image/gif': 'image',
                'youtube': 'youtube',
                'text': 'pdf'
            };
            return types[type] || 'pdf';
        }

        function getIcon(type) {
            const icons = {
                'application/pdf': '📄',
                'application/vnd.ms-powerpoint': '📊',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation': '📊',
                'video/mp4': '🎥',
                'video/avi': '🎥',
                'video/mov': '🎥',
                'image/jpeg': '🖼️',
                'image/jpg': '🖼️',
                'image/png': '🖼️',
                'image/gif': '🖼️',
                'youtube': '📺',
                'text': '📄'
            };
            return icons[type] || '📄';
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('ko-KR');
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 KB';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        async function shareMaterial(id) {
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/teacher/materials/${id}/share`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const material = materials.find(m => m.id === id);
                    if (material) {
                        material.shared = result.shared;
                        alert(result.message);
                        renderMaterials();
                        updateStats();
                    }
                } else {
                    throw new Error('공유 실패');
                }
            } catch (error) {
                console.error('공유 오류:', error);
                alert('공유 중 오류가 발생했습니다.');
            }
        }

        async function deleteMaterial(id) {
            if (!confirm('정말 삭제하시겠습니까?')) return;

            try {
                const token = getAuthToken();
                const response = await fetch(`/api/teacher/materials/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    materials = materials.filter(m => m.id !== id);
                    renderMaterials();
                    updateStats();
                    alert('자료가 삭제되었습니다.');
                } else {
                    throw new Error('삭제 실패');
                }
            } catch (error) {
                console.error('삭제 오류:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        async function deleteCategory(id) {
            if (!confirm('정말 삭제하시겠습니까?')) return;

            try {
                const token = getAuthToken();
                const response = await fetch(`/api/teacher/categories/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('카테고리가 삭제되었습니다.');
                    loadCategories();
                } else {
                    throw new Error('삭제 실패');
                }
            } catch (error) {
                console.error('카테고리 삭제 오류:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        function filterMaterials() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            
            const filtered = materials.filter(material => {
                const matchesSearch = material.title.toLowerCase().includes(search) ||
                                    (material.description || '').toLowerCase().includes(search) ||
                                    (material.tags || '').toLowerCase().includes(search);
                                    
                const matchesCategory = !category || material.category === category;
                
                return matchesSearch && matchesCategory;
            });
            
            const grid = document.getElementById('materialsGrid');
            grid.innerHTML = '';
            
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="no-materials">
                        <p>검색 결과가 없습니다.</p>
                        <p>다른 검색어나 필터를 시도해보세요.</p>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(material => {
                const card = createMaterialCard(material);
                grid.appendChild(card);
            });
        }

        function updateStats() {
            document.getElementById('totalMaterials').textContent = materials.length;
            
            const totalSize = materials.reduce((sum, m) => sum + (m.fileSize || m.size || 0), 0);
            document.getElementById('totalSize').textContent = formatSize(totalSize);
            
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const recentUploads = materials.filter(m => new Date(m.createdAt) > weekAgo).length;
            document.getElementById('recentUploads').textContent = recentUploads;
            
            const activeShares = materials.filter(m => m.shared).length;
            document.getElementById('activeShares').textContent = activeShares;
        }

        function updateCategorySelects() {
            const selects = [document.getElementById('materialCategory'), document.getElementById('categoryFilter')];
            
            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                
                if (select.id === 'categoryFilter') {
                    select.innerHTML = '<option value="">전체 카테고리</option>';
                } else {
                    select.innerHTML = '<option value="">카테고리 선택</option>';
                }
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('active');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('categoryForm').reset();
        }

        function openVersionModal(materialId) {
            currentVersionMaterialId = materialId;
            document.getElementById('versionModal').classList.add('active');
        }

        function closeVersionModal() {
            document.getElementById('versionModal').classList.remove('active');
            document.getElementById('versionForm').reset();
            currentVersionMaterialId = null;
        }

        async function saveCategory() {
            const name = document.getElementById('categoryName').value;
            const description = document.getElementById('categoryDescription').value;
            const color = document.getElementById('categoryColor').value;

            if (!name) {
                alert('카테고리 이름을 입력해주세요.');
                return;
            }

            try {
                const token = getAuthToken();
                const response = await fetch('/api/teacher/categories', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        color: color
                    })
                });

                if (response.ok) {
                    alert('카테고리가 추가되었습니다!');
                    closeCategoryModal();
                    loadCategories();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || '카테고리 추가에 실패했습니다.');
                }
            } catch (error) {
                console.error('카테고리 저장 오류:', error);
                alert('카테고리 저장 중 오류가 발생했습니다.');
            }
        }

        async function createVersion() {
            const title = document.getElementById('versionTitle').value;
            const description = document.getElementById('versionDescription').value;

            if (!currentVersionMaterialId) {
                alert('버전을 생성할 자료를 선택해주세요.');
                return;
            }

            try {
                const token = getAuthToken();
                const response = await fetch(`/api/teacher/materials/${currentVersionMaterialId}/create-version`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        description: description
                    })
                });

                if (response.ok) {
                    alert('새 버전이 생성되었습니다!');
                    closeVersionModal();
                    loadVersionHistory();
                    loadMaterials();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || '버전 생성에 실패했습니다.');
                }
            } catch (error) {
                console.error('버전 생성 오류:', error);
                alert('버전 생성 중 오류가 발생했습니다.');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            loadMaterials();
            loadCategories();
            updateStats();
            
            document.getElementById('categoryModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCategoryModal();
                }
            });

            document.getElementById('versionModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeVersionModal();
                }
            });
        });
    </script>
</body>
</html>