<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>오늘의 학습 - Java Battle Arena</title>
   <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" rel="stylesheet">
   <style>
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }

       body {
           font-family: 'Pretendard', sans-serif;
           background: #0a0a0a;
           color: #ffffff;
           min-height: 100vh;
       }

       .header {
           background: #1a1a1a;
           padding: 1rem 2rem;
           border-bottom: 1px solid #333;
           display: flex;
           justify-content: space-between;
           align-items: center;
       }

       .logo {
           display: flex;
           align-items: center;
           gap: 0.5rem;
           font-size: 1.2rem;
           font-weight: 600;
           color: #3498db;
       }

       .back-btn {
           background: #6c757d;
           color: white;
           padding: 0.5rem 1rem;
           border: none;
           border-radius: 6px;
           cursor: pointer;
           text-decoration: none;
           transition: background-color 0.2s ease;
       }

       .back-btn:hover {
           background: #5a6268;
       }

       .container {
           max-width: 1200px;
           margin: 0 auto;
           padding: 2rem;
       }

       .shared-materials-section {
           margin-bottom: 3rem;
           background: #1a1a1a;
           border-radius: 16px;
           padding: 2rem;
           border: 1px solid #333;
       }

       .section-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 1.5rem;
       }

       .section-title {
           color: #3498db;
           font-size: 1.5rem;
           font-weight: 600;
           display: flex;
           align-items: center;
           gap: 0.5rem;
       }

       .material-notification {
           background: #e74c3c;
           color: white;
           padding: 0.5rem 1rem;
           border-radius: 20px;
           font-size: 0.9rem;
           font-weight: 600;
           animation: pulse 2s infinite;
           display: none;
       }

       @keyframes pulse {
           0% { opacity: 1; transform: scale(1); }
           50% { opacity: 0.7; transform: scale(1.05); }
           100% { opacity: 1; transform: scale(1); }
       }

       .materials-grid {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
           gap: 1.5rem;
           margin-bottom: 1rem;
       }

       .material-card {
           background: #2d2d2d;
           border: 1px solid #333;
           border-radius: 12px;
           padding: 1.5rem;
           transition: all 0.3s ease;
           cursor: pointer;
           position: relative;
           overflow: hidden;
       }

       .material-card:hover {
           border-color: #3498db;
           transform: translateY(-3px);
           box-shadow: 0 8px 20px rgba(52, 152, 219, 0.2);
       }

       .material-card.new {
           border-color: #e74c3c;
           box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
       }

       .material-header {
           display: flex;
           justify-content: space-between;
           align-items: flex-start;
           margin-bottom: 1rem;
       }

       .material-title {
           font-size: 1.1rem;
           font-weight: 600;
           color: #3498db;
           margin-bottom: 0.5rem;
       }

       .material-category {
           background: #3498db;
           color: white;
           padding: 0.25rem 0.75rem;
           border-radius: 12px;
           font-size: 0.8rem;
           font-weight: 500;
       }

       .material-description {
           color: #95a5a6;
           margin-bottom: 1rem;
           line-height: 1.5;
           font-size: 0.9rem;
       }

       .material-meta {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 1rem;
       }

       .material-type {
           display: flex;
           align-items: center;
           gap: 0.5rem;
           color: #95a5a6;
           font-size: 0.9rem;
       }

       .material-date {
           color: #6c757d;
           font-size: 0.8rem;
       }

       .material-actions {
           display: flex;
           gap: 0.5rem;
       }

       .action-btn {
           background: #3498db;
           color: white;
           border: none;
           padding: 0.5rem 1rem;
           border-radius: 6px;
           cursor: pointer;
           font-size: 0.9rem;
           transition: background-color 0.2s ease;
           flex: 1;
       }

       .action-btn:hover {
           background: #2980b9;
       }

       .action-btn.secondary {
           background: #6c757d;
       }

       .action-btn.secondary:hover {
           background: #5a6268;
       }

       .no-materials {
           text-align: center;
           padding: 3rem 2rem;
           background: #2d2d2d;
           border-radius: 12px;
           color: #95a5a6;
           border: 2px dashed #333;
       }

       .no-materials-icon {
           font-size: 3rem;
           margin-bottom: 1rem;
           opacity: 0.5;
       }

       .my-submissions-section {
           margin-bottom: 3rem;
           background: #1a1a1a;
           border-radius: 16px;
           padding: 2rem;
           border: 1px solid #333;
       }

       .submissions-tabs {
           display: flex;
           gap: 0.5rem;
           margin-bottom: 2rem;
           padding: 0.25rem;
           background: #2d2d2d;
           border-radius: 12px;
           border: 1px solid #333;
       }

       .submission-tab {
           padding: 0.75rem 1.5rem;
           background: transparent;
           border: none;
           border-radius: 8px;
           cursor: pointer;
           transition: all 0.3s ease;
           color: #95a5a6;
           font-size: 0.9rem;
           font-weight: 500;
           flex: 1;
           text-align: center;
       }

       .submission-tab.active {
           background: #3498db;
           color: white;
           box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
       }

       .submission-tab:hover:not(.active) {
           background: rgba(52, 152, 219, 0.1);
           color: #3498db;
       }

       .my-submissions-grid, .my-quiz-submissions-grid {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
           gap: 1.5rem;
       }

       .submission-card {
           background: linear-gradient(145deg, #2d2d2d, #242424);
           border: 1px solid #333;
           border-radius: 16px;
           padding: 1.8rem;
           transition: all 0.3s ease;
           position: relative;
           overflow: hidden;
           box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
       }

       .submission-card::before {
           content: '';
           position: absolute;
           top: 0;
           left: 0;
           right: 0;
           height: 3px;
           background: linear-gradient(90deg, #3498db, #2980b9);
           border-radius: 16px 16px 0 0;
       }

       .submission-card:hover {
           border-color: #3498db;
           transform: translateY(-4px);
           box-shadow: 0 12px 24px rgba(52, 152, 219, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
       }

       .submission-header {
           margin-bottom: 1rem;
       }

       .submission-title {
           font-size: 1.1rem;
           font-weight: 600;
           color: #3498db;
           margin-bottom: 0.5rem;
       }

       .submission-meta {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 1rem;
       }

       .submission-date {
           color: #6c757d;
           font-size: 0.8rem;
       }

       .score-badge {
           padding: 0.3rem 0.8rem;
           border-radius: 12px;
           font-size: 0.8rem;
           font-weight: 600;
       }

       .score-excellent {
           background: #27ae60;
           color: white;
       }

       .score-good {
           background: #3498db;
           color: white;
       }

       .score-fair {
           background: #f39c12;
           color: white;
       }

       .score-poor {
           background: #e74c3c;
           color: white;
       }

       .score-ungraded {
           background: #6c757d;
           color: white;
       }

       .submission-answer {
           background: #1a1a1a;
           border-radius: 8px;
           padding: 1rem;
           margin-bottom: 1rem;
           border-left: 4px solid #3498db;
       }

       .submission-answer-label {
           font-size: 0.85rem;
           color: #95a5a6;
           margin-bottom: 0.5rem;
           font-weight: 500;
       }

       .submission-answer-content {
           color: #ffffff;
           line-height: 1.5;
           font-size: 0.9rem;
           white-space: pre-wrap;
           max-height: 120px;
           overflow-y: auto;
       }

       .submission-feedback {
           background: linear-gradient(135deg, #27ae60, #2ecc71);
           border-radius: 12px;
           padding: 1.2rem;
           margin-top: 1rem;
           border-left: 4px solid #1e8449;
           box-shadow: 0 2px 8px rgba(39, 174, 96, 0.2);
       }

       .submission-feedback-label {
           font-size: 0.85rem;
           color: #ffffff;
           margin-bottom: 0.5rem;
           font-weight: 600;
           opacity: 0.9;
       }

       .submission-feedback-content {
           color: #ffffff;
           line-height: 1.5;
           font-size: 0.9rem;
           white-space: pre-wrap;
       }

       .quiz-result {
           display: flex;
           align-items: center;
           gap: 0.8rem;
           margin-bottom: 1rem;
       }

       .quiz-result-icon {
           font-size: 1.5rem;
       }

       .quiz-result-text {
           flex: 1;
       }

       .quiz-result-status {
           font-size: 0.9rem;
           font-weight: 600;
       }

       .quiz-correct {
           color: #27ae60;
       }

       .quiz-incorrect {
           color: #e74c3c;
       }

       .quiz-answer-details {
           background: #1a1a1a;
           border-radius: 8px;
           padding: 1rem;
           margin-bottom: 1rem;
           border-left: 4px solid #3498db;
       }

       .quiz-answer-row {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 0.5rem;
       }

       .quiz-answer-row:last-child {
           margin-bottom: 0;
       }

       .quiz-answer-label {
           font-size: 0.85rem;
           color: #95a5a6;
           font-weight: 500;
       }

       .quiz-answer-value {
           color: #ffffff;
           font-size: 0.9rem;
           font-weight: 600;
       }

       .loading-message {
           text-align: center;
           padding: 3rem 2rem;
           background: #2d2d2d;
           border-radius: 12px;
           color: #95a5a6;
           border: 2px dashed #333;
           grid-column: 1 / -1;
       }

       .no-submissions {
           text-align: center;
           padding: 3rem 2rem;
           background: #2d2d2d;
           border-radius: 12px;
           color: #95a5a6;
           border: 2px dashed #333;
           grid-column: 1 / -1;
       }

       .no-submissions-icon {
           font-size: 3rem;
           margin-bottom: 1rem;
           opacity: 0.5;
       }

       @media (max-width: 768px) {
           .container {
               padding: 1rem;
           }
           
           .problems-grid, .materials-grid, .my-submissions-grid, .my-quiz-submissions-grid {
               grid-template-columns: 1fr;
           }

           .section-header {
               flex-direction: column;
               align-items: flex-start;
               gap: 1rem;
           }

           .material-header {
               flex-direction: column;
               align-items: flex-start;
               gap: 0.5rem;
           }

           .material-actions {
               width: 100%;
               justify-content: stretch;
           }

           .action-btn {
               flex: 1;
           }
       }
   </style>
</head>
<body>
   <div class="header">
       <div class="logo">
           📚 오늘의 학습
       </div>
       <a href="/" class="back-btn">← 홈으로</a>
   </div>

   <div class="container">
       <div class="shared-materials-section">
           <div class="section-header">
               <h2 class="section-title">
                   📚 공유된 학습자료
               </h2>
               <div class="material-notification" id="materialNotification">
                   새 자료 도착!
               </div>
           </div>
           
           <div class="materials-grid" id="sharedMaterialsGrid">
           </div>
           
           <div class="no-materials" id="noMaterials">
               <div class="no-materials-icon">📄</div>
               <p><strong>아직 공유된 학습자료가 없습니다</strong></p>
               <p>강사님이 자료를 공유하면 이곳에 표시됩니다</p>
           </div>
       </div>

       <div class="my-submissions-section">
           <div class="section-header">
               <h2 class="section-title">
                   📝 내 답안 및 피드백
               </h2>
           </div>
           
           <div class="submissions-tabs">
               <button class="submission-tab active" onclick="switchMySubmissionTab('problems')">문제 답안</button>
               <button class="submission-tab" onclick="switchMySubmissionTab('quiz')">퀴즈 답안</button>
           </div>
           
           <div class="my-submissions-grid" id="mySubmissionsGrid">
               <div class="loading-message">답안을 불러오는 중...</div>
           </div>
           
           <div class="my-quiz-submissions-grid" id="myQuizSubmissionsGrid" style="display: none;">
               <div class="loading-message">퀴즈 답안을 불러오는 중...</div>
           </div>
       </div>
   </div>

   <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
   <script src="/js/student-activity.js"></script>

<script>
    let sharedMaterials = [];
    let mySubmissions = [];
    let myQuizSubmissions = [];
    let currentSubmissionTab = 'problems';

    function getAuthToken() {
        return localStorage.getItem('token') || 
               localStorage.getItem('jwtToken') || 
               localStorage.getItem('authToken') || 
               sessionStorage.getItem('token') ||
               sessionStorage.getItem('jwtToken') ||
               sessionStorage.getItem('authToken');
    }

    function getCurrentUserId() {
        const storedUserId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
        if (storedUserId) {
            return storedUserId;
        }
        
        const token = getAuthToken();
        if (!token) return null;
        
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const userId = payload.userId || payload.id || payload.sub;
            
            if (userId) {
                localStorage.setItem('userId', userId);
            }
            
            return userId;
        } catch (e) {
            console.error('토큰 파싱 오류:', e);
            return null;
        }
    }

    function switchMySubmissionTab(tab) {
        currentSubmissionTab = tab;
        
        const problemsGrid = document.getElementById('mySubmissionsGrid');
        const quizGrid = document.getElementById('myQuizSubmissionsGrid');
        const tabs = document.querySelectorAll('.submission-tab');
        
        tabs.forEach(t => t.classList.remove('active'));
        
        if (tab === 'problems') {
            problemsGrid.style.display = 'grid';
            quizGrid.style.display = 'none';
            tabs[0].classList.add('active');
            loadMySubmissions();
        } else {
            problemsGrid.style.display = 'none';
            quizGrid.style.display = 'grid';
            tabs[1].classList.add('active');
            loadMyQuizSubmissions();
        }
    }

    async function loadMySubmissions() {
        try {
            const token = getAuthToken();
            const userId = getCurrentUserId();
            
            console.log('📝 답안 조회 디버깅:');
            console.log('토큰:', token ? '있음 (' + token.substring(0, 20) + '...)' : '없음');
            console.log('사용자ID:', userId);
            
            if (!token || !userId) {
                console.log('⛔ 토큰 또는 사용자 ID가 없습니다');
                renderMySubmissions();
                return;
            }

            const url = `/api/student/submissions?userId=${userId}`;
            console.log('📤 요청 URL:', url);

            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('📥 응답 상태:', response.status);

            if (response.ok) {
                const data = await response.json();
                console.log('📥 받은 데이터:', data);
                mySubmissions = data.submissions || [];
                console.log('📊 답안 수:', mySubmissions.length);
                renderMySubmissions();
            } else {
                const errorText = await response.text();
                console.error('⛔ 답안 조회 실패:', response.status, errorText);
                renderMySubmissions();
            }
        } catch (error) {
            console.error('⛔ 답안 조회 오류:', error);
            renderMySubmissions();
        }
    }

    async function loadMyQuizSubmissions() {
        try {
            const token = getAuthToken();
            const userId = getCurrentUserId();
            
            if (!token || !userId) {
                console.log('토큰 또는 사용자 ID가 없습니다');
                renderMyQuizSubmissions();
                return;
            }

            const response = await fetch(`/api/student/quiz-submissions?userId=${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                myQuizSubmissions = data.submissions || [];
                renderMyQuizSubmissions();
            } else {
                console.error('퀴즈 답안 조회 실패:', response.status);
                renderMyQuizSubmissions();
            }
        } catch (error) {
            console.error('퀴즈 답안 조회 오류:', error);
            renderMyQuizSubmissions();
        }
    }

    function renderMySubmissions() {
        const grid = document.getElementById('mySubmissionsGrid');
        
        if (mySubmissions.length === 0) {
            grid.innerHTML = `
                <div class="no-submissions">
                    <div class="no-submissions-icon">📝</div>
                    <p><strong>제출한 답안이 없습니다</strong></p>
                    <p>문제를 풀고 답안을 제출해보세요!</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = mySubmissions.map(submission => {
            const submitDate = new Date(submission.submittedAt);
            const scoreClass = getScoreClass(submission.score);
            const scoreText = submission.score !== null ? `${submission.score}점` : '미채점';
            
            return `
                <div class="submission-card">
                    <div class="submission-header">
                        <div class="submission-title">${submission.problemTitle || '제목 없음'}</div>
                        <div class="submission-meta">
                            <div class="submission-date">${formatSubmissionDate(submitDate)}</div>
                            <div class="score-badge ${scoreClass}">${scoreText}</div>
                        </div>
                    </div>
                    
                    <div class="submission-answer">
                        <div class="submission-answer-label">내 답안:</div>
                        <div class="submission-answer-content">${submission.answer || '답안이 없습니다.'}</div>
                    </div>
                    
                    ${submission.feedback ? `
                        <div class="submission-feedback">
                            <div class="submission-feedback-label">강사님 피드백:</div>
                            <div class="submission-feedback-content">${submission.feedback}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    function renderMyQuizSubmissions() {
        const grid = document.getElementById('myQuizSubmissionsGrid');
        
        if (myQuizSubmissions.length === 0) {
            grid.innerHTML = `
                <div class="no-submissions">
                    <div class="no-submissions-icon">⚡</div>
                    <p><strong>참여한 퀴즈가 없습니다</strong></p>
                    <p>강사님의 깜짝 퀴즈를 기다려보세요!</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = myQuizSubmissions.map(submission => {
            const submitDate = new Date(submission.submittedAt);
            const isCorrect = submission.isCorrect;
            
            return `
                <div class="submission-card">
                    <div class="submission-header">
                        <div class="submission-title">${submission.quizTitle || '퀴즈'}</div>
                        <div class="submission-meta">
                            <div class="submission-date">${formatSubmissionDate(submitDate)}</div>
                        </div>
                    </div>
                    
                    <div class="quiz-result">
                        <div class="quiz-result-icon">${isCorrect ? '🎉' : '😅'}</div>
                        <div class="quiz-result-text">
                            <div class="quiz-result-status ${isCorrect ? 'quiz-correct' : 'quiz-incorrect'}">
                                ${isCorrect ? '정답입니다!' : '틀렸습니다'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="quiz-answer-details">
                        <div class="quiz-answer-row">
                            <span class="quiz-answer-label">내 답안:</span>
                            <span class="quiz-answer-value">${submission.userAnswer + 1}번</span>
                        </div>
                        <div class="quiz-answer-row">
                            <span class="quiz-answer-label">정답:</span>
                            <span class="quiz-answer-value">${submission.correctAnswer + 1}번</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getScoreClass(score) {
        if (score === null) return 'score-ungraded';
        if (score >= 90) return 'score-excellent';
        if (score >= 70) return 'score-good';
        if (score >= 50) return 'score-fair';
        return 'score-poor';
    }

    function formatSubmissionDate(date) {
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) return '오늘 ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        if (diffDays === 2) return '어제 ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        if (diffDays <= 7) return `${diffDays - 1}일 전`;
        
        return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }

    function handleNewMaterial(notification) {
        console.log('새 자료 처리:', notification);
        
        const materialNotification = document.getElementById('materialNotification');
        if (materialNotification) {
            materialNotification.style.display = 'block';
            materialNotification.textContent = notification.message || '새 자료가 공유되었습니다!';
            
            materialNotification.style.animation = 'pulse 2s infinite';
            
            setTimeout(() => {
                materialNotification.style.display = 'none';
                materialNotification.style.animation = '';
            }, 8000);
        }
        
        if (Notification.permission === 'granted') {
            new Notification('새 학습자료 공유', {
                body: notification.message,
                icon: '/favicon.ico'
            });
        }
        
        setTimeout(() => {
            console.log('자료 목록 새로고침 시작');
            loadSharedMaterials();
        }, 1000);
    }

    async function loadSharedMaterials() {
        try {
            const token = getAuthToken();
            console.log('토큰 상태:', token ? '있음' : '없음');
            
            if (!token) {
                console.log('토큰이 없어서 공유 자료를 로드할 수 없습니다');
                renderSharedMaterials();
                return;
            }
            
            const response = await fetch('/api/teacher/materials/shared', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('응답 상태:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('받은 데이터:', data);
                
                sharedMaterials = data.materials || data;
                console.log('받은 자료 수:', sharedMaterials.length);
                renderSharedMaterials();
            } else {
                const errorText = await response.text();
                console.error('공유 자료 로딩 실패:', response.status, errorText);
                renderSharedMaterials();
            }
        } catch (error) {
            console.error('공유 자료 로딩 실패:', error);
            renderSharedMaterials();
        }
    }
    
    function renderSharedMaterials() {
        const grid = document.getElementById('sharedMaterialsGrid');
        const noMaterials = document.getElementById('noMaterials');
        
        if (sharedMaterials.length === 0) {
            grid.style.display = 'none';
            noMaterials.style.display = 'block';
            return;
        }
        
        grid.style.display = 'grid';
        noMaterials.style.display = 'none';
        grid.innerHTML = '';
        
        sharedMaterials.forEach(material => {
            const card = createMaterialCard(material);
            grid.appendChild(card);
        });
    }

    function createMaterialCard(material) {
        const card = document.createElement('div');
        card.className = 'material-card';
        
        const isNew = isNewMaterial(material.createdAt);
        if (isNew) {
            card.classList.add('new');
        }
        
        const fileIcon = getFileIcon(material.materialType || material.fileType || material.type);
        const fileSize = material.fileSize ? formatFileSize(material.fileSize) : '';
        
        card.innerHTML = `
            <div class="material-header">
                <div class="material-title">${material.title}</div>
                <div class="material-category">${material.category || '일반'}</div>
            </div>
            <div class="material-description">${material.content || material.description || '설명이 없습니다.'}</div>
            <div class="material-meta">
                <div class="material-type">
                    <span>${fileIcon}</span>
                    <span>${(material.materialType || material.fileType || material.type || 'file').toUpperCase()}</span>
                    ${fileSize ? `<span>(${fileSize})</span>` : ''}
                </div>
                <div class="material-date">${formatDate(material.createdAt)}</div>
            </div>
            <div class="material-actions">
                ${(material.materialType === 'youtube' || material.type === 'youtube') ? 
                    `<button class="action-btn" onclick="openYoutube('${material.youtubeUrl || material.url}')">▶️ 시청하기</button>` :
                    `<button class="action-btn" onclick="downloadMaterial(${material.id})">📥 다운로드</button>`
                }
                <button class="action-btn secondary" onclick="viewMaterial(${material.id})">👁️ 미리보기</button>
            </div>
        `;
        
        return card;
    }

    function getFileIcon(fileType) {
        const icons = {
            'pdf': '📄',
            'application/pdf': '📄',
            'ppt': '📊',
            'pptx': '📊',
            'application/vnd.ms-powerpoint': '📊',
            'application/vnd.openxmlformats-officedocument.presentationml.presentation': '📊',
            'doc': '📝',
            'docx': '📝',
            'application/msword': '📝',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': '📝',
            'jpg': '🖼️',
            'jpeg': '🖼️',
            'png': '🖼️',
            'gif': '🖼️',
            'image/jpeg': '🖼️',
            'image/jpg': '🖼️',
            'image/png': '🖼️',
            'image/gif': '🖼️',
            'mp4': '🎥',
            'avi': '🎥',
            'mov': '🎥',
            'video/mp4': '🎥',
            'video/avi': '🎥',
            'video/quicktime': '🎥',
            'youtube': '📺',
            'zip': '📦',
            'rar': '📦',
            'application/zip': '📦',
            'application/x-rar-compressed': '📦',
            'text': '📝',
            'text/plain': '📝'
        };
        return icons[fileType?.toLowerCase()] || '📄';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) return '오늘';
        if (diffDays === 2) return '어제';
        if (diffDays <= 7) return `${diffDays - 1}일 전`;
        
        return date.toLocaleDateString('ko-KR');
    }

    function isNewMaterial(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffHours = diffTime / (1000 * 60 * 60);
        return diffHours <= 24;
    }

    function openYoutube(url) {
        window.open(url, '_blank');
    }

    async function downloadMaterial(materialId) {
        try {
            const token = getAuthToken();
            const response = await fetch(`/api/teacher/materials/${materialId}/download`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `material_${materialId}`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                alert('파일 다운로드에 실패했습니다.');
            }
        } catch (error) {
            console.error('다운로드 실패:', error);
            alert('파일 다운로드 중 오류가 발생했습니다.');
        }
    }

    function viewMaterial(materialId) {
        console.log('미리보기 클릭:', materialId);
        const newWindow = window.open(`/material-preview/${materialId}`, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
            console.log('팝업 차단됨, 현재 탭에서 열기');
            window.open(`/material-preview/${materialId}`, '_self');
        }
    }

    function initializePage() {
        console.log('페이지 초기화 시작');
        
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                console.log('알림 권한:', permission);
            });
        }
        
        loadSharedMaterials();
        loadMySubmissions();
        
        console.log('페이지 초기화 완료');
    }

    function addActivity(message) {
        console.log('활동 추가:', message);
    }

    function loadLearningStats() {
        console.log('학습 통계 로드');
    }

    window.loadSharedMaterials = loadSharedMaterials;

    document.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>