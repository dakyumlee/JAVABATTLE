<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강사 실시간 모니터링</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #2c3e50;
        }
        .header {
            background: white;
            padding: 2rem;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 700;
        }
        .header p {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
        }
        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 700;
            z-index: 1000;
        }
        .status-connected {
            background: #27ae60;
            color: white;
            border: 2px solid #27ae60;
        }
        .status-disconnected {
            background: #e74c3c;
            color: white;
            border: 2px solid #e74c3c;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #3498db;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: #3498db;
            line-height: 1;
        }
        .stat-label {
            color: #6c757d;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1.5rem;
            padding: 1rem 2rem 2rem;
            max-width: 1500px;
            margin: 0 auto;
        }
        .student-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #3498db;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .student-card:hover::before {
            transform: scaleX(1);
        }
        .student-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
        }
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }
        .student-name { 
            font-size: 1.2rem; 
            font-weight: 700;
            color: #2c3e50;
        }
        .student-status {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-coding { background: #e74c3c; }
        .status-active { background: #27ae60; }
        .status-idle { background: #f39c12; }
        .status-offline { background: #95a5a6; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        .status-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6c757d;
        }
        .activity-info {
            margin: 1.2rem 0;
            padding: 1.2rem;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #3498db;
        }
        .current-page {
            font-size: 0.95rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.4rem;
        }
        .code-progress {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .last-activity {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 0.4rem;
        }
        .action-buttons {
            display: flex;
            gap: 0.6rem;
            margin-top: 1.2rem;
        }
        .btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            font-family: 'Pretendard Variable', sans-serif;
        }
        .btn-hint {
            background: #3498db;
            color: white;
        }
        .btn-hint:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .btn-monitor {
            background: #6c757d;
            color: white;
        }
        .btn-monitor:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        .controls-panel {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            border-radius: 16px;
            border: 1px solid #e9ecef;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .controls-header {
            padding: 1.2rem 1.5rem;
            background: #3498db;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }
        .controls-header:hover {
            background: #2980b9;
        }
        .controls-title {
            margin: 0;
            font-weight: 700;
            font-size: 1rem;
        }
        .controls-toggle {
            font-size: 1.2rem;
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        .controls-content {
            padding: 1rem 1.5rem 1.5rem;
            transition: all 0.3s ease;
            max-height: 400px;
            overflow: hidden;
        }
        .controls-content.collapsed {
            max-height: 0;
            padding: 0 1.5rem;
        }
        .btn-create {
            background: #3498db;
            color: white;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.3rem 0;
            width: 100%;
            font-family: 'Pretendard Variable', sans-serif;
            font-size: 0.8rem;
        }
        .btn-create:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .btn-quiz {
            background: #e74c3c;
        }
        .btn-quiz:hover {
            background: #c0392b;
        }
        .btn-notes {
            background: #3498db;
        }
        .btn-notes:hover {
            background: #2980b9;
        }
        .btn-submissions {
            background: #27ae60;
        }
        .btn-submissions:hover {
            background: #229954;
        }
        .refresh-btn {
            position: fixed;
            top: 5rem;
            right: 2rem;
            background: #3498db;
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            width: 45px;
            height: 45px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        .refresh-btn:hover {
            background: #2980b9;
            transform: rotate(180deg) scale(1.1);
        }
        .auth-check {
            background: white;
            color: #e74c3c;
            padding: 1.2rem;
            margin: 1.5rem;
            border-radius: 12px;
            border: 2px solid #e74c3c;
            text-align: center;
            display: none;
            font-weight: 600;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 16px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        .submissions-modal .modal-content {
            width: 90%;
            max-width: 1300px;
        }
        .modal-header {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #2c3e50;
        }
        .modal-input, .modal-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-family: 'Pretendard Variable', sans-serif;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }
        .modal-input:focus, .modal-textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        .modal-textarea {
            resize: vertical;
            min-height: 100px;
        }
        .modal-buttons {
            display: flex;
            gap: 0.8rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        .modal-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Pretendard Variable', sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .modal-btn-primary {
            background: #3498db;
            color: white;
        }
        .modal-btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .modal-btn-primary.active {
            background: #2980b9;
        }
        .modal-btn-quiz {
            background: #e74c3c;
            color: white;
        }
        .modal-btn-quiz:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }
        .modal-btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        .empty-state {
            text-align: center;
            grid-column: 1/-1;
            padding: 3rem;
            color: #6c757d;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .quiz-options {
            margin-bottom: 1.5rem;
        }
        .option-group {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        .option-input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Pretendard Variable', sans-serif;
            transition: border-color 0.3s ease;
        }
        .option-input:focus {
            border-color: #3498db;
            outline: none;
        }
        .option-radio {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .correct-option {
            border-color: #27ae60 !important;
            background: #f0fff4;
        }
        .quiz-preview {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #e74c3c;
            margin-bottom: 1.5rem;
        }
        .quiz-preview-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.6rem;
        }
        .quiz-preview-question {
            color: #6c757d;
            margin-bottom: 1rem;
        }
        .quiz-preview-options {
            color: #6c757d;
            font-size: 0.95rem;
        }
        .submission-tab {
            min-height: 450px;
        }
        .submissions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .submissions-table th,
        .submissions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        .submissions-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        .submission-answer {
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .submission-time {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .score-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .score-excellent {
            background: #d4edda;
            color: #155724;
        }
        .score-good {
            background: #cce5ff;
            color: #004085;
        }
        .score-fair {
            background: #fff3cd;
            color: #856404;
        }
        .score-poor {
            background: #f8d7da;
            color: #721c24;
        }
        .score-ungraded {
            background: #e9ecef;
            color: #6c757d;
        }
        .btn-grade {
            background: #f39c12;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-grade:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }
        .tab-buttons {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .notes-modal .modal-content {
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 1rem;
        }

        .notes-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            background: white;
            color: #6c757d;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: 'Pretendard Variable', sans-serif;
        }

        .filter-btn.active,
        .filter-btn:hover {
            border-color: #3498db;
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .notes-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }

        .note-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .note-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .note-item:last-child {
            margin-bottom: 0;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .note-title {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1rem;
            margin: 0;
        }

        .note-category {
            background: #3498db;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .note-meta {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .note-content {
            color: #2c3e50;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid #e9ecef;
        }

        .btn-note-action {
            padding: 0.3rem 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-edit:hover {
            background: #e67e22;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .empty-notes {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .empty-notes h3 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .category-수업 { border-left-color: #3498db; }
        .category-학생 { border-left-color: #27ae60; }
        .category-과제 { border-left-color: #f39c12; }
        .category-기타 { border-left-color: #9b59b6; }

        .note-category.category-수업 { background: #3498db; }
        .note-category.category-학생 { background: #27ae60; }
        .note-category.category-과제 { background: #f39c12; }
        .note-category.category-기타 { background: #9b59b6; }

        @media (max-width: 768px) {
            .students-grid {
                grid-template-columns: 1fr;
            }
            .controls-panel {
                bottom: 1rem;
                right: 1rem;
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">연결 중...</div>
    
    <div class="auth-check" id="auth-warning">
        강사 권한이 필요합니다. 로그인 후 이용해주세요.
    </div>

    <button class="refresh-btn" onclick="refreshData()">🔄</button>

    <div class="header">
        <h1>강사 실시간 모니터링</h1>
        <p>학생들의 활동을 실시간으로 모니터링하고 즉시 피드백을 제공하세요</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-students">0</div>
            <div class="stat-label">전체 학생</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="active-students">0</div>
            <div class="stat-label">접속 중</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="coding-students">0</div>
            <div class="stat-label">코딩 중</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="avg-code-length">0</div>
            <div class="stat-label">평균 코드 길이</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="submissions-count">0</div>
            <div class="stat-label">제출된 답안</div>
        </div>
    </div>

    <div class="students-grid" id="students-container"></div>

    <div class="controls-panel" id="controlsPanel">
        <div class="controls-header" onclick="toggleControlsPanel()">
            <h3 class="controls-title">빠른 작업</h3>
            <span class="controls-toggle" id="controlsToggle">−</span>
        </div>
        <div class="controls-content" id="controlsContent">
            <button class="btn-create" onclick="openCreateProblemModal()">📝 즉석 문제 출제</button>
            <button class="btn-create" onclick="openGlobalHintModal()">💡 전체 힌트</button>
            <button class="btn-create btn-quiz" onclick="openQuizModal()">⚡ 깜짝 퀴즈</button>
            <button class="btn-create btn-notes" onclick="openNotesModal()">📝 강사 메모장</button>
            <button class="btn-create btn-submissions" onclick="openSubmissionsModal()">📋 답안 조회</button>
        </div>
    </div>

    <div id="hintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">💡 힌트 보내기</div>
            <input type="text" id="hintStudentName" class="modal-input" readonly placeholder="학생 이름">
            <textarea id="hintMessage" class="modal-textarea" placeholder="힌트 메시지를 입력하세요..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('hintModal')">취소</button>
                <button class="modal-btn modal-btn-primary" onclick="sendHintConfirm()">전송</button>
            </div>
        </div>
    </div>

    <div id="globalHintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">💡 전체 힌트 보내기</div>
            <textarea id="globalHintMessage" class="modal-textarea" placeholder="모든 학생에게 보낼 힌트를 입력하세요..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('globalHintModal')">취소</button>
                <button class="modal-btn modal-btn-primary" onclick="sendGlobalHintConfirm()">전송</button>
            </div>
        </div>
    </div>

    <div id="createProblemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">📝 즉석 문제 출제</div>
            <input type="text" id="problemTitle" class="modal-input" placeholder="문제 제목">
            <textarea id="problemDescription" class="modal-textarea" placeholder="문제 설명을 입력하세요..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('createProblemModal')">취소</button>
                <button class="modal-btn modal-btn-primary" onclick="createProblemConfirm()">출제</button>
            </div>
        </div>
    </div>

    <div id="quizModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">⚡ 깜짝 퀴즈 만들기</div>
            <input type="text" id="quizTitle" class="modal-input" placeholder="퀴즈 제목 (예: Java 기초 문법 퀴즈)">
            <textarea id="quizQuestion" class="modal-textarea" placeholder="문제를 입력하세요 (예: System.out.println()의 출력 결과는?)"></textarea>
            
            <div class="quiz-options">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">선택지 (정답을 체크하세요)</label>
                <div class="option-group">
                    <input type="radio" name="correctAnswer" value="0" class="option-radio">
                    <input type="text" class="option-input" placeholder="선택지 1" data-option="0">
                </div>
                <div class="option-group">
                    <input type="radio" name="correctAnswer" value="1" class="option-radio">
                    <input type="text" class="option-input" placeholder="선택지 2" data-option="1">
                </div>
                <div class="option-group">
                    <input type="radio" name="correctAnswer" value="2" class="option-radio">
                    <input type="text" class="option-input" placeholder="선택지 3" data-option="2">
                </div>
                <div class="option-group">
                    <input type="radio" name="correctAnswer" value="3" class="option-radio">
                    <input type="text" class="option-input" placeholder="선택지 4" data-option="3">
                </div>
            </div>

            <div class="quiz-preview" id="quizPreview" style="display: none;">
                <div class="quiz-preview-title">미리보기</div>
                <div class="quiz-preview-question" id="previewQuestion"></div>
                <div class="quiz-preview-options" id="previewOptions"></div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('quizModal')">취소</button>
                <button class="modal-btn modal-btn-secondary" onclick="previewQuiz()">미리보기</button>
                <button class="modal-btn modal-btn-quiz" onclick="sendQuizConfirm()">퀴즈 시작</button>
            </div>
        </div>
    </div>

    <div id="submissionsModal" class="modal submissions-modal">
        <div class="modal-content">
            <div class="modal-header">📋 제출된 답안 조회 및 채점</div>
            
            <div class="tab-buttons">
                <button class="modal-btn modal-btn-primary active" onclick="switchSubmissionTab('problems')">문제 답안</button>
                <button class="modal-btn modal-btn-secondary" onclick="switchSubmissionTab('quiz')">퀴즈 답안</button>
            </div>
            
            <div id="problemSubmissions" class="submission-tab">
                <div id="problemSubmissionsContent">
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        답안을 불러오는 중...
                    </div>
                </div>
            </div>
            
            <div id="quizSubmissions" class="submission-tab" style="display: none;">
                <div id="quizSubmissionsContent">
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        퀴즈 답안을 불러오는 중...
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('submissionsModal')">닫기</button>
                <button class="modal-btn modal-btn-primary" onclick="loadAllSubmissions()">새로고침</button>
            </div>
        </div>
    </div>

    <div id="scoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">📝 답안 채점</div>
            <div id="scoreModalContent">
                <div><strong>학생:</strong> <span id="scoreStudentName"></span></div>
                <div style="margin: 10px 0;"><strong>문제:</strong> <span id="scoreProblemTitle"></span></div>
                <div style="margin: 10px 0;"><strong>답안:</strong></div>
                <div id="scoreAnswer" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; max-height: 200px; overflow-y: auto;"></div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">점수 (0-100):</label>
                    <input type="number" id="scoreInput" min="0" max="100" class="modal-input" placeholder="점수를 입력하세요">
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">피드백:</label>
                    <textarea id="feedbackInput" class="modal-textarea" placeholder="학생에게 전달할 피드백을 입력하세요..." style="min-height: 100px;"></textarea>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('scoreModal')">취소</button>
                <button class="modal-btn modal-btn-primary" onclick="saveScore()">점수 저장</button>
            </div>
        </div>
    </div>

    <div id="notesModal" class="modal notes-modal">
        <div class="modal-content">
            <div class="notes-header">
                <div class="modal-header" style="margin-bottom: 0;">📝 강사 메모장</div>
                <button class="modal-btn modal-btn-primary" onclick="openCreateNoteModal()">새 메모 작성</button>
            </div>
            
            <div class="notes-filter">
                <button class="filter-btn active" onclick="filterNotes('all')">전체</button>
                <button class="filter-btn" onclick="filterNotes('수업')">수업</button>
                <button class="filter-btn" onclick="filterNotes('학생')">학생</button>
                <button class="filter-btn" onclick="filterNotes('과제')">과제</button>
                <button class="filter-btn" onclick="filterNotes('기타')">기타</button>
            </div>
            
            <div class="notes-list" id="notesList">
                <div style="text-align: center; padding: 2rem; color: #6c757d;">
                    메모를 불러오는 중...
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('notesModal')">닫기</button>
            </div>
        </div>
    </div>

    <div id="createNoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">📝 새 메모 작성</div>
            
            <div class="form-group">
                <label class="form-label">제목</label>
                <input type="text" id="noteTitle" class="modal-input" placeholder="메모 제목을 입력하세요">
            </div>
            
            <div class="form-group">
                <label class="form-label">카테고리</label>
                <select id="noteCategory" class="modal-input">
                    <option value="수업">수업</option>
                    <option value="학생">학생</option>
                    <option value="과제">과제</option>
                    <option value="기타">기타</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">내용</label>
                <textarea id="noteContent" class="modal-textarea" placeholder="메모 내용을 입력하세요..." style="min-height: 150px;"></textarea>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('createNoteModal')">취소</button>
                <button class="modal-btn modal-btn-primary" onclick="saveNote()">저장</button>
            </div>
        </div>
    </div>

    <script>
    var stompClient = null;
    var studentsData = [];
    var currentStudentId = null;
    var isConnected = false;
    var notesData = [];
    var currentNoteId = null;
    var currentFilter = 'all';
    var submissionsData = [];
    var quizSubmissionsData = [];
    var currentSubmissionId = null;
    var currentSubmissionTab = 'problems';
    var userNamesCache = {};

    function getAuthToken() {
        return localStorage.getItem('token') || 
               localStorage.getItem('jwtToken') || 
               localStorage.getItem('authToken') || 
               sessionStorage.getItem('token') ||
               sessionStorage.getItem('jwtToken') ||
               sessionStorage.getItem('authToken');
    }

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        
        stompClient.connect({}, function (frame) {
            console.log('WebSocket 연결됨: ' + frame);
            isConnected = true;
            updateConnectionStatus();
            
            stompClient.subscribe('/topic/teacher-monitor', function (message) {
                var activity = JSON.parse(message.body);
                updateStudentActivity(activity);
            });
            
            stompClient.subscribe('/topic/student-disconnect', function (message) {
                var data = JSON.parse(message.body);
                removeStudent(data.userId);
            });

            stompClient.subscribe('/topic/teacher-notifications', function(message) {
                var notification = JSON.parse(message.body);
                if (notification.type === 'ANSWER_SUBMITTED') {
                    showAnswerNotification(notification);
                    updateSubmissionsCount();
                } else if (notification.type === 'QUIZ_SUBMITTED') {
                    showQuizNotification(notification);
                    updateSubmissionsCount();
                }
            });
            
        }, function(error) {
            console.log('WebSocket 연결 실패: ' + error);
            isConnected = false;
            updateConnectionStatus();
            setTimeout(connect, 5000);
        });
    }

    function toggleControlsPanel() {
        var content = document.getElementById('controlsContent');
        var toggle = document.getElementById('controlsToggle');
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            toggle.textContent = '−';
            toggle.style.transform = 'rotate(0deg)';
        } else {
            content.classList.add('collapsed');
            toggle.textContent = '+';
            toggle.style.transform = 'rotate(90deg)';
        }
    }

    function loadUserNames() {
        const token = getAuthToken();
        if (!token) {
            console.log('토큰이 없어서 사용자 목록을 로드할 수 없습니다');
            return;
        }

        fetch('/api/users/all', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(function(response) { 
                console.log('사용자 목록 API 응답:', response.status);
                if (!response.ok) {
                    throw new Error('사용자 목록 조회 실패: ' + response.status);
                }
                return response.json(); 
            })
            .then(function(data) {
                console.log('받은 사용자 데이터:', data);
                if (data.success && data.users) {
                    data.users.forEach(function(user) {
                        userNamesCache[user.id] = user.nickname || user.email || `사용자${user.id}`;
                    });
                    console.log('사용자 캐시 업데이트:', userNamesCache);
                    renderStudents();
                } else if (Array.isArray(data)) {
                    data.forEach(function(user) {
                        userNamesCache[user.id] = user.nickname || user.email || `사용자${user.id}`;
                    });
                    console.log('사용자 캐시 업데이트:', userNamesCache);
                    renderStudents();
                }
            })
            .catch(function(error) {
                console.log('사용자 목록 로드 실패:', error);
            });
    }

    function getStudentName(userId) {
        const cachedName = userNamesCache[userId];
        if (cachedName) {
            return cachedName;
        }
        return `학생${userId}`;
    }

    function showAnswerNotification(data) {
        var notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #38a169;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 500px;
            font-family: 'Pretendard Variable', sans-serif;
            animation: slideIn 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 5px;">📝 답안 제출 알림</div>
            <div>${getStudentName(data.userId)}가 "${data.problemTitle || '문제'}"의 답안을 제출했습니다.</div>
            <div style="margin-top: 5px; font-size: 0.9em; opacity: 0.9;">답안: ${data.answer ? data.answer.substring(0, 50) : ''}${data.answer && data.answer.length > 50 ? '...' : ''}</div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(function() {
            notification.remove();
        }, 8000);
    }

    function showQuizNotification(data) {
        var notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: ${data.isCorrect ? '#38a169' : '#e53e3e'};
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 500px;
            font-family: 'Pretendard Variable', sans-serif;
            animation: slideIn 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 5px;">⚡ 퀴즈 답안 제출</div>
            <div>${getStudentName(data.userId)}가 "${data.quizTitle}" 퀴즈에 답변했습니다.</div>
            <div style="margin-top: 5px; font-size: 0.9em; opacity: 0.9;">
                학생 답안: ${data.userAnswer + 1}번, 정답: ${data.correctAnswer + 1}번 
                ${data.isCorrect ? '✓ 정답' : '✗ 오답'}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(function() {
            notification.remove();
        }, 8000);
    }

    function updateSubmissionsCount() {
        const token = getAuthToken();
        if (!token) return;

        fetch('/api/teacher/submissions', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    document.getElementById('submissions-count').textContent = data.totalCount || 0;
                }
            })
            .catch(function(error) {
                console.log('답안 수 조회 실패:', error);
            });
    }

    function updateConnectionStatus() {
        var statusEl = document.getElementById('connection-status');
        if (isConnected) {
            statusEl.textContent = '🟢 실시간 연결됨';
            statusEl.className = 'connection-status status-connected';
        } else {
            statusEl.textContent = '🔴 연결 끊김';
            statusEl.className = 'connection-status status-disconnected';
        }
    }

    function updateStudentActivity(activity) {
        var existingIndex = studentsData.findIndex(function(s) { return s.id === activity.userId; });
        
        if (existingIndex >= 0) {
            studentsData[existingIndex] = {
                id: studentsData[existingIndex].id,
                nickname: userNamesCache[activity.userId] || studentsData[existingIndex].nickname || getStudentName(activity.userId),
                currentPage: activity.page,
                isCoding: activity.isCoding,
                codeLength: activity.codeLength,
                lastActivity: new Date(activity.timestamp)
            };
        } else {
            studentsData.push({
                id: activity.userId,
                nickname: userNamesCache[activity.userId] || getStudentName(activity.userId),
                currentPage: activity.page,
                isCoding: activity.isCoding,
                codeLength: activity.codeLength,
                lastActivity: new Date(activity.timestamp)
            });
        }
        
        renderStudents();
        updateStats();
    }

    function removeStudent(userId) {
        studentsData = studentsData.filter(function(s) { return s.id !== userId; });
        renderStudents();
        updateStats();
    }

    function checkTeacherAuth() {
        var token = getAuthToken();
        if (!token) {
            document.getElementById('auth-warning').style.display = 'block';
            return false;
        }
        return true;
    }

    function refreshData() {
        const token = getAuthToken();
        if (!token) {
            console.log('토큰이 없어서 데이터를 새로고침할 수 없습니다');
            return;
        }

        fetch('/api/teacher/active-students', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(function(response) { 
                console.log('활성 학생 API 응답:', response.status);
                return response.json(); 
            })
            .then(function(data) {
                console.log('받은 학생 데이터:', data);
                studentsData = data.map(function(session) {
                    return {
                        id: session.userId,
                        nickname: userNamesCache[session.userId] || getStudentName(session.userId),
                        currentPage: session.currentPage || '/study',
                        isCoding: session.isCoding || false,
                        codeLength: session.codeLength || 0,
                        lastActivity: new Date(session.lastActivity || session.updatedAt || Date.now())
                    };
                });
                updateStats();
                renderStudents();
                updateSubmissionsCount();
            })
            .catch(function(error) {
                console.log('API 연결 대기 중...', error);
            });
    }

    function updateStats() {
        var totalStudents = studentsData.length;
        var now = new Date();
        var activeStudents = studentsData.filter(function(s) { 
            var lastActivity = new Date(s.lastActivity);
            return (now - lastActivity) < 300000;
        }).length;
        var codingStudents = studentsData.filter(function(s) { return s.isCoding; }).length;
        var avgCodeLength = totalStudents > 0 ? 
            Math.round(studentsData.reduce(function(sum, s) { return sum + (s.codeLength || 0); }, 0) / totalStudents) : 0;

        document.getElementById('total-students').textContent = totalStudents;
        document.getElementById('active-students').textContent = activeStudents;
        document.getElementById('coding-students').textContent = codingStudents;
        document.getElementById('avg-code-length').textContent = avgCodeLength;
    }

    function renderStudents() {
        var container = document.getElementById('students-container');
        
        if (studentsData.length === 0) {
            container.innerHTML = '<div class="empty-state">접속한 학생이 없습니다</div>';
            return;
        }

        container.innerHTML = studentsData.map(function(student) {
            var lastActivity = new Date(student.lastActivity);
            var timeDiff = new Date() - lastActivity;
            var isActive = timeDiff < 300000;
            
            var statusClass, statusText;
            if (student.isCoding) {
                statusClass = 'status-coding';
                statusText = '코딩 중';
            } else if (isActive) {
                statusClass = 'status-active';
                statusText = '활동 중';
            } else if (timeDiff < 600000) {
                statusClass = 'status-idle';
                statusText = '대기 중';
            } else {
                statusClass = 'status-offline';
                statusText = '비활성';
            }

            return '<div class="student-card">' +
                '<div class="student-header">' +
                    '<div class="student-name">' + student.nickname + '</div>' +
                    '<div class="student-status">' +
                        '<div class="status-dot ' + statusClass + '"></div>' +
                        '<span class="status-text">' + statusText + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="activity-info">' +
                    '<div class="current-page">📄 ' + (student.currentPage || '메인 페이지') + '</div>' +
                    '<div class="code-progress">💻 코드 길이: ' + (student.codeLength || 0) + '자</div>' +
                    '<div class="last-activity">⏰ ' + formatTime(lastActivity) + '</div>' +
                '</div>' +
                '<div class="action-buttons">' +
                    '<button class="btn btn-hint" onclick="openHintModal(\'' + student.id + '\', \'' + student.nickname + '\')">💡 힌트</button>' +
                    '<button class="btn btn-monitor" onclick="monitorStudent(\'' + student.id + '\')">👁️ 모니터</button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    function formatTime(date) {
        var now = new Date();
        var diff = now - date;
        var days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (diff < 60000) return '방금 전';
        if (diff < 3600000) return Math.floor(diff / 60000) + '분 전';
        return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }

    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        var modal = document.getElementById(modalId);
        var inputs = modal.querySelectorAll('input, textarea, select');
        for (var i = 0; i < inputs.length; i++) {
            if (!inputs[i].readOnly) {
                if (inputs[i].type === 'checkbox') {
                    inputs[i].checked = false;
                } else {
                    inputs[i].value = '';
                }
            }
        }
        if (modalId === 'quizModal') {
            var radios = modal.querySelectorAll('input[type="radio"]');
            for (var j = 0; j < radios.length; j++) {
                radios[j].checked = false;
            }
            document.getElementById('quizPreview').style.display = 'none';
        }
    }

    function openHintModal(studentId, studentName) {
        currentStudentId = studentId;
        document.getElementById('hintStudentName').value = studentName;
        openModal('hintModal');
    }

    function openGlobalHintModal() {
        openModal('globalHintModal');
    }

    function openCreateProblemModal() {
        openModal('createProblemModal');
    }

    function openQuizModal() {
        openModal('quizModal');
    }

    function openNotesModal() {
        openModal('notesModal');
        loadNotes();
    }

    function openSubmissionsModal() {
        openModal('submissionsModal');
        loadAllSubmissions();
    }

    function switchSubmissionTab(tabName) {
        currentSubmissionTab = tabName;
        
        var problemTab = document.getElementById('problemSubmissions');
        var quizTab = document.getElementById('quizSubmissions');
        var buttons = document.querySelectorAll('.tab-buttons .modal-btn');
        
        if (tabName === 'problems') {
            problemTab.style.display = 'block';
            quizTab.style.display = 'none';
            buttons[0].classList.add('active');
            buttons[1].classList.remove('active');
            buttons[0].classList.remove('modal-btn-secondary');
            buttons[0].classList.add('modal-btn-primary');
            buttons[1].classList.remove('modal-btn-primary');
            buttons[1].classList.add('modal-btn-secondary');
            loadProblemSubmissions();
        } else {
            problemTab.style.display = 'none';
            quizTab.style.display = 'block';
            buttons[1].classList.add('active');
            buttons[0].classList.remove('active');
            buttons[1].classList.remove('modal-btn-secondary');
            buttons[1].classList.add('modal-btn-primary');
            buttons[0].classList.remove('modal-btn-primary');
            buttons[0].classList.add('modal-btn-secondary');
            loadQuizSubmissions();
        }
    }

    function loadAllSubmissions() {
        if (currentSubmissionTab === 'problems') {
            loadProblemSubmissions();
        } else {
            loadQuizSubmissions();
        }
    }

    function loadProblemSubmissions() {
        document.getElementById('problemSubmissionsContent').innerHTML = 
            '<div style="text-align: center; padding: 2rem; color: #6c757d;">답안을 불러오는 중...</div>';
        
        const token = getAuthToken();
        fetch('/api/teacher/submissions', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    submissionsData = data.submissions;
                    renderProblemSubmissions();
                } else {
                    document.getElementById('problemSubmissionsContent').innerHTML = 
                        '<div style="text-align: center; padding: 2rem; color: #dc3545;">답안을 불러올 수 없습니다.</div>';
                }
            })
            .catch(function(error) {
                console.error('답안 로드 실패:', error);
                document.getElementById('problemSubmissionsContent').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #dc3545;">답안을 불러올 수 없습니다.</div>';
            });
    }

    function loadQuizSubmissions() {
        document.getElementById('quizSubmissionsContent').innerHTML = 
            '<div style="text-align: center; padding: 2rem; color: #6c757d;">퀴즈 답안을 불러오는 중...</div>';
        
        const token = getAuthToken();
        fetch('/api/teacher/quiz-submissions', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    quizSubmissionsData = data.submissions;
                    renderQuizSubmissions();
                } else {
                    document.getElementById('quizSubmissionsContent').innerHTML = 
                        '<div style="text-align: center; padding: 2rem; color: #dc3545;">퀴즈 답안을 불러올 수 없습니다.</div>';
                }
            })
            .catch(function(error) {
                console.error('퀴즈 답안 로드 실패:', error);
                document.getElementById('quizSubmissionsContent').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #dc3545;">퀴즈 답안을 불러올 수 없습니다.</div>';
            });
    }

    function renderProblemSubmissions() {
        var container = document.getElementById('problemSubmissionsContent');
        
        if (submissionsData.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6c757d;">제출된 답안이 없습니다.</div>';
            return;
        }

        var tableHTML = '<table class="submissions-table">' +
            '<thead>' +
                '<tr>' +
                    '<th>학생</th>' +
                    '<th>문제 제목</th>' +
                    '<th>답안</th>' +
                    '<th>제출 시간</th>' +
                    '<th>점수</th>' +
                    '<th>작업</th>' +
                '</tr>' +
            '</thead>' +
            '<tbody>';

        submissionsData.forEach(function(submission) {
            var submittedAt = new Date(submission.submittedAt);
            var scoreClass = getScoreClass(submission.score);
            var scoreText = submission.score !== null ? submission.score + '점' : '미채점';
            
            tableHTML += '<tr>' +
                '<td>' + getStudentName(submission.userId) + '</td>' +
                '<td>' + (submission.problemTitle || '-') + '</td>' +
                '<td class="submission-answer" title="' + (submission.answer || '') + '">' + 
                    (submission.answer ? submission.answer.substring(0, 100) : '-') + 
                    (submission.answer && submission.answer.length > 100 ? '...' : '') + 
                '</td>' +
                '<td class="submission-time">' + submittedAt.toLocaleString('ko-KR') + '</td>' +
                '<td><span class="score-badge ' + scoreClass + '">' + scoreText + '</span></td>' +
                '<td><button class="btn-grade" onclick="openScoreModal(' + submission.id + ')">채점</button></td>' +
            '</tr>';
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    function renderQuizSubmissions() {
        var container = document.getElementById('quizSubmissionsContent');
        
        if (quizSubmissionsData.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6c757d;">제출된 퀴즈 답안이 없습니다.</div>';
            return;
        }

        var tableHTML = '<table class="submissions-table">' +
            '<thead>' +
                '<tr>' +
                    '<th>학생</th>' +
                    '<th>퀴즈 제목</th>' +
                    '<th>학생 답안</th>' +
                    '<th>정답</th>' +
                    '<th>결과</th>' +
                    '<th>제출 시간</th>' +
                '</tr>' +
            '</thead>' +
            '<tbody>';

        quizSubmissionsData.forEach(function(submission) {
            var submittedAt = new Date(submission.submittedAt);
            var resultClass = submission.isCorrect ? 'score-excellent' : 'score-poor';
            var resultText = submission.isCorrect ? '정답' : '오답';
            
            tableHTML += '<tr>' +
                '<td>' + getStudentName(submission.userId) + '</td>' +
                '<td>' + (submission.quizTitle || '-') + '</td>' +
                '<td>' + (submission.userAnswer + 1) + '번</td>' +
                '<td>' + (submission.correctAnswer + 1) + '번</td>' +
                '<td><span class="score-badge ' + resultClass + '">' + resultText + '</span></td>' +
                '<td class="submission-time">' + submittedAt.toLocaleString('ko-KR') + '</td>' +
            '</tr>';
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    function getScoreClass(score) {
        if (score === null) return 'score-ungraded';
        if (score >= 90) return 'score-excellent';
        if (score >= 70) return 'score-good';
        if (score >= 50) return 'score-fair';
        return 'score-poor';
    }

    function openScoreModal(submissionId) {
        var submission = submissionsData.find(function(s) { return s.id === submissionId; });
        if (!submission) return;
        
        currentSubmissionId = submissionId;
        document.getElementById('scoreStudentName').textContent = getStudentName(submission.userId);
        document.getElementById('scoreProblemTitle').textContent = submission.problemTitle || '-';
        document.getElementById('scoreAnswer').textContent = submission.answer || '-';
        document.getElementById('scoreInput').value = submission.score || '';
        document.getElementById('feedbackInput').value = '';
        
        openModal('scoreModal');
    }

    function saveScore() {
        var score = document.getElementById('scoreInput').value;
        var feedback = document.getElementById('feedbackInput').value.trim();
        
        if (!score || score < 0 || score > 100) {
            alert('0-100 사이의 점수를 입력해주세요.');
            return;
        }
        
        const token = getAuthToken();
        fetch('/api/teacher/submissions/' + currentSubmissionId + '/score', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                score: parseInt(score),
                feedback: feedback
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('점수가 저장되었습니다!');
                closeModal('scoreModal');
                loadProblemSubmissions();
            } else {
                alert('점수 저장에 실패했습니다.');
            }
        })
        .catch(function() {
            alert('점수 저장 중 오류가 발생했습니다.');
        });
    }

    function loadNotes() {
        const token = getAuthToken();
        fetch('/api/teacher/notes', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) { 
            console.log('노트 API 응답:', response.status);
            return response.json(); 
        })
        .then(function(data) {
            if (data.success) {
                notesData = data.notes || [];
                renderNotes();
            } else {
                document.getElementById('notesList').innerHTML = 
                    '<div class="empty-notes"><h3>메모를 불러올 수 없습니다</h3><p>서버 연결을 확인해주세요.</p></div>';
            }
        })
        .catch(function(error) {
            console.error('메모 로드 실패:', error);
            document.getElementById('notesList').innerHTML = 
                '<div class="empty-notes"><h3>메모를 불러올 수 없습니다</h3><p>네트워크 연결을 확인해주세요.</p></div>';
        });
    }

    function renderNotes() {
        var container = document.getElementById('notesList');
        var filteredNotes = currentFilter === 'all' ? 
            notesData : 
            notesData.filter(function(note) { return note.category === currentFilter; });
        
        if (filteredNotes.length === 0) {
            var emptyMessage = currentFilter === 'all' ? 
                '작성된 메모가 없습니다.' : 
                currentFilter + ' 카테고리에 메모가 없습니다.';
            
            container.innerHTML = 
                '<div class="empty-notes">' +
                    '<h3>' + emptyMessage + '</h3>' +
                    '<p>새 메모를 작성해보세요!</p>' +
                '</div>';
            return;
        }

        container.innerHTML = filteredNotes.map(function(note) {
            var createdAt = new Date(note.createdAt);
            var timeAgo = getTimeAgo(createdAt);
            
            return 
                '<div class="note-item category-' + note.category + '" onclick="viewNote(' + note.id + ')">' +
                    '<div class="note-header">' +
                        '<h4 class="note-title">' + note.title + '</h4>' +
                        '<span class="note-category category-' + note.category + '">' + note.category + '</span>' +
                    '</div>' +
                    '<div class="note-meta">' + timeAgo + ' 작성</div>' +
                    '<div class="note-content">' + 
                        (note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content) + 
                    '</div>' +
                    '<div class="note-actions">' +
                        '<button class="btn-note-action btn-edit" onclick="editNote(' + note.id + '); event.stopPropagation();">수정</button>' +
                        '<button class="btn-note-action btn-delete" onclick="deleteNote(' + note.id + '); event.stopPropagation();">삭제</button>' +
                    '</div>' +
                '</div>';
        }).join('');
    }

    function getTimeAgo(date) {
        var now = new Date();
        var diff = now - date;
        var minutes = Math.floor(diff / 60000);
        var hours = Math.floor(diff / 3600000);
        var days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return '방금';
        if (minutes < 60) return minutes + '분 전';
        if (hours < 24) return hours + '시간 전';
        if (days < 7) return days + '일 전';
        return date.toLocaleDateString('ko-KR');
    }

    function filterNotes(category) {
        currentFilter = category;
        
        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        renderNotes();
    }

    function openCreateNoteModal() {
        currentNoteId = null;
        document.getElementById('noteTitle').value = '';
        document.getElementById('noteCategory').value = '수업';
        document.getElementById('noteContent').value = '';
        openModal('createNoteModal');
    }

    function saveNote() {
        var title = document.getElementById('noteTitle').value.trim();
        var category = document.getElementById('noteCategory').value;
        var content = document.getElementById('noteContent').value.trim();
        
        if (!title || !content) {
            alert('제목과 내용을 모두 입력해주세요.');
            return;
        }
        
        var noteData = {
            title: title,
            category: category,
            content: content
        };
        
        var url = currentNoteId ? 
            '/api/teacher/notes/' + currentNoteId : 
            '/api/teacher/notes';
        var method = currentNoteId ? 'PUT' : 'POST';
        
        const token = getAuthToken();
        fetch(url, {
            method: method,
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(noteData)
        })
        .then(function(response) { 
            console.log('노트 저장 API 응답:', response.status);
            return response.json(); 
        })
        .then(function(data) {
            if (data.success) {
                alert(currentNoteId ? '메모가 수정되었습니다!' : '메모가 저장되었습니다!');
                closeModal('createNoteModal');
                loadNotes();
            } else {
                alert('메모 저장에 실패했습니다: ' + data.message);
            }
        })
        .catch(function(error) {
            console.error('메모 저장 실패:', error);
            alert('메모 저장 중 오류가 발생했습니다.');
        });
    }

    function viewNote(noteId) {
        var note = notesData.find(function(n) { return n.id === noteId; });
        if (!note) return;
        
        alert('제목: ' + note.title + '\n\n' + note.content);
    }

    function editNote(noteId) {
        var note = notesData.find(function(n) { return n.id === noteId; });
        if (!note) return;
        
        currentNoteId = noteId;
        document.getElementById('noteTitle').value = note.title;
        document.getElementById('noteCategory').value = note.category;
        document.getElementById('noteContent').value = note.content;
        openModal('createNoteModal');
    }

    function deleteNote(noteId) {
        if (!confirm('정말 삭제하시겠습니까?')) return;
        
        const token = getAuthToken();
        fetch('/api/teacher/notes/' + noteId, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('메모가 삭제되었습니다.');
                loadNotes();
            } else {
                alert('메모 삭제에 실패했습니다: ' + data.message);
            }
        })
        .catch(function(error) {
            console.error('메모 삭제 실패:', error);
            alert('메모 삭제 중 오류가 발생했습니다.');
        });
    }

    function previewQuiz() {
        var title = document.getElementById('quizTitle').value.trim();
        var question = document.getElementById('quizQuestion').value.trim();
        var options = [];
        var correctAnswer = null;
        
        var optionInputs = document.querySelectorAll('.option-input');
        var radios = document.querySelectorAll('input[name="correctAnswer"]');
        
        for (var i = 0; i < optionInputs.length; i++) {
            if (optionInputs[i].value.trim()) {
                options.push(optionInputs[i].value.trim());
            }
            if (radios[i].checked) {
                correctAnswer = i;
            }
        }
        
        if (!title || !question || options.length < 2) {
            alert('제목, 문제, 최소 2개 선택지를 입력해주세요.');
            return;
        }
        
        document.getElementById('previewQuestion').textContent = question;
        var optionsHtml = options.map(function(option, index) {
            var isCorrect = index === correctAnswer;
            return (index + 1) + '. ' + option + (isCorrect ? ' ✓' : '');
        }).join('<br>');
        document.getElementById('previewOptions').innerHTML = optionsHtml;
        document.getElementById('quizPreview').style.display = 'block';
    }

    function sendQuizConfirm() {
        var title = document.getElementById('quizTitle').value.trim();
        var question = document.getElementById('quizQuestion').value.trim();
        var options = [];
        var correctAnswer = null;
        
        var optionInputs = document.querySelectorAll('.option-input');
        var radios = document.querySelectorAll('input[name="correctAnswer"]');
        
        for (var i = 0; i < optionInputs.length; i++) {
            if (optionInputs[i].value.trim()) {
                options.push(optionInputs[i].value.trim());
            }
            if (radios[i].checked) {
                correctAnswer = i;
            }
        }
        
        if (!title || !question || options.length < 2) {
            alert('제목, 문제, 최소 2개 선택지를 입력해주세요.');
            return;
        }
        
        if (correctAnswer === null) {
            alert('정답을 선택해주세요.');
            return;
        }

        const token = getAuthToken();
        fetch('/api/teacher/quick-quiz', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                title: title,
                question: question,
                options: options,
                correctAnswer: correctAnswer
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('퀴즈가 성공적으로 시작되었습니다!');
                closeModal('quizModal');
            } else {
                alert('퀴즈 시작에 실패했습니다.');
            }
        })
        .catch(function() {
            alert('퀴즈 시작에 실패했습니다.');
        });
    }

    function sendHintConfirm() {
        var message = document.getElementById('hintMessage').value.trim();
        if (!message) {
            alert('힌트 메시지를 입력해주세요.');
            return;
        }

        const token = getAuthToken();
        fetch('/api/teacher/send-hint', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ studentId: currentStudentId, message: message })
        })
        .then(function() {
            alert('힌트가 전송되었습니다!');
            closeModal('hintModal');
        })
        .catch(function() {
            alert('힌트 전송에 실패했습니다.');
        });
    }

    function sendGlobalHintConfirm() {
        var message = document.getElementById('globalHintMessage').value.trim();
        if (!message) {
            alert('힌트 메시지를 입력해주세요.');
            return;
        }

        const token = getAuthToken();
        fetch('/api/teacher/global-hint', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ message: message })
        })
        .then(function() {
            alert('전체 힌트가 전송되었습니다!');
            closeModal('globalHintModal');
        })
        .catch(function() {
            alert('힌트 전송에 실패했습니다.');
        });
    }

    function createProblemConfirm() {
        var title = document.getElementById('problemTitle').value.trim();
        var description = document.getElementById('problemDescription').value.trim();
        
        if (!title || !description) {
            alert('문제 제목과 설명을 모두 입력해주세요.');
            return;
        }

        const token = getAuthToken();
        fetch('/api/teacher/create-problem', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ title: title, description: description })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('문제가 성공적으로 출제되었습니다!');
                closeModal('createProblemModal');
            } else {
                alert('문제 출제에 실패했습니다.');
            }
        })
        .catch(function() {
            alert('문제 출제에 실패했습니다.');
        });
    }

    function monitorStudent(studentId) {
        window.open('/battle?monitor=' + studentId, '_blank');
    }

    document.addEventListener('change', function(e) {
        if (e.target.name === 'correctAnswer') {
            var optionInputs = document.querySelectorAll('.option-input');
            optionInputs.forEach(function(input) {
                input.classList.remove('correct-option');
            });
            var selectedOption = document.querySelector('.option-input[data-option="' + e.target.value + '"]');
            if (selectedOption) {
                selectedOption.classList.add('correct-option');
            }
        }
    });

    window.onclick = function(event) {
        var modals = document.querySelectorAll('.modal');
        for (var i = 0; i < modals.length; i++) {
            if (event.target === modals[i]) {
                modals[i].style.display = 'none';
            }
        }
    }

    checkTeacherAuth();
    loadUserNames();
    connect();
    refreshData();
    setInterval(refreshData, 10000);
    setInterval(loadUserNames, 30000);
    </script>
</body>
</html>