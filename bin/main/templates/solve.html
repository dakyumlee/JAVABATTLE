<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문제 풀이 - Java Battle Arena</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Pretendard', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: #1a1a1a;
            padding: 1rem 2rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .back-btn:hover { background: #5a6268; }
        
        .problem-title {
            color: #3498db;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-hint {
            background: #8e44ad;
            color: white;
        }
        
        .btn-hint:hover { background: #7d3c98; }
        
        .btn-submit {
            background: #27ae60;
            color: white;
        }
        
        .btn-submit:hover { background: #229954; }
        
        .main-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: #333;
            overflow: hidden;
        }
        
        .left-panel, .right-panel {
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            background: #1a1a1a;
            padding: 1rem;
            border-bottom: 1px solid #333;
            font-weight: 600;
            color: #3498db;
        }
        
        .problem-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            line-height: 1.6;
        }
        
        .problem-description {
            margin-bottom: 1.5rem;
            color: #e0e0e0;
            white-space: pre-line;
        }
        
        .sample-section {
            margin-bottom: 1.5rem;
        }
        
        .sample-title {
            font-weight: 600;
            color: #3498db;
            margin-bottom: 0.5rem;
        }
        
        .sample-content {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            color: #e0e0e0;
        }
        
        .code-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #editor-container {
            flex: 1;
            min-height: 0;
        }
        
        .ai-feedback-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .ai-feedback-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .score-display {
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .creative-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .feedback-section {
            margin-bottom: 1rem;
        }

        .feedback-content {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1rem;
            backdrop-filter: blur(10px);
        }

        .strengths-list, .improvements-list {
            list-style: none;
            padding: 0;
        }

        .strengths-list li {
            padding: 0.5rem 0;
            position: relative;
            padding-left: 1.5rem;
        }

        .strengths-list li::before {
            content: "✅";
            position: absolute;
            left: 0;
        }

        .improvements-list li {
            padding: 0.5rem 0;
            position: relative;
            padding-left: 1.5rem;
        }

        .improvements-list li::before {
            content: "💡";
            position: absolute;
            left: 0;
        }

        .loading-ai {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            background: #1a1a1a;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hint-level {
            background: #2d2d2d;
            color: #8e44ad;
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            margin-left: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
            
            .header { padding: 1rem; }
            .header-left, .header-right { gap: 0.5rem; }
            .btn { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="/practice" class="back-btn">← 뒤로</a>
            <h1 class="problem-title" id="problemTitle">문제를 불러오는 중...</h1>
        </div>
        <div class="header-right">
            <button class="btn btn-hint" onclick="showHint()">
                힌트 <span class="hint-level" id="hintLevel">0/3</span>
            </button>
            <button class="btn btn-submit" onclick="submitCode()">AI 평가 제출</button>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="panel-header">문제</div>
            <div class="problem-content">
                <div class="problem-description" id="problemDescription">
                    문제 설명을 불러오는 중...
                </div>
                
                <div class="sample-section" id="sampleInputSection" style="display: none;">
                    <div class="sample-title">입력 예제</div>
                    <div class="sample-content" id="sampleInput"></div>
                </div>
                
                <div class="sample-section" id="sampleOutputSection" style="display: none;">
                    <div class="sample-title">출력 예제</div>
                    <div class="sample-content" id="sampleOutput"></div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-header">코드 작성 & AI 평가</div>
            <div class="code-container">
                <div id="editor-container"></div>
                
                <!-- AI 로딩 상태 -->
                <div id="aiLoadingState" class="loading-ai" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>🤖 AI가 당신의 코드를 분석하고 있어요...</span>
                </div>

                <!-- AI 피드백 결과 -->
                <div id="aiFeedbackResult" class="ai-feedback-container" style="display: none;">
                    <div class="ai-feedback-header">
                        <span>🤖 AI 코드 분석 결과</span>
                        <span id="creativeBadge" class="creative-badge" style="display: none;">🎨 창의적 해결!</span>
                    </div>

                    <div class="score-display">
                        <span>점수:</span>
                        <span id="aiScore">95</span>
                        <span>/100</span>
                    </div>

                    <div class="feedback-section">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">📝 종합 평가</div>
                        <div class="feedback-content" id="aiFeedbackText"></div>
                    </div>

                    <div class="feedback-section" id="strengthsSection" style="display: none;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">✨ 잘한 점</div>
                        <div class="feedback-content">
                            <ul id="strengthsList" class="strengths-list">
                            </ul>
                        </div>
                    </div>

                    <div class="feedback-section" id="improvementsSection" style="display: none;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">🚀 개선할 점</div>
                        <div class="feedback-content">
                            <ul id="improvementsList" class="improvements-list">
                            </ul>
                        </div>
                    </div>

                    <div style="font-size: 0.8rem; opacity: 0.8; text-align: right; margin-top: 1rem;">
                        ⏱️ 평가 시간: <span id="evaluationTime">2.3초</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let editor;
        let currentProblem = null;
        let fullSolution = '';
        let hintLevel = 0;

        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: '',
                language: 'java',
                theme: 'vs-dark',
                fontSize: 14,
                automaticLayout: true,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                wordWrap: 'on'
            });
        });

        function createStarterTemplate(fullCode, category) {
            fullSolution = fullCode;
            
            if (category.includes('Java')) {
                return fullCode
                    .replace(/(System\.out\.println\([^)]*\);)/g, '// 여기에 출력문을 작성하세요')
                    .replace(/(public\s+static\s+void\s+main[^{]*\{)([\s\S]*?)(\})/g, function(match, start, content, end) {
                        if (content.includes('여기에 출력문을 작성하세요')) {
                            return start + content + end;
                        }
                        return start + '\n        // 여기에 코드를 작성하세요\n    ' + end;
                    });
            }
            
            if (category === 'DB/SQL') {
                return fullCode;
            }
            
            return fullCode;
        }

        function showHint() {
            if (!fullSolution) return;
            
            hintLevel++;
            if (hintLevel > 3) {
                hintLevel = 0;
                editor.setValue(createStarterTemplate(fullSolution, currentProblem.category));
                document.getElementById('hintLevel').textContent = '0/3';
                return;
            }
            
            let hintCode = '';
            const category = currentProblem.category;
            
            if (hintLevel === 1) {
                hintCode = addHint1(fullSolution, category);
            } else if (hintLevel === 2) {
                hintCode = addHint2(fullSolution, category);
            } else if (hintLevel === 3) {
                hintCode = fullSolution;
            }
            
            editor.setValue(hintCode);
            document.getElementById('hintLevel').textContent = `${hintLevel}/3`;
        }

        function addHint1(fullCode, category) {
            if (category.includes('Java')) {
                return fullCode
                    .replace(/\/\/ 여기에 출력문을 작성하세요/g, '// 힌트: System.out.println("Hello World");')
                    .replace(/\/\/ 여기에 코드를 작성하세요/g, '// 힌트: 변수 선언이나 연산을 해보세요');
            }
            
            if (category === 'DB/SQL') {
                return fullCode
                    .replace(/FROM\s+\w+/gi, function(match) {
                        return match + ' -- 힌트: 테이블명 확인';
                    });
            }
            
            return fullCode;
        }

        function addHint2(fullCode, category) {
            if (category.includes('Java')) {
                return fullCode
                    .replace(/\/\/ 힌트: System\.out\.println\("Hello World"\);/g, function(match) {
                        return Math.random() > 0.3 ? 'System.out.println("Hello World");' : match;
                    });
            }
            
            return fullCode;
        }

        async function loadProblem() {
            const pathParts = window.location.pathname.split('/');
            const problemId = pathParts[pathParts.length - 1];

            try {
                const response = await fetch(`/practice/api/problems/${problemId}`);
                
                if (!response.ok) {
                    throw new Error('문제를 찾을 수 없습니다.');
                }

                currentProblem = await response.json();
                displayProblem(currentProblem);
                
            } catch (error) {
                console.error('문제 로딩 실패:', error);
                document.getElementById('problemTitle').textContent = '오류 발생';
                document.getElementById('problemDescription').textContent = error.message;
            }
        }

        function displayProblem(problem) {
            document.getElementById('problemTitle').textContent = problem.title;
            document.getElementById('problemDescription').textContent = problem.description;

            if (problem.sampleInput) {
                document.getElementById('sampleInput').textContent = problem.sampleInput;
                document.getElementById('sampleInputSection').style.display = 'block';
            }

            if (problem.sampleOutput) {
                document.getElementById('sampleOutput').textContent = problem.sampleOutput;
                document.getElementById('sampleOutputSection').style.display = 'block';
            }

            if (problem.solutionTemplate) {
                const starterCode = createStarterTemplate(problem.solutionTemplate, problem.category);
                
                if (editor) {
                    const language = getLanguageFromCategory(problem.category);
                    if (typeof monaco !== 'undefined') {
                        monaco.editor.setModelLanguage(editor.getModel(), language);
                    }
                    editor.setValue(starterCode);
                } else {
                    setTimeout(() => {
                        if (editor && typeof monaco !== 'undefined') {
                            const language = getLanguageFromCategory(problem.category);
                            monaco.editor.setModelLanguage(editor.getModel(), language);
                            editor.setValue(starterCode);
                        }
                    }, 1000);
                }
            }

            document.title = `${problem.title} - Java Battle Arena`;
        }

        function getLanguageFromCategory(category) {
            if (category === 'HTML 기초') return 'html';
            if (category === 'CSS 기초') return 'css';
            if (category === 'JavaScript 기초') return 'javascript';
            if (category === 'DB/SQL') return 'sql';
            if (category.includes('Java')) return 'java';
            return 'java';
        }

        async function submitCode() {
            if (!editor || !currentProblem) {
                alert('문제가 로드되지 않았습니다.');
                return;
            }

            const code = editor.getValue();
            const problemId = currentProblem.problemId;
            
            showAILoading();

            try {
                const startTime = Date.now();
                
                const response = await fetch(`/practice/submit/${problemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ answer: code })
                });

                const result = await response.json();
                const evaluationTime = ((Date.now() - startTime) / 1000).toFixed(1);
                
                if (response.ok) {
                    showAIFeedback(result, evaluationTime);
                } else {
                    showAIError();
                }
                
            } catch (error) {
                console.error('AI 평가 오류:', error);
                showAIError();
            }
        }

        function showAILoading() {
            document.getElementById('aiLoadingState').style.display = 'flex';
            document.getElementById('aiFeedbackResult').style.display = 'none';
        }

        function showAIFeedback(result, evaluationTime) {
            document.getElementById('aiLoadingState').style.display = 'none';
            document.getElementById('aiFeedbackResult').style.display = 'block';

            document.getElementById('aiScore').textContent = result.score;
            
            if (result.isCreative) {
                document.getElementById('creativeBadge').style.display = 'inline-block';
            }

            document.getElementById('aiFeedbackText').textContent = result.feedback;

            if (result.strengths && result.strengths.length > 0) {
                const strengthsList = document.getElementById('strengthsList');
                strengthsList.innerHTML = '';
                result.strengths.forEach(strength => {
                    const li = document.createElement('li');
                    li.textContent = strength;
                    strengthsList.appendChild(li);
                });
                document.getElementById('strengthsSection').style.display = 'block';
            }

            if (result.improvements && result.improvements.length > 0) {
                const improvementsList = document.getElementById('improvementsList');
                improvementsList.innerHTML = '';
                result.improvements.forEach(improvement => {
                    const li = document.createElement('li');
                    li.textContent = improvement;
                    improvementsList.appendChild(li);
                });
                document.getElementById('improvementsSection').style.display = 'block';
            }

            document.getElementById('evaluationTime').textContent = `${evaluationTime}초`;

            const container = document.getElementById('aiFeedbackResult');
            if (result.score >= 90) {
                container.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            } else if (result.score >= 70) {
                container.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            } else {
                container.style.background = 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)';
                container.style.color = '#333';
            }
        }

        function showAIError() {
            document.getElementById('aiLoadingState').style.display = 'none';
            document.getElementById('aiFeedbackResult').style.display = 'none';
            alert('AI 평가 중 오류가 발생했습니다. 다시 시도해주세요.');
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadProblem();
        });
    </script>
</body>
</html>