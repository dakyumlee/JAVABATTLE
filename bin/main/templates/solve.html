<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문제 풀이 - Java Battle Arena</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Pretendard', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: #1a1a1a;
            padding: 1rem 2rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .back-btn:hover { background: #5a6268; }
        
        .problem-title {
            color: #3498db;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-hint {
            background: #8e44ad;
            color: white;
        }
        
        .btn-hint:hover { background: #7d3c98; }
        
        .btn-run {
            background: #f39c12;
            color: white;
        }
        
        .btn-run:hover { background: #e67e22; }
        
        .btn-submit {
            background: #27ae60;
            color: white;
        }
        
        .btn-submit:hover { background: #229954; }
        
        .main-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: #333;
            overflow: hidden;
        }
        
        .left-panel, .right-panel {
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            background: #1a1a1a;
            padding: 1rem;
            border-bottom: 1px solid #333;
            font-weight: 600;
            color: #3498db;
        }
        
        .problem-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            line-height: 1.6;
        }
        
        .problem-description {
            margin-bottom: 1.5rem;
            color: #e0e0e0;
            white-space: pre-line;
        }
        
        .sample-section {
            margin-bottom: 1.5rem;
        }
        
        .sample-title {
            font-weight: 600;
            color: #3498db;
            margin-bottom: 0.5rem;
        }
        
        .sample-content {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            color: #e0e0e0;
        }
        
        .table-schema {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #e67e22;
            margin-bottom: 1rem;
        }
        
        .table-schema h4 {
            color: #e67e22;
            margin-bottom: 0.5rem;
        }
        
        .code-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #editor-container {
            flex: 1;
            min-height: 0;
        }
        
        .output-container {
            background: #1a1a1a;
            border-top: 1px solid #333;
            height: 200px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .output-header {
            padding: 0.75rem 1rem;
            background: #2d2d2d;
            font-weight: 600;
            color: #3498db;
            font-size: 0.9rem;
        }
        
        .output-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            color: #e0e0e0;
            background: #0f0f0f;
        }
        
        .loading { color: #f39c12; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }

        .hint-level {
            background: #2d2d2d;
            color: #8e44ad;
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            margin-left: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
            
            .header { padding: 1rem; }
            .header-left, .header-right { gap: 0.5rem; }
            .btn { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="/practice" class="back-btn">← 뒤로</a>
            <h1 class="problem-title" id="problemTitle">문제를 불러오는 중...</h1>
        </div>
        <div class="header-right">
            <button class="btn btn-hint" onclick="showHint()">
                힌트 <span class="hint-level" id="hintLevel">0/3</span>
            </button>
            <button class="btn btn-run" onclick="runCode()">실행</button>
            <button class="btn btn-submit" onclick="submitCode()">제출</button>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="panel-header">문제</div>
            <div class="problem-content">
                <div class="problem-description" id="problemDescription">
                    문제 설명을 불러오는 중...
                </div>
                
                <div id="tableSchema" style="display: none;"></div>
                
                <div class="sample-section" id="sampleInputSection" style="display: none;">
                    <div class="sample-title">입력 예제</div>
                    <div class="sample-content" id="sampleInput"></div>
                </div>
                
                <div class="sample-section" id="sampleOutputSection" style="display: none;">
                    <div class="sample-title">출력 예제</div>
                    <div class="sample-content" id="sampleOutput"></div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-header">코드 작성</div>
            <div class="code-container">
                <div id="editor-container"></div>
                <div class="output-container">
                    <div class="output-header">실행 결과</div>
                    <div class="output-content" id="output">여기에 실행 결과가 표시됩니다.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let editor;
        let currentProblem = null;
        let fullSolution = '';
        let hintLevel = 0;

        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: '',
                language: 'sql',
                theme: 'vs-dark',
                fontSize: 14,
                automaticLayout: true,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                wordWrap: 'on'
            });
        });

        function createStarterTemplate(fullCode, category) {
            fullSolution = fullCode;
            
            if (category === 'HTML 기초') {
                return fullCode
                    .replace(/<input[^>]*>/g, '<!-- 여기에 input 태그를 작성하세요 -->')
                    .replace(/(<label[^>]*>)([^<]+)(<\/label>)/g, '$1<!-- 라벨 텍스트 -->$3')
                    .replace(/(<button[^>]*>)([^<]+)(<\/button>)/g, '$1<!-- 버튼 텍스트 -->$3')
                    .replace(/action="[^"]*"/g, 'action=""')
                    .replace(/method="[^"]*"/g, 'method=""');
            }
            
            if (category === 'CSS 기초') {
                return fullCode
                    .replace(/\{[^}]*\}/g, '{\n    /* 여기에 CSS 속성을 작성하세요 */\n}');
            }
            
            if (category === 'JavaScript 기초') {
                return fullCode
                    .replace(/(function[^{]*\{)([\s\S]*?)(\})/g, '$1\n    // 여기에 함수 내용을 작성하세요\n$3')
                    .replace(/(console\.log\([^)]*\);)/g, '// 여기에 출력문을 작성하세요')
                    .replace(/(document\.[^;]+;)/g, '// 여기에 DOM 조작 코드를 작성하세요');
            }
            
            if (category === 'DB/SQL') {
                return fullCode;
            }
            
            if (category.includes('Java')) {
                return fullCode
                    .replace(/(System\.out\.println\([^)]*\);)/g, '// 여기에 출력문을 작성하세요')
                    .replace(/(public\s+static\s+void\s+main[^{]*\{)([\s\S]*?)(\})/g, function(match, start, content, end) {
                        if (content.includes('여기에 출력문을 작성하세요')) {
                            return start + content + end;
                        }
                        return start + '\n        // 여기에 코드를 작성하세요\n    ' + end;
                    });
            }
            
            return fullCode;
        }

        function showHint() {
            if (!fullSolution) return;
            
            hintLevel++;
            if (hintLevel > 3) {
                hintLevel = 0;
                editor.setValue(createStarterTemplate(fullSolution, currentProblem.category));
                document.getElementById('hintLevel').textContent = '0/3';
                return;
            }
            
            let hintCode = '';
            const category = currentProblem.category;
            
            if (hintLevel === 1) {
                hintCode = addHint1(fullSolution, category);
            } else if (hintLevel === 2) {
                hintCode = addHint2(fullSolution, category);
            } else if (hintLevel === 3) {
                hintCode = fullSolution;
            }
            
            editor.setValue(hintCode);
            document.getElementById('hintLevel').textContent = `${hintLevel}/3`;
        }

        function addHint1(fullCode, category) {
            if (category === 'HTML 기초') {
                return fullCode
                    .replace(/action=""/g, 'action="<!-- 힌트: /login -->"')
                    .replace(/method=""/g, 'method="<!-- 힌트: post -->"')
                    .replace(/<!-- 여기에 input 태그를 작성하세요 -->/g, '<!-- 힌트: <input type="text" name="username" required> -->');
            }
            
            if (category === 'CSS 기초') {
                return fullCode
                    .replace(/\/\* 여기에 CSS 속성을 작성하세요 \*\//g, '/* 힌트: background-color, padding, margin 등 */');
            }
            
            if (category === 'JavaScript 기초') {
                return fullCode
                    .replace(/\/\/ 여기에 출력문을 작성하세요/g, '// 힌트: console.log("Hello!");')
                    .replace(/\/\/ 여기에 DOM 조작 코드를 작성하세요/g, '// 힌트: document.getElementById("id")');
            }
            
            if (category === 'DB/SQL') {
                return fullCode
                    .replace(/FROM -- 테이블명 작성/gi, 'FROM employees -- 힌트: employees 테이블')
                    .replace(/WHERE -- 조건 작성/gi, 'WHERE -- 힌트: salary > 60000')
                    .replace(/GROUP BY -- 그룹핑 조건/gi, 'GROUP BY -- 힌트: department_id')
                    .replace(/ORDER BY -- 정렬 조건/gi, 'ORDER BY -- 힌트: salary DESC');
            }
            
            if (category.includes('Java')) {
                return fullCode
                    .replace(/\/\/ 여기에 출력문을 작성하세요/g, '// 힌트: System.out.println("Hello World");')
                    .replace(/\/\/ 여기에 코드를 작성하세요/g, '// 힌트: 변수 선언이나 연산을 해보세요');
            }
            
            return fullCode;
        }

        function addHint2(fullCode, category) {
            if (category === 'HTML 기초') {
                return fullCode
                    .replace(/action="<!-- 힌트: \/login -->"/g, 'action="/login"')
                    .replace(/method="<!-- 힌트: post -->"/g, 'method="post"')
                    .replace(/<!-- 힌트: <input type="text" name="username" required> -->/g, function(match) {
                        return Math.random() > 0.5 ? '<input type="text" name="username" required>' : match;
                    });
            }
            
            if (category === 'CSS 기초') {
                return fullCode.replace(/\/\* 힌트: background-color, padding, margin 등 \*\//g, function() {
                    const hints = ['background-color: #f0f0f0;', 'padding: 10px;', 'margin: 5px;'];
                    return hints[Math.floor(Math.random() * hints.length)];
                });
            }
            
            if (category === 'DB/SQL') {
                return fullCode
                    .replace(/FROM employees -- 힌트: employees 테이블/gi, 'FROM employees')
                    .replace(/WHERE -- 힌트: salary > 60000/gi, function() {
                        return Math.random() > 0.5 ? 'WHERE salary > 60000' : 'WHERE -- 조건을 완성하세요';
                    });
            }
            
            if (category.includes('Java')) {
                return fullCode
                    .replace(/\/\/ 힌트: System\.out\.println\("Hello World"\);/g, function(match) {
                        return Math.random() > 0.3 ? 'System.out.println("Hello World");' : match;
                    });
            }
            
            return fullCode;
        }

        async function loadProblem() {
            const pathParts = window.location.pathname.split('/');
            const problemId = pathParts[pathParts.length - 1];

            try {
                const response = await fetch(`/practice/api/problems/${problemId}`);
                
                if (!response.ok) {
                    throw new Error('문제를 찾을 수 없습니다.');
                }

                currentProblem = await response.json();
                displayProblem(currentProblem);
                
            } catch (error) {
                console.error('문제 로딩 실패:', error);
                document.getElementById('problemTitle').textContent = '오류 발생';
                document.getElementById('problemDescription').textContent = error.message;
            }
        }

        function displayProblem(problem) {
            document.getElementById('problemTitle').textContent = problem.title;
            document.getElementById('problemDescription').textContent = problem.description;

            if (problem.category === 'DB/SQL') {
                showTableSchema(problem.description);
            }

            if (problem.sampleInput) {
                document.getElementById('sampleInput').textContent = problem.sampleInput;
                document.getElementById('sampleInputSection').style.display = 'block';
            }

            if (problem.sampleOutput) {
                document.getElementById('sampleOutput').textContent = problem.sampleOutput;
                document.getElementById('sampleOutputSection').style.display = 'block';
            }

            if (problem.solutionTemplate) {
                const starterCode = createStarterTemplate(problem.solutionTemplate, problem.category);
                
                if (editor) {
                    const language = getLanguageFromCategory(problem.category);
                    if (typeof monaco !== 'undefined') {
                        monaco.editor.setModelLanguage(editor.getModel(), language);
                    }
                    editor.setValue(starterCode);
                } else {
                    setTimeout(() => {
                        if (editor && typeof monaco !== 'undefined') {
                            const language = getLanguageFromCategory(problem.category);
                            monaco.editor.setModelLanguage(editor.getModel(), language);
                            editor.setValue(starterCode);
                        }
                    }, 1000);
                }
            }

            document.title = `${problem.title} - Java Battle Arena`;
        }

        function showTableSchema(description) {
            const schemaMatches = description.match(/\w+\([^)]+\)/g);
            if (schemaMatches) {
                const schemaDiv = document.getElementById('tableSchema');
                schemaDiv.innerHTML = '<div class="table-schema"><h4>테이블 구조</h4></div>';
                
                schemaMatches.forEach(schema => {
                    const schemaElement = document.createElement('div');
                    schemaElement.style.fontFamily = 'Consolas, Monaco, monospace';
                    schemaElement.style.fontSize = '0.9rem';
                    schemaElement.style.color = '#e0e0e0';
                    schemaElement.style.marginBottom = '0.5rem';
                    schemaElement.textContent = schema;
                    schemaDiv.firstChild.appendChild(schemaElement);
                });
                
                schemaDiv.style.display = 'block';
            }
        }

        function getLanguageFromCategory(category) {
            if (category === 'HTML 기초') return 'html';
            if (category === 'CSS 기초') return 'css';
            if (category === 'JavaScript 기초') return 'javascript';
            if (category === 'DB/SQL') return 'sql';
            if (category.includes('Java')) return 'java';
            return 'java';
        }

        async function runCode() {
            if (!editor) {
                alert('코드 에디터가 준비되지 않았습니다.');
                return;
            }

            const code = editor.getValue();
            const output = document.getElementById('output');
            
            output.innerHTML = '<div class="loading">코드를 실행하는 중...</div>';

            try {
                const response = await fetch('/api/code/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                    },
                    body: JSON.stringify({ 
                        code: code,
                        category: currentProblem?.category || '',
                        input: currentProblem?.sampleInput || ''
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    output.innerHTML = `<div class="success">실행 성공!</div><pre>${result.output || '(출력 없음)'}</pre>`;
                } else {
                    output.innerHTML = `<div class="error">실행 실패</div><pre>${result.error || '알 수 없는 오류가 발생했습니다.'}</pre>`;
                }

            } catch (error) {
                console.error('코드 실행 실패:', error);
                output.innerHTML = `<div class="error">네트워크 오류</div><pre>서버와 통신할 수 없습니다.</pre>`;
            }
        }

        async function submitCode() {
            if (!editor || !currentProblem) {
                alert('문제가 로드되지 않았습니다.');
                return;
            }

            const code = editor.getValue();
            const output = document.getElementById('output');
            
            output.innerHTML = '<div class="loading">제출하는 중...</div>';

            try {
                const response = await fetch('/api/code/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                    },
                    body: JSON.stringify({ 
                        problemId: currentProblem.problemId,
                        code: code,
                        category: currentProblem.category
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    output.innerHTML = `<div class="success">정답입니다!</div><pre>축하합니다. 문제를 해결했습니다.</pre>`;
                } else {
                    output.innerHTML = `<div class="error">틀렸습니다</div><pre>${result.message || '다시 시도해보세요.'}</pre>`;
                }

            } catch (error) {
                console.error('제출 실패:', error);
                output.innerHTML = `<div class="error">네트워크 오류</div><pre>서버와 통신할 수 없습니다.</pre>`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadProblem();
        });
    </script>
</body>
</html>