<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì½”ë”© ì—°ìŠµ - Java Battle Arena</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Pretendard', sans-serif;
          background: #0a0a0a;
          color: #ffffff;
          min-height: 100vh;
      }

      .header {
          background: #1a1a1a;
          padding: 1rem 2rem;
          border-bottom: 1px solid #333;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .logo {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 1.2rem;
          font-weight: 600;
          color: #3498db;
      }

      .back-btn {
          background: #6c757d;
          color: white;
          padding: 0.5rem 1rem;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          text-decoration: none;
          transition: background-color 0.2s ease;
      }

      .back-btn:hover {
          background: #5a6268;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 2rem;
      }

      .shared-materials-section {
          margin-bottom: 3rem;
          background: #1a1a1a;
          border-radius: 16px;
          padding: 2rem;
          border: 1px solid #333;
      }

      .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
      }

      .section-title {
          color: #3498db;
          font-size: 1.5rem;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .material-notification {
          background: #e74c3c;
          color: white;
          padding: 0.5rem 1rem;
          border-radius: 20px;
          font-size: 0.9rem;
          font-weight: 600;
          animation: pulse 2s infinite;
          display: none;
      }

      @keyframes pulse {
          0% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.7; transform: scale(1.05); }
          100% { opacity: 1; transform: scale(1); }
      }

      .materials-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
          gap: 1.5rem;
          margin-bottom: 1rem;
      }

      .material-card {
          background: #2d2d2d;
          border: 1px solid #333;
          border-radius: 12px;
          padding: 1.5rem;
          transition: all 0.3s ease;
          cursor: pointer;
          position: relative;
          overflow: hidden;
      }

      .material-card:hover {
          border-color: #3498db;
          transform: translateY(-3px);
          box-shadow: 0 8px 20px rgba(52, 152, 219, 0.2);
      }

      .material-card.new {
          border-color: #e74c3c;
          box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
      }

      .material-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 1rem;
      }

      .material-title {
          font-size: 1.1rem;
          font-weight: 600;
          color: #3498db;
          margin-bottom: 0.5rem;
      }

      .material-category {
          background: #3498db;
          color: white;
          padding: 0.25rem 0.75rem;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 500;
      }

      .material-description {
          color: #95a5a6;
          margin-bottom: 1rem;
          line-height: 1.5;
          font-size: 0.9rem;
      }

      .material-meta {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
      }

      .material-type {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          color: #95a5a6;
          font-size: 0.9rem;
      }

      .material-date {
          color: #6c757d;
          font-size: 0.8rem;
      }

      .material-actions {
          display: flex;
          gap: 0.5rem;
      }

      .action-btn {
          background: #3498db;
          color: white;
          border: none;
          padding: 0.5rem 1rem;
          border-radius: 6px;
          cursor: pointer;
          font-size: 0.9rem;
          transition: background-color 0.2s ease;
      }

      .action-btn:hover {
          background: #2980b9;
      }

      .action-btn.secondary {
          background: #6c757d;
      }

      .action-btn.secondary:hover {
          background: #5a6268;
      }

      .no-materials {
          text-align: center;
          padding: 3rem 2rem;
          background: #2d2d2d;
          border-radius: 12px;
          color: #95a5a6;
          border: 2px dashed #333;
      }

      .no-materials-icon {
          font-size: 3rem;
          margin-bottom: 1rem;
          opacity: 0.5;
      }

      .curriculum-tabs {
          display: flex;
          gap: 0.5rem;
          margin-bottom: 2rem;
          overflow-x: auto;
          padding-bottom: 0.5rem;
      }

      .tab {
          padding: 0.75rem 1.5rem;
          background: #2d2d2d;
          border: 1px solid #333;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s ease;
          white-space: nowrap;
          font-size: 0.9rem;
      }

      .tab.active {
          background: #3498db;
          border-color: #3498db;
      }

      .tab:hover:not(.active) {
          background: #3d3d3d;
      }

      .chapter-title {
          color: #3498db;
          font-size: 1.3rem;
          font-weight: 600;
          margin-bottom: 1.5rem;
          border-bottom: 2px solid #3498db;
          padding-bottom: 0.5rem;
      }

      .problems-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
          gap: 1.5rem;
      }

      .problem-card {
          background: #1a1a1a;
          border: 1px solid #333;
          border-radius: 12px;
          padding: 1.5rem;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .problem-card:hover {
          border-color: #3498db;
          transform: translateY(-3px);
          box-shadow: 0 8px 20px rgba(52, 152, 219, 0.2);
      }

      .problem-title {
          font-size: 1.2rem;
          font-weight: 600;
          margin-bottom: 0.5rem;
          color: #3498db;
      }

      .problem-description {
          color: #95a5a6;
          margin-bottom: 1rem;
          line-height: 1.5;
          font-size: 0.95rem;
      }

      .problem-meta {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .difficulty {
          padding: 0.25rem 0.75rem;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 500;
      }

      .difficulty.very-easy {
          background: linear-gradient(135deg, #2ecc71, #27ae60);
          color: white;
      }

      .difficulty.easy {
          background: linear-gradient(135deg, #3498db, #2980b9);
          color: white;
      }

      .difficulty.medium {
          background: linear-gradient(135deg, #f39c12, #e67e22);
          color: white;
      }

      .difficulty.hard {
          background: linear-gradient(135deg, #e74c3c, #c0392b);
          color: white;
      }

      .difficulty.very-hard {
          background: linear-gradient(135deg, #8e44ad, #732d91);
          color: white;
      }

      .solve-count {
          color: #95a5a6;
          font-size: 0.9rem;
      }

      @media (max-width: 768px) {
          .container {
              padding: 1rem;
          }
          
          .problems-grid, .materials-grid {
              grid-template-columns: 1fr;
          }
          
          .curriculum-tabs {
              gap: 0.25rem;
          }
          
          .tab {
              padding: 0.5rem 1rem;
              font-size: 0.8rem;
          }

          .section-header {
              flex-direction: column;
              align-items: flex-start;
              gap: 1rem;
          }

          .material-header {
              flex-direction: column;
              align-items: flex-start;
              gap: 0.5rem;
          }

          .material-actions {
              width: 100%;
              justify-content: stretch;
          }

          .action-btn {
              flex: 1;
          }
      }
  </style>
</head>
<body>
  <div class="header">
      <div class="logo">
          ğŸ’» ì½”ë”© ì—°ìŠµ
      </div>
      <a href="/" class="back-btn">â† í™ˆìœ¼ë¡œ</a>
  </div>

  <div class="container">
      <div class="shared-materials-section">
          <div class="section-header">
              <h2 class="section-title">
                  ğŸ“š ê³µìœ ëœ í•™ìŠµìë£Œ
              </h2>
              <div class="material-notification" id="materialNotification">
                  ìƒˆ ìë£Œ ë„ì°©!
              </div>
          </div>
          
          <div class="materials-grid" id="sharedMaterialsGrid">
          </div>
          
          <div class="no-materials" id="noMaterials">
              <div class="no-materials-icon">ğŸ“„</div>
              <p><strong>ì•„ì§ ê³µìœ ëœ í•™ìŠµìë£Œê°€ ì—†ìŠµë‹ˆë‹¤</strong></p>
              <p>ê°•ì‚¬ë‹˜ì´ ìë£Œë¥¼ ê³µìœ í•˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤</p>
          </div>
      </div>

      <div class="curriculum-tabs">
      </div>

      <div id="chapterTitle" class="chapter-title">ë¡œë”© ì¤‘...</div>

      <div class="problems-grid" id="problemsGrid">
      </div>
  </div>

   <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
   <script src="/js/student-activity.js"></script>

<script>
   let allCategories = [];
   let categoryProblems = {};
   let sharedMaterials = [];
   let stompClient = null;
   let connected = false;

   function getAuthToken() {
       return localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
   }

   function getCurrentUserId() {
       const token = getAuthToken();
       if (!token) return null;
       
       try {
           const payload = JSON.parse(atob(token.split('.')[1]));
           return payload.userId || payload.id;
       } catch (e) {
           console.error('í† í° íŒŒì‹± ì˜¤ë¥˜:', e);
           return null;
       }
   }

   function connectWebSocket() {
       const token = getAuthToken();
       if (!token) {
           console.log('í† í°ì´ ì—†ì–´ì„œ WebSocket ì—°ê²° ë¶ˆê°€');
           return;
       }

       const socket = new SockJS('/ws');
       stompClient = Stomp.over(socket);
       
       stompClient.debug = function(str) {
           console.log('STOMP Debug: ' + str);
       };
       
       stompClient.connect({}, function(frame) {
           console.log('practice.html WebSocket ì—°ê²° ì„±ê³µ:', frame);
           connected = true;
           
           stompClient.subscribe('/topic/students', function(message) {
               console.log('practice.htmlì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ :', message.body);
               try {
                   const notification = JSON.parse(message.body);
                   if (notification.type === 'material_shared') {
                       handleNewMaterial(notification);
                   }
               } catch (e) {
                   console.error('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
               }
           });
           
           const userId = getCurrentUserId();
           if (userId) {
               stompClient.subscribe(`/user/queue/materials`, function(message) {
                   console.log('ê°œì¸ ìë£Œ ì•Œë¦¼ ìˆ˜ì‹ :', message.body);
                   try {
                       const notification = JSON.parse(message.body);
                       if (notification.type === 'material_shared') {
                           handleNewMaterial(notification);
                       }
                   } catch (e) {
                       console.error('ê°œì¸ ì•Œë¦¼ íŒŒì‹± ì˜¤ë¥˜:', e);
                   }
               });
           }
           
       }, function(error) {
           console.error('practice.html WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
           connected = false;
           
           setTimeout(() => {
               if (!connected) {
                   console.log('WebSocket ì¬ì—°ê²° ì‹œë„...');
                   connectWebSocket();
               }
           }, 3000);
       });
   }

   function handleNewMaterial(notification) {
       console.log('ìƒˆ ìë£Œ ì²˜ë¦¬:', notification);
       
       const materialNotification = document.getElementById('materialNotification');
       if (materialNotification) {
           materialNotification.style.display = 'block';
           materialNotification.textContent = notification.message || 'ìƒˆ ìë£Œê°€ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!';
           
           materialNotification.style.animation = 'pulse 2s infinite';
           
           setTimeout(() => {
               materialNotification.style.display = 'none';
               materialNotification.style.animation = '';
           }, 8000);
       }
       
       if (Notification.permission === 'granted') {
           new Notification('ìƒˆ í•™ìŠµìë£Œ ê³µìœ ', {
               body: notification.message,
               icon: '/favicon.ico'
           });
       }
       
       setTimeout(() => {
           console.log('ìë£Œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
           loadSharedMaterials();
       }, 1000);
   }

   async function loadSharedMaterials() {
       try {
           const token = getAuthToken();
           const response = await fetch('/api/teacher/shared-materials', {
               headers: {
                   'Authorization': `Bearer ${token}`,
                   'Content-Type': 'application/json'
               }
           });
           
           if (response.ok) {
               sharedMaterials = await response.json();
               renderSharedMaterials();
           } else {
               console.error('ê³µìœ  ìë£Œ ë¡œë”© ì‹¤íŒ¨:', response.status);
           }
       } catch (error) {
           console.error('ê³µìœ  ìë£Œ ë¡œë”© ì‹¤íŒ¨:', error);
       }
   }

   function renderSharedMaterials() {
       const grid = document.getElementById('sharedMaterialsGrid');
       const noMaterials = document.getElementById('noMaterials');
       
       if (sharedMaterials.length === 0) {
           grid.style.display = 'none';
           noMaterials.style.display = 'block';
           return;
       }
       
       grid.style.display = 'grid';
       noMaterials.style.display = 'none';
       grid.innerHTML = '';
       
       sharedMaterials.forEach(material => {
           const card = createMaterialCard(material);
           grid.appendChild(card);
       });
   }

   function createMaterialCard(material) {
       const card = document.createElement('div');
       card.className = 'material-card';
       
       const isNew = isNewMaterial(material.createdAt);
       if (isNew) {
           card.classList.add('new');
       }
       
       const fileIcon = getFileIcon(material.fileType || material.type);
       const fileSize = material.fileSize ? formatFileSize(material.fileSize) : '';
       
       card.innerHTML = `
           <div class="material-header">
               <div class="material-title">${material.title}</div>
               <div class="material-category">${material.category || 'ì¼ë°˜'}</div>
           </div>
           <div class="material-description">${material.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
           <div class="material-meta">
               <div class="material-type">
                   <span>${fileIcon}</span>
                   <span>${(material.fileType || material.type || 'file').toUpperCase()}</span>
                   ${fileSize ? `<span>(${fileSize})</span>` : ''}
               </div>
               <div class="material-date">${formatDate(material.createdAt)}</div>
           </div>
           <div class="material-actions">
               ${(material.fileType === 'youtube' || material.type === 'youtube') ? 
                   `<button class="action-btn" onclick="openYoutube('${material.youtubeUrl || material.url}')">â–¶ï¸ ì‹œì²­í•˜ê¸°</button>` :
                   `<button class="action-btn" onclick="downloadMaterial(${material.id})">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>`
               }
               <button class="action-btn secondary" onclick="viewMaterial(${material.id})">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</button>
           </div>
       `;
       
       return card;
   }

   function getFileIcon(fileType) {
       const icons = {
           'pdf': 'ğŸ“„',
           'ppt': 'ğŸ“Š',
           'pptx': 'ğŸ“Š',
           'doc': 'ğŸ“',
           'docx': 'ğŸ“',
           'jpg': 'ğŸ–¼ï¸',
           'jpeg': 'ğŸ–¼ï¸',
           'png': 'ğŸ–¼ï¸',
           'gif': 'ğŸ–¼ï¸',
           'mp4': 'ğŸ¥',
           'avi': 'ğŸ¥',
           'mov': 'ğŸ¥',
           'youtube': 'ğŸ“º',
           'zip': 'ğŸ“¦',
           'rar': 'ğŸ“¦'
       };
       return icons[fileType?.toLowerCase()] || 'ğŸ“„';
   }

   function formatFileSize(bytes) {
       if (bytes === 0) return '0 Bytes';
       const k = 1024;
       const sizes = ['Bytes', 'KB', 'MB', 'GB'];
       const i = Math.floor(Math.log(bytes) / Math.log(k));
       return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
   }

   function formatDate(dateString) {
       const date = new Date(dateString);
       const now = new Date();
       const diffTime = Math.abs(now - date);
       const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
       
       if (diffDays === 1) return 'ì˜¤ëŠ˜';
       if (diffDays === 2) return 'ì–´ì œ';
       if (diffDays <= 7) return `${diffDays - 1}ì¼ ì „`;
       
       return date.toLocaleDateString('ko-KR');
   }

   function isNewMaterial(dateString) {
       const date = new Date(dateString);
       const now = new Date();
       const diffTime = Math.abs(now - date);
       const diffHours = diffTime / (1000 * 60 * 60);
       return diffHours <= 24;
   }

   function openYoutube(url) {
       window.open(url, '_blank');
   }

   async function downloadMaterial(materialId) {
       try {
           const token = getAuthToken();
           const response = await fetch(`/api/teacher/materials/${materialId}/download`, {
               headers: {
                   'Authorization': `Bearer ${token}`
               }
           });
           
           if (response.ok) {
               const blob = await response.blob();
               const url = window.URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = `material_${materialId}`;
               document.body.appendChild(a);
               a.click();
               window.URL.revokeObjectURL(url);
               document.body.removeChild(a);
           } else {
               alert('íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
           }
       } catch (error) {
           console.error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
           alert('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
       }
   }

   function viewMaterial(materialId) {
       window.open(`/api/teacher/materials/${materialId}/view`, '_blank');
   }

   async function loadCategories() {
       try {
           const response = await fetch('/practice/api/categories');
           const categories = await response.json();
           
           const categoryOrder = [
               'HTML ê¸°ì´ˆ', 'CSS ê¸°ì´ˆ', 'JavaScript ê¸°ì´ˆ',
               'Java ê¸°ì´ˆ', 'ê°ì²´ì§€í–¥', 'Java ì‹¬í™”',
               'DB/SQL', 'JDBC', 'JPA',
               'Servlet/JSP', 'Spring Framework', 'Spring Boot',
               'MyBatis', 'ìµœì¢… í”„ë¡œì íŠ¸'
           ];
           
           allCategories = categoryOrder.filter(cat => categories.includes(cat));
           
           renderTabs();
           if (allCategories.length > 0) {
               showCurriculum(allCategories[0]);
           }
       } catch (error) {
           console.error('ì¹´í…Œê³ ë¦¬ ë¡œë”© ì‹¤íŒ¨:', error);
       }
   }

   async function loadProblems(category) {
       try {
           const response = await fetch(`/practice/api/problems?category=${encodeURIComponent(category)}`);
           const problems = await response.json();
           categoryProblems[category] = problems;
           return problems;
       } catch (error) {
           console.error('ë¬¸ì œ ë¡œë”© ì‹¤íŒ¨:', error);
           return [];
       }
   }

   function renderTabs() {
       const tabsContainer = document.querySelector('.curriculum-tabs');
       tabsContainer.innerHTML = '';
       
       allCategories.forEach((category, index) => {
           const tab = document.createElement('div');
           tab.className = `tab ${index === 0 ? 'active' : ''}`;
           tab.textContent = category;
           tab.addEventListener('click', () => showCurriculum(category));
           tabsContainer.appendChild(tab);
       });
   }

   async function showCurriculum(category) {
       const activeTab = document.querySelector('.tab.active');
       if (activeTab) {
           activeTab.classList.remove('active');
       }
       
       const tabs = document.querySelectorAll('.tab');
       tabs.forEach(tab => {
           if (tab.textContent === category) {
               tab.classList.add('active');
           }
       });
       
       document.getElementById('chapterTitle').textContent = category;
       
       let problems = categoryProblems[category];
       if (!problems) {
           problems = await loadProblems(category);
       }
       
       renderProblems(problems);
   }

   function renderProblems(problems) {
       const grid = document.getElementById('problemsGrid');
       grid.innerHTML = '';
       
       problems.forEach(problem => {
           const card = createProblemCard(problem);
           grid.appendChild(card);
       });
   }

   function createProblemCard(problem) {
       const card = document.createElement('div');
       card.className = 'problem-card';
       card.addEventListener('click', () => solveProblem(problem.problemId));
       
       card.innerHTML = `
           <div class="problem-title">${problem.title}</div>
           <div class="problem-description">${problem.description}</div>
           <div class="problem-meta">
               <span class="difficulty ${getDifficultyClass(problem.difficulty)}">${problem.difficulty}</span>
           </div>
       `;
       
       return card;
   }

   function getDifficultyClass(difficulty) {
       if (difficulty === 'ë§¤ìš° ì‰¬ì›€') return 'very-easy';
       if (difficulty === 'ì‰¬ì›€') return 'easy';
       if (difficulty === 'ë³´í†µ') return 'medium';
       if (difficulty === 'ì–´ë ¤ì›€') return 'hard';
       if (difficulty === 'ë§¤ìš° ì–´ë ¤ì›€') return 'very-hard';
       return 'easy';
   }
   
   function solveProblem(problemId) {
       window.location.href = `/practice/solve/${problemId}`;
   }

   function initializePage() {
       console.log('í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
       
       if ('Notification' in window && Notification.permission === 'default') {
           Notification.requestPermission().then(permission => {
               console.log('ì•Œë¦¼ ê¶Œí•œ:', permission);
           });
       }
       
       loadCategories();
       loadSharedMaterials();
       connectWebSocket();
       
       console.log('í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
   }

   window.addEventListener('beforeunload', () => {
       if (stompClient && connected) {
           stompClient.disconnect();
       }
   });

   document.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>
