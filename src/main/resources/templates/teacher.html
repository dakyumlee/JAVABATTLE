<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì‚¬ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #2c3e50;
        }
        .header {
            background: white;
            padding: 2rem;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 700;
        }
        .header p {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
        }
        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 700;
            z-index: 1000;
        }
        .status-connected {
            background: #27ae60;
            color: white;
            border: 2px solid #27ae60;
        }
        .status-disconnected {
            background: #e74c3c;
            color: white;
            border: 2px solid #e74c3c;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #3498db;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: #3498db;
            line-height: 1;
        }
        .stat-label {
            color: #6c757d;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1.5rem;
            padding: 1rem 2rem 2rem;
            max-width: 1500px;
            margin: 0 auto;
        }
        .student-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #3498db;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .student-card:hover::before {
            transform: scaleX(1);
        }
        .student-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
        }
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }
        .student-name { 
            font-size: 1.2rem; 
            font-weight: 700;
            color: #2c3e50;
        }
        .student-status {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-coding { background: #e74c3c; }
        .status-active { background: #27ae60; }
        .status-idle { background: #f39c12; }
        .status-offline { background: #95a5a6; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        .status-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6c757d;
        }
        .activity-info {
            margin: 1.2rem 0;
            padding: 1.2rem;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #3498db;
        }
        .current-page {
            font-size: 0.95rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.4rem;
        }
        .code-progress {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .last-activity {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 0.4rem;
        }
        .action-buttons {
            display: flex;
            gap: 0.6rem;
            margin-top: 1.2rem;
        }
        .btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            font-family: 'Pretendard Variable', sans-serif;
        }
        .btn-hint {
            background: #3498db;
            color: white;
        }
        .btn-hint:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .btn-monitor {
            background: #6c757d;
            color: white;
        }
        .btn-monitor:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        .controls-panel {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            border-radius: 16px;
            border: 1px solid #e9ecef;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .controls-header {
            padding: 1.2rem 1.5rem;
            background: #3498db;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }
        .controls-header:hover {
            background: #2980b9;
        }
        .controls-title {
            margin: 0;
            font-weight: 700;
            font-size: 1rem;
        }
        .controls-toggle {
            font-size: 1.2rem;
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        .controls-content {
            padding: 1rem 1.5rem 1.5rem;
            transition: all 0.3s ease;
            max-height: 400px;
            overflow: hidden;
        }
        .controls-content.collapsed {
            max-height: 0;
            padding: 0 1.5rem;
        }
        .btn-create {
            background: #3498db;
            color: white;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.3rem 0;
            width: 100%;
            font-family: 'Pretendard Variable', sans-serif;
            font-size: 0.8rem;
        }
        .btn-create:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .btn-quiz {
            background: #e74c3c;
        }
        .btn-quiz:hover {
            background: #c0392b;
        }
        .btn-notes {
            background: #3498db;
        }
        .btn-notes:hover {
            background: #2980b9;
        }
        .btn-submissions {
            background: #27ae60;
        }
        .btn-submissions:hover {
            background: #229954;
        }
        .refresh-btn {
            position: fixed;
            top: 5rem;
            right: 2rem;
            background: #3498db;
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            width: 45px;
            height: 45px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        .refresh-btn:hover {
            background: #2980b9;
            transform: rotate(180deg) scale(1.1);
        }
        .auth-check {
            background: white;
            color: #e74c3c;
            padding: 1.2rem;
            margin: 1.5rem;
            border-radius: 12px;
            border: 2px solid #e74c3c;
            text-align: center;
            display: none;
            font-weight: 600;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 16px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        .submissions-modal .modal-content {
            width: 90%;
            max-width: 1300px;
        }
        .modal-header {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #2c3e50;
        }
        .modal-input, .modal-textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-family: 'Pretendard Variable', sans-serif;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }
        .modal-input:focus, .modal-textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        .modal-textarea {
            resize: vertical;
            min-height: 100px;
        }
        .modal-buttons {
            display: flex;
            gap: 0.8rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        .modal-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Pretendard Variable', sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .modal-btn-primary {
            background: #3498db;
            color: white;
        }
        .modal-btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .modal-btn-primary.active {
            background: #2980b9;
        }
        .modal-btn-quiz {
            background: #e74c3c;
            color: white;
        }
        .modal-btn-quiz:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }
        .modal-btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        .empty-state {
            text-align: center;
            grid-column: 1/-1;
            padding: 3rem;
            color: #6c757d;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .quiz-options {
            margin-bottom: 1.5rem;
        }
        .option-group {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        .option-input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Pretendard Variable', sans-serif;
            transition: border-color 0.3s ease;
        }
        .option-input:focus {
            border-color: #3498db;
            outline: none;
        }
        .option-radio {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .correct-option {
            border-color: #27ae60 !important;
            background: #f0fff4;
        }
        .quiz-preview {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #e74c3c;
            margin-bottom: 1.5rem;
        }
        .quiz-preview-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.6rem;
        }
        .quiz-preview-question {
            color: #6c757d;
            margin-bottom: 1rem;
        }
        .quiz-preview-options {
            color: #6c757d;
            font-size: 0.95rem;
        }
        .submission-tab {
            min-height: 450px;
        }
        .submissions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .submissions-table th,
        .submissions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        .submissions-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        .submission-answer {
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .submission-time {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .score-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .score-excellent {
            background: #d4edda;
            color: #155724;
        }
        .score-good {
            background: #cce5ff;
            color: #004085;
        }
        .score-fair {
            background: #fff3cd;
            color: #856404;
        }
        .score-poor {
            background: #f8d7da;
            color: #721c24;
        }
        .score-ungraded {
            background: #e9ecef;
            color: #6c757d;
        }
        .btn-grade {
            background: #f39c12;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-grade:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }
        .tab-buttons {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .notes-modal .modal-content {
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 1rem;
        }

        .notes-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            background: white;
            color: #6c757d;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: 'Pretendard Variable', sans-serif;
        }

        .filter-btn.active,
        .filter-btn:hover {
            border-color: #3498db;
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .notes-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }

        .note-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .note-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .note-item:last-child {
            margin-bottom: 0;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .note-title {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1rem;
            margin: 0;
        }

        .note-category {
            background: #3498db;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .note-meta {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .note-content {
            color: #2c3e50;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid #e9ecef;
        }

        .btn-note-action {
            padding: 0.3rem 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-edit:hover {
            background: #e67e22;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .empty-notes {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .empty-notes h3 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .category-ìˆ˜ì—… { border-left-color: #3498db; }
        .category-í•™ìƒ { border-left-color: #27ae60; }
        .category-ê³¼ì œ { border-left-color: #f39c12; }
        .category-ê¸°íƒ€ { border-left-color: #9b59b6; }

        .note-category.category-ìˆ˜ì—… { background: #3498db; }
        .note-category.category-í•™ìƒ { background: #27ae60; }
        .note-category.category-ê³¼ì œ { background: #f39c12; }
        .note-category.category-ê¸°íƒ€ { background: #9b59b6; }

        @media (max-width: 768px) {
            .students-grid {
                grid-template-columns: 1fr;
            }
            .controls-panel {
                bottom: 1rem;
                right: 1rem;
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">ì—°ê²° ì¤‘...</div>
    
    <div class="auth-check" id="auth-warning">
        ê°•ì‚¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.
    </div>

    <button class="refresh-btn" onclick="refreshData()">ğŸ”„</button>

    <div class="header">
        <h1>ê°•ì‚¬ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h1>
        <p>í•™ìƒë“¤ì˜ í™œë™ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ê³  ì¦‰ì‹œ í”¼ë“œë°±ì„ ì œê³µí•˜ì„¸ìš”</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-students">0</div>
            <div class="stat-label">ì „ì²´ í•™ìƒ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="active-students">0</div>
            <div class="stat-label">ì ‘ì† ì¤‘</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="coding-students">0</div>
            <div class="stat-label">ì½”ë”© ì¤‘</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="avg-code-length">0</div>
            <div class="stat-label">í‰ê·  ì½”ë“œ ê¸¸ì´</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="submissions-count">0</div>
            <div class="stat-label">ì œì¶œëœ ë‹µì•ˆ</div>
        </div>
    </div>

    <div class="students-grid" id="students-container"></div>

    <div class="controls-panel" id="controlsPanel">
        <div class="controls-header" onclick="toggleControlsPanel()">
            <h3 class="controls-title">ë¹ ë¥¸ ì‘ì—…</h3>
            <span class="controls-toggle" id="controlsToggle">âˆ’</span>
        </div>
        <div class="controls-content" id="controlsContent">
            <button class="btn-create" onclick="openCreateProblemModal()">ğŸ“ ì¦‰ì„ ë¬¸ì œ ì¶œì œ</button>
            <button class="btn-create" onclick="openGlobalHintModal()">ğŸ’¡ ì „ì²´ íŒíŠ¸</button>
            <button class="btn-create btn-quiz" onclick="openQuizModal()">âš¡ ê¹œì§ í€´ì¦ˆ</button>
            <button class="btn-create btn-notes" onclick="openNotesModal()">ğŸ“ ê°•ì‚¬ ë©”ëª¨ì¥</button>
            <button class="btn-create btn-submissions" onclick="openSubmissionsModal()">ğŸ“‹ ë‹µì•ˆ ì¡°íšŒ</button>
        </div>
    </div>

    <div id="hintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ’¡ íŒíŠ¸ ë³´ë‚´ê¸°</div>
            <input type="text" id="hintStudentName" class="modal-input" readonly placeholder="í•™ìƒ ì´ë¦„">
            <textarea id="hintMessage" class="modal-textarea" placeholder="íŒíŠ¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('hintModal')">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-primary" onclick="sendHintConfirm()">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <div id="globalHintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ’¡ ì „ì²´ íŒíŠ¸ ë³´ë‚´ê¸°</div>
            <textarea id="globalHintMessage" class="modal-textarea" placeholder="ëª¨ë“  í•™ìƒì—ê²Œ ë³´ë‚¼ íŒíŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('globalHintModal')">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-primary" onclick="sendGlobalHintConfirm()">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <div id="createProblemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“ ì¦‰ì„ ë¬¸ì œ ì¶œì œ</div>
            <input type="text" id="problemTitle" class="modal-input" placeholder="ë¬¸ì œ ì œëª©">
            <textarea id="problemDescription" class="modal-textarea" placeholder="ë¬¸ì œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('createProblemModal')">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-primary" onclick="createProblemConfirm()">ì¶œì œ</button>
            </div>
        </div>
    </div>

    <div id="quizModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">âš¡ ê¹œì§ í€´ì¦ˆ ë§Œë“¤ê¸°</div>
            <input type="text" id="quizTitle" class="modal-input" placeholder="í€´ì¦ˆ ì œëª© (ì˜ˆ: Java ê¸°ì´ˆ ë¬¸ë²• í€´ì¦ˆ)">
            <textarea id="quizQuestion" class="modal-textarea" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: System.out.println()ì˜ ì¶œë ¥ ê²°ê³¼ëŠ”?)"></textarea>
            
            <div class="quiz-options">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">ì„ íƒì§€ (ì •ë‹µì„ ì²´í¬í•˜ì„¸ìš”)</label>
                <div class="option-group">
                    <input type="radio" name="correctAnswer" value="0" class="option-radio">
                    <input type="text" class="option-input" placeholder="ì„ íƒì§€ 1" data-option="0">
                </div>
                <div class="option-group">
                    <input type="radio" name="correctAnswer" value="1" class="option-radio">
                    <input type="text" class="option-input" placeholder="ì„ íƒì§€ 2" data-option="1">
                </div>
                <div class="option-group">
                    <input type="radio" name="correctAnswer" value="2" class="option-radio">
                    <input type="text" class="option-input" placeholder="ì„ íƒì§€ 3" data-option="2">
                </div>
                <div class="option-group">
                    <input type="radio" name="correctAnswer" value="3" class="option-radio">
                    <input type="text" class="option-input" placeholder="ì„ íƒì§€ 4" data-option="3">
                </div>
            </div>

            <div class="quiz-preview" id="quizPreview" style="display: none;">
                <div class="quiz-preview-title">ë¯¸ë¦¬ë³´ê¸°</div>
                <div class="quiz-preview-question" id="previewQuestion"></div>
                <div class="quiz-preview-options" id="previewOptions"></div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('quizModal')">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-secondary" onclick="previewQuiz()">ë¯¸ë¦¬ë³´ê¸°</button>
                <button class="modal-btn modal-btn-quiz" onclick="sendQuizConfirm()">í€´ì¦ˆ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <div id="submissionsModal" class="modal submissions-modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“‹ ì œì¶œëœ ë‹µì•ˆ ì¡°íšŒ ë° ì±„ì </div>
            
            <div class="tab-buttons">
                <button class="modal-btn modal-btn-primary active" onclick="switchSubmissionTab('problems')">ë¬¸ì œ ë‹µì•ˆ</button>
                <button class="modal-btn modal-btn-secondary" onclick="switchSubmissionTab('quiz')">í€´ì¦ˆ ë‹µì•ˆ</button>
            </div>
            
            <div id="problemSubmissions" class="submission-tab">
                <div id="problemSubmissionsContent">
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        ë‹µì•ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>
            </div>
            
            <div id="quizSubmissions" class="submission-tab" style="display: none;">
                <div id="quizSubmissionsContent">
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        í€´ì¦ˆ ë‹µì•ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('submissionsModal')">ë‹«ê¸°</button>
                <button class="modal-btn modal-btn-primary" onclick="loadAllSubmissions()">ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>
    </div>

    <div id="scoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“ ë‹µì•ˆ ì±„ì </div>
            <div id="scoreModalContent">
                <div><strong>í•™ìƒ:</strong> <span id="scoreStudentName"></span></div>
                <div style="margin: 10px 0;"><strong>ë¬¸ì œ:</strong> <span id="scoreProblemTitle"></span></div>
                <div style="margin: 10px 0;"><strong>ë‹µì•ˆ:</strong></div>
                <div id="scoreAnswer" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; max-height: 200px; overflow-y: auto;"></div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">ì ìˆ˜ (0-100):</label>
                    <input type="number" id="scoreInput" min="0" max="100" class="modal-input" placeholder="ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">í”¼ë“œë°±:</label>
                    <textarea id="feedbackInput" class="modal-textarea" placeholder="í•™ìƒì—ê²Œ ì „ë‹¬í•  í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”..." style="min-height: 100px;"></textarea>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('scoreModal')">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-primary" onclick="saveScore()">ì ìˆ˜ ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="notesModal" class="modal notes-modal">
        <div class="modal-content">
            <div class="notes-header">
                <div class="modal-header" style="margin-bottom: 0;">ğŸ“ ê°•ì‚¬ ë©”ëª¨ì¥</div>
                <button class="modal-btn modal-btn-primary" onclick="openCreateNoteModal()">ìƒˆ ë©”ëª¨ ì‘ì„±</button>
            </div>
            
            <div class="notes-filter">
                <button class="filter-btn active" onclick="filterNotes('all')">ì „ì²´</button>
                <button class="filter-btn" onclick="filterNotes('ìˆ˜ì—…')">ìˆ˜ì—…</button>
                <button class="filter-btn" onclick="filterNotes('í•™ìƒ')">í•™ìƒ</button>
                <button class="filter-btn" onclick="filterNotes('ê³¼ì œ')">ê³¼ì œ</button>
                <button class="filter-btn" onclick="filterNotes('ê¸°íƒ€')">ê¸°íƒ€</button>
            </div>
            
            <div class="notes-list" id="notesList">
                <div style="text-align: center; padding: 2rem; color: #6c757d;">
                    ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('notesModal')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="createNoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“ ìƒˆ ë©”ëª¨ ì‘ì„±</div>
            
            <div class="form-group">
                <label class="form-label">ì œëª©</label>
                <input type="text" id="noteTitle" class="modal-input" placeholder="ë©”ëª¨ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                <select id="noteCategory" class="modal-input">
                    <option value="ìˆ˜ì—…">ìˆ˜ì—…</option>
                    <option value="í•™ìƒ">í•™ìƒ</option>
                    <option value="ê³¼ì œ">ê³¼ì œ</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ë‚´ìš©</label>
                <textarea id="noteContent" class="modal-textarea" placeholder="ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." style="min-height: 150px;"></textarea>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('createNoteModal')">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-primary" onclick="saveNote()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
    var stompClient = null;
    var studentsData = [];
    var currentStudentId = null;
    var isConnected = false;
    var notesData = [];
    var currentNoteId = null;
    var currentFilter = 'all';
    var submissionsData = [];
    var quizSubmissionsData = [];
    var currentSubmissionId = null;
    var currentSubmissionTab = 'problems';
    var userNamesCache = {};

    function getAuthToken() {
        return localStorage.getItem('token') || 
               localStorage.getItem('jwtToken') || 
               localStorage.getItem('authToken') || 
               sessionStorage.getItem('token') ||
               sessionStorage.getItem('jwtToken') ||
               sessionStorage.getItem('authToken');
    }

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        
        stompClient.connect({}, function (frame) {
            console.log('WebSocket ì—°ê²°ë¨: ' + frame);
            isConnected = true;
            updateConnectionStatus();
            
            stompClient.subscribe('/topic/teacher-monitor', function (message) {
                var activity = JSON.parse(message.body);
                updateStudentActivity(activity);
            });
            
            stompClient.subscribe('/topic/student-disconnect', function (message) {
                var data = JSON.parse(message.body);
                removeStudent(data.userId);
            });

            stompClient.subscribe('/topic/teacher-notifications', function(message) {
                var notification = JSON.parse(message.body);
                if (notification.type === 'ANSWER_SUBMITTED') {
                    showAnswerNotification(notification);
                    updateSubmissionsCount();
                } else if (notification.type === 'QUIZ_SUBMITTED') {
                    showQuizNotification(notification);
                    updateSubmissionsCount();
                }
            });
            
        }, function(error) {
            console.log('WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error);
            isConnected = false;
            updateConnectionStatus();
            setTimeout(connect, 5000);
        });
    }

    function toggleControlsPanel() {
        var content = document.getElementById('controlsContent');
        var toggle = document.getElementById('controlsToggle');
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            toggle.textContent = 'âˆ’';
            toggle.style.transform = 'rotate(0deg)';
        } else {
            content.classList.add('collapsed');
            toggle.textContent = '+';
            toggle.style.transform = 'rotate(90deg)';
        }
    }

    function loadUserNames() {
        const token = getAuthToken();
        if (!token) {
            console.log('í† í°ì´ ì—†ì–´ì„œ ì‚¬ìš©ì ëª©ë¡ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }

        fetch('/api/users/all', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(function(response) { 
                console.log('ì‚¬ìš©ì ëª©ë¡ API ì‘ë‹µ:', response.status);
                if (!response.ok) {
                    throw new Error('ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + response.status);
                }
                return response.json(); 
            })
            .then(function(data) {
                console.log('ë°›ì€ ì‚¬ìš©ì ë°ì´í„°:', data);
                if (data.success && data.users) {
                    data.users.forEach(function(user) {
                        userNamesCache[user.id] = user.nickname || user.email || `ì‚¬ìš©ì${user.id}`;
                    });
                    console.log('ì‚¬ìš©ì ìºì‹œ ì—…ë°ì´íŠ¸:', userNamesCache);
                    renderStudents();
                } else if (Array.isArray(data)) {
                    data.forEach(function(user) {
                        userNamesCache[user.id] = user.nickname || user.email || `ì‚¬ìš©ì${user.id}`;
                    });
                    console.log('ì‚¬ìš©ì ìºì‹œ ì—…ë°ì´íŠ¸:', userNamesCache);
                    renderStudents();
                }
            })
            .catch(function(error) {
                console.log('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            });
    }

    function getStudentName(userId) {
        const cachedName = userNamesCache[userId];
        if (cachedName) {
            return cachedName;
        }
        return `í•™ìƒ${userId}`;
    }

    function showAnswerNotification(data) {
        var notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #38a169;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 500px;
            font-family: 'Pretendard Variable', sans-serif;
            animation: slideIn 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“ ë‹µì•ˆ ì œì¶œ ì•Œë¦¼</div>
            <div>${getStudentName(data.userId)}ê°€ "${data.problemTitle || 'ë¬¸ì œ'}"ì˜ ë‹µì•ˆì„ ì œì¶œí–ˆìŠµë‹ˆë‹¤.</div>
            <div style="margin-top: 5px; font-size: 0.9em; opacity: 0.9;">ë‹µì•ˆ: ${data.answer ? data.answer.substring(0, 50) : ''}${data.answer && data.answer.length > 50 ? '...' : ''}</div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(function() {
            notification.remove();
        }, 8000);
    }

    function showQuizNotification(data) {
        var notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: ${data.isCorrect ? '#38a169' : '#e53e3e'};
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 500px;
            font-family: 'Pretendard Variable', sans-serif;
            animation: slideIn 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 5px;">âš¡ í€´ì¦ˆ ë‹µì•ˆ ì œì¶œ</div>
            <div>${getStudentName(data.userId)}ê°€ "${data.quizTitle}" í€´ì¦ˆì— ë‹µë³€í–ˆìŠµë‹ˆë‹¤.</div>
            <div style="margin-top: 5px; font-size: 0.9em; opacity: 0.9;">
                í•™ìƒ ë‹µì•ˆ: ${data.userAnswer + 1}ë²ˆ, ì •ë‹µ: ${data.correctAnswer + 1}ë²ˆ 
                ${data.isCorrect ? 'âœ“ ì •ë‹µ' : 'âœ— ì˜¤ë‹µ'}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(function() {
            notification.remove();
        }, 8000);
    }

    function updateSubmissionsCount() {
        const token = getAuthToken();
        if (!token) return;

        fetch('/api/teacher/submissions', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    document.getElementById('submissions-count').textContent = data.totalCount || 0;
                }
            })
            .catch(function(error) {
                console.log('ë‹µì•ˆ ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
            });
    }

    function updateConnectionStatus() {
        var statusEl = document.getElementById('connection-status');
        if (isConnected) {
            statusEl.textContent = 'ğŸŸ¢ ì‹¤ì‹œê°„ ì—°ê²°ë¨';
            statusEl.className = 'connection-status status-connected';
        } else {
            statusEl.textContent = 'ğŸ”´ ì—°ê²° ëŠê¹€';
            statusEl.className = 'connection-status status-disconnected';
        }
    }

    function updateStudentActivity(activity) {
        var existingIndex = studentsData.findIndex(function(s) { return s.id === activity.userId; });
        
        if (existingIndex >= 0) {
            studentsData[existingIndex] = {
                id: studentsData[existingIndex].id,
                nickname: userNamesCache[activity.userId] || studentsData[existingIndex].nickname || getStudentName(activity.userId),
                currentPage: activity.page,
                isCoding: activity.isCoding,
                codeLength: activity.codeLength,
                lastActivity: new Date(activity.timestamp)
            };
        } else {
            studentsData.push({
                id: activity.userId,
                nickname: userNamesCache[activity.userId] || getStudentName(activity.userId),
                currentPage: activity.page,
                isCoding: activity.isCoding,
                codeLength: activity.codeLength,
                lastActivity: new Date(activity.timestamp)
            });
        }
        
        renderStudents();
        updateStats();
    }

    function removeStudent(userId) {
        studentsData = studentsData.filter(function(s) { return s.id !== userId; });
        renderStudents();
        updateStats();
    }

    function checkTeacherAuth() {
        var token = getAuthToken();
        if (!token) {
            document.getElementById('auth-warning').style.display = 'block';
            return false;
        }
        return true;
    }

    function refreshData() {
        const token = getAuthToken();
        if (!token) {
            console.log('í† í°ì´ ì—†ì–´ì„œ ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }

        fetch('/api/teacher/active-students', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(function(response) { 
                console.log('í™œì„± í•™ìƒ API ì‘ë‹µ:', response.status);
                return response.json(); 
            })
            .then(function(data) {
                console.log('ë°›ì€ í•™ìƒ ë°ì´í„°:', data);
                studentsData = data.map(function(session) {
                    return {
                        id: session.userId,
                        nickname: userNamesCache[session.userId] || getStudentName(session.userId),
                        currentPage: session.currentPage || '/study',
                        isCoding: session.isCoding || false,
                        codeLength: session.codeLength || 0,
                        lastActivity: new Date(session.lastActivity || session.updatedAt || Date.now())
                    };
                });
                updateStats();
                renderStudents();
                updateSubmissionsCount();
            })
            .catch(function(error) {
                console.log('API ì—°ê²° ëŒ€ê¸° ì¤‘...', error);
            });
    }

    function updateStats() {
        var totalStudents = studentsData.length;
        var now = new Date();
        var activeStudents = studentsData.filter(function(s) { 
            var lastActivity = new Date(s.lastActivity);
            return (now - lastActivity) < 300000;
        }).length;
        var codingStudents = studentsData.filter(function(s) { return s.isCoding; }).length;
        var avgCodeLength = totalStudents > 0 ? 
            Math.round(studentsData.reduce(function(sum, s) { return sum + (s.codeLength || 0); }, 0) / totalStudents) : 0;

        document.getElementById('total-students').textContent = totalStudents;
        document.getElementById('active-students').textContent = activeStudents;
        document.getElementById('coding-students').textContent = codingStudents;
        document.getElementById('avg-code-length').textContent = avgCodeLength;
    }

    function renderStudents() {
        var container = document.getElementById('students-container');
        
        if (studentsData.length === 0) {
            container.innerHTML = '<div class="empty-state">ì ‘ì†í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        container.innerHTML = studentsData.map(function(student) {
            var lastActivity = new Date(student.lastActivity);
            var timeDiff = new Date() - lastActivity;
            var isActive = timeDiff < 300000;
            
            var statusClass, statusText;
            if (student.isCoding) {
                statusClass = 'status-coding';
                statusText = 'ì½”ë”© ì¤‘';
            } else if (isActive) {
                statusClass = 'status-active';
                statusText = 'í™œë™ ì¤‘';
            } else if (timeDiff < 600000) {
                statusClass = 'status-idle';
                statusText = 'ëŒ€ê¸° ì¤‘';
            } else {
                statusClass = 'status-offline';
                statusText = 'ë¹„í™œì„±';
            }

            return '<div class="student-card">' +
                '<div class="student-header">' +
                    '<div class="student-name">' + student.nickname + '</div>' +
                    '<div class="student-status">' +
                        '<div class="status-dot ' + statusClass + '"></div>' +
                        '<span class="status-text">' + statusText + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="activity-info">' +
                    '<div class="current-page">ğŸ“„ ' + (student.currentPage || 'ë©”ì¸ í˜ì´ì§€') + '</div>' +
                    '<div class="code-progress">ğŸ’» ì½”ë“œ ê¸¸ì´: ' + (student.codeLength || 0) + 'ì</div>' +
                    '<div class="last-activity">â° ' + formatTime(lastActivity) + '</div>' +
                '</div>' +
                '<div class="action-buttons">' +
                    '<button class="btn btn-hint" onclick="openHintModal(\'' + student.id + '\', \'' + student.nickname + '\')">ğŸ’¡ íŒíŠ¸</button>' +
                    '<button class="btn btn-monitor" onclick="monitorStudent(\'' + student.id + '\')">ğŸ‘ï¸ ëª¨ë‹ˆí„°</button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    function formatTime(date) {
        var now = new Date();
        var diff = now - date;
        var days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (diff < 60000) return 'ë°©ê¸ˆ ì „';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'ë¶„ ì „';
        return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }

    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        var modal = document.getElementById(modalId);
        var inputs = modal.querySelectorAll('input, textarea, select');
        for (var i = 0; i < inputs.length; i++) {
            if (!inputs[i].readOnly) {
                if (inputs[i].type === 'checkbox') {
                    inputs[i].checked = false;
                } else {
                    inputs[i].value = '';
                }
            }
        }
        if (modalId === 'quizModal') {
            var radios = modal.querySelectorAll('input[type="radio"]');
            for (var j = 0; j < radios.length; j++) {
                radios[j].checked = false;
            }
            document.getElementById('quizPreview').style.display = 'none';
        }
    }

    function openHintModal(studentId, studentName) {
        currentStudentId = studentId;
        document.getElementById('hintStudentName').value = studentName;
        openModal('hintModal');
    }

    function openGlobalHintModal() {
        openModal('globalHintModal');
    }

    function openCreateProblemModal() {
        openModal('createProblemModal');
    }

    function openQuizModal() {
        openModal('quizModal');
    }

    function openNotesModal() {
        openModal('notesModal');
        loadNotes();
    }

    function openSubmissionsModal() {
        openModal('submissionsModal');
        loadAllSubmissions();
    }

    function switchSubmissionTab(tabName) {
        currentSubmissionTab = tabName;
        
        var problemTab = document.getElementById('problemSubmissions');
        var quizTab = document.getElementById('quizSubmissions');
        var buttons = document.querySelectorAll('.tab-buttons .modal-btn');
        
        if (tabName === 'problems') {
            problemTab.style.display = 'block';
            quizTab.style.display = 'none';
            buttons[0].classList.add('active');
            buttons[1].classList.remove('active');
            buttons[0].classList.remove('modal-btn-secondary');
            buttons[0].classList.add('modal-btn-primary');
            buttons[1].classList.remove('modal-btn-primary');
            buttons[1].classList.add('modal-btn-secondary');
            loadProblemSubmissions();
        } else {
            problemTab.style.display = 'none';
            quizTab.style.display = 'block';
            buttons[1].classList.add('active');
            buttons[0].classList.remove('active');
            buttons[1].classList.remove('modal-btn-secondary');
            buttons[1].classList.add('modal-btn-primary');
            buttons[0].classList.remove('modal-btn-primary');
            buttons[0].classList.add('modal-btn-secondary');
            loadQuizSubmissions();
        }
    }

    function loadAllSubmissions() {
        if (currentSubmissionTab === 'problems') {
            loadProblemSubmissions();
        } else {
            loadQuizSubmissions();
        }
    }

    function loadProblemSubmissions() {
        document.getElementById('problemSubmissionsContent').innerHTML = 
            '<div style="text-align: center; padding: 2rem; color: #6c757d;">ë‹µì•ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        
        const token = getAuthToken();
        fetch('/api/teacher/submissions', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    submissionsData = data.submissions;
                    renderProblemSubmissions();
                } else {
                    document.getElementById('problemSubmissionsContent').innerHTML = 
                        '<div style="text-align: center; padding: 2rem; color: #dc3545;">ë‹µì•ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            })
            .catch(function(error) {
                console.error('ë‹µì•ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('problemSubmissionsContent').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #dc3545;">ë‹µì•ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            });
    }

    function loadQuizSubmissions() {
        document.getElementById('quizSubmissionsContent').innerHTML = 
            '<div style="text-align: center; padding: 2rem; color: #6c757d;">í€´ì¦ˆ ë‹µì•ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        
        const token = getAuthToken();
        fetch('/api/teacher/quiz-submissions', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    quizSubmissionsData = data.submissions;
                    renderQuizSubmissions();
                } else {
                    document.getElementById('quizSubmissionsContent').innerHTML = 
                        '<div style="text-align: center; padding: 2rem; color: #dc3545;">í€´ì¦ˆ ë‹µì•ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            })
            .catch(function(error) {
                console.error('í€´ì¦ˆ ë‹µì•ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('quizSubmissionsContent').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #dc3545;">í€´ì¦ˆ ë‹µì•ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            });
    }

    function renderProblemSubmissions() {
        var container = document.getElementById('problemSubmissionsContent');
        
        if (submissionsData.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6c757d;">ì œì¶œëœ ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        var tableHTML = '<table class="submissions-table">' +
            '<thead>' +
                '<tr>' +
                    '<th>í•™ìƒ</th>' +
                    '<th>ë¬¸ì œ ì œëª©</th>' +
                    '<th>ë‹µì•ˆ</th>' +
                    '<th>ì œì¶œ ì‹œê°„</th>' +
                    '<th>ì ìˆ˜</th>' +
                    '<th>ì‘ì—…</th>' +
                '</tr>' +
            '</thead>' +
            '<tbody>';

        submissionsData.forEach(function(submission) {
            var submittedAt = new Date(submission.submittedAt);
            var scoreClass = getScoreClass(submission.score);
            var scoreText = submission.score !== null ? submission.score + 'ì ' : 'ë¯¸ì±„ì ';
            
            tableHTML += '<tr>' +
                '<td>' + getStudentName(submission.userId) + '</td>' +
                '<td>' + (submission.problemTitle || '-') + '</td>' +
                '<td class="submission-answer" title="' + (submission.answer || '') + '">' + 
                    (submission.answer ? submission.answer.substring(0, 100) : '-') + 
                    (submission.answer && submission.answer.length > 100 ? '...' : '') + 
                '</td>' +
                '<td class="submission-time">' + submittedAt.toLocaleString('ko-KR') + '</td>' +
                '<td><span class="score-badge ' + scoreClass + '">' + scoreText + '</span></td>' +
                '<td><button class="btn-grade" onclick="openScoreModal(' + submission.id + ')">ì±„ì </button></td>' +
            '</tr>';
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    function renderQuizSubmissions() {
        var container = document.getElementById('quizSubmissionsContent');
        
        if (quizSubmissionsData.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6c757d;">ì œì¶œëœ í€´ì¦ˆ ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        var tableHTML = '<table class="submissions-table">' +
            '<thead>' +
                '<tr>' +
                    '<th>í•™ìƒ</th>' +
                    '<th>í€´ì¦ˆ ì œëª©</th>' +
                    '<th>í•™ìƒ ë‹µì•ˆ</th>' +
                    '<th>ì •ë‹µ</th>' +
                    '<th>ê²°ê³¼</th>' +
                    '<th>ì œì¶œ ì‹œê°„</th>' +
                '</tr>' +
            '</thead>' +
            '<tbody>';

        quizSubmissionsData.forEach(function(submission) {
            var submittedAt = new Date(submission.submittedAt);
            var resultClass = submission.isCorrect ? 'score-excellent' : 'score-poor';
            var resultText = submission.isCorrect ? 'ì •ë‹µ' : 'ì˜¤ë‹µ';
            
            tableHTML += '<tr>' +
                '<td>' + getStudentName(submission.userId) + '</td>' +
                '<td>' + (submission.quizTitle || '-') + '</td>' +
                '<td>' + (submission.userAnswer + 1) + 'ë²ˆ</td>' +
                '<td>' + (submission.correctAnswer + 1) + 'ë²ˆ</td>' +
                '<td><span class="score-badge ' + resultClass + '">' + resultText + '</span></td>' +
                '<td class="submission-time">' + submittedAt.toLocaleString('ko-KR') + '</td>' +
            '</tr>';
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    function getScoreClass(score) {
        if (score === null) return 'score-ungraded';
        if (score >= 90) return 'score-excellent';
        if (score >= 70) return 'score-good';
        if (score >= 50) return 'score-fair';
        return 'score-poor';
    }

    function openScoreModal(submissionId) {
        var submission = submissionsData.find(function(s) { return s.id === submissionId; });
        if (!submission) return;
        
        currentSubmissionId = submissionId;
        document.getElementById('scoreStudentName').textContent = getStudentName(submission.userId);
        document.getElementById('scoreProblemTitle').textContent = submission.problemTitle || '-';
        document.getElementById('scoreAnswer').textContent = submission.answer || '-';
        document.getElementById('scoreInput').value = submission.score || '';
        document.getElementById('feedbackInput').value = '';
        
        openModal('scoreModal');
    }

    function saveScore() {
        var score = document.getElementById('scoreInput').value;
        var feedback = document.getElementById('feedbackInput').value.trim();
        
        if (!score || score < 0 || score > 100) {
            alert('0-100 ì‚¬ì´ì˜ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const token = getAuthToken();
        fetch('/api/teacher/submissions/' + currentSubmissionId + '/score', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                score: parseInt(score),
                feedback: feedback
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('ì ìˆ˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeModal('scoreModal');
                loadProblemSubmissions();
            } else {
                alert('ì ìˆ˜ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(function() {
            alert('ì ìˆ˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    function loadNotes() {
        const token = getAuthToken();
        fetch('/api/teacher/notes', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) { 
            console.log('ë…¸íŠ¸ API ì‘ë‹µ:', response.status);
            return response.json(); 
        })
        .then(function(data) {
            if (data.success) {
                notesData = data.notes || [];
                renderNotes();
            } else {
                document.getElementById('notesList').innerHTML = 
                    '<div class="empty-notes"><h3>ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3><p>ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p></div>';
            }
        })
        .catch(function(error) {
            console.error('ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('notesList').innerHTML = 
                '<div class="empty-notes"><h3>ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3><p>ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p></div>';
        });
    }

    function renderNotes() {
        var container = document.getElementById('notesList');
        var filteredNotes = currentFilter === 'all' ? 
            notesData : 
            notesData.filter(function(note) { return note.category === currentFilter; });
        
        if (filteredNotes.length === 0) {
            var emptyMessage = currentFilter === 'all' ? 
                'ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.' : 
                currentFilter + ' ì¹´í…Œê³ ë¦¬ì— ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.';
            
            container.innerHTML = 
                '<div class="empty-notes">' +
                    '<h3>' + emptyMessage + '</h3>' +
                    '<p>ìƒˆ ë©”ëª¨ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>' +
                '</div>';
            return;
        }

        container.innerHTML = filteredNotes.map(function(note) {
            var createdAt = new Date(note.createdAt);
            var timeAgo = getTimeAgo(createdAt);
            
            return 
                '<div class="note-item category-' + note.category + '" onclick="viewNote(' + note.id + ')">' +
                    '<div class="note-header">' +
                        '<h4 class="note-title">' + note.title + '</h4>' +
                        '<span class="note-category category-' + note.category + '">' + note.category + '</span>' +
                    '</div>' +
                    '<div class="note-meta">' + timeAgo + ' ì‘ì„±</div>' +
                    '<div class="note-content">' + 
                        (note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content) + 
                    '</div>' +
                    '<div class="note-actions">' +
                        '<button class="btn-note-action btn-edit" onclick="editNote(' + note.id + '); event.stopPropagation();">ìˆ˜ì •</button>' +
                        '<button class="btn-note-action btn-delete" onclick="deleteNote(' + note.id + '); event.stopPropagation();">ì‚­ì œ</button>' +
                    '</div>' +
                '</div>';
        }).join('');
    }

    function getTimeAgo(date) {
        var now = new Date();
        var diff = now - date;
        var minutes = Math.floor(diff / 60000);
        var hours = Math.floor(diff / 3600000);
        var days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'ë°©ê¸ˆ';
        if (minutes < 60) return minutes + 'ë¶„ ì „';
        if (hours < 24) return hours + 'ì‹œê°„ ì „';
        if (days < 7) return days + 'ì¼ ì „';
        return date.toLocaleDateString('ko-KR');
    }

    function filterNotes(category) {
        currentFilter = category;
        
        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        renderNotes();
    }

    function openCreateNoteModal() {
        currentNoteId = null;
        document.getElementById('noteTitle').value = '';
        document.getElementById('noteCategory').value = 'ìˆ˜ì—…';
        document.getElementById('noteContent').value = '';
        openModal('createNoteModal');
    }

    function saveNote() {
        var title = document.getElementById('noteTitle').value.trim();
        var category = document.getElementById('noteCategory').value;
        var content = document.getElementById('noteContent').value.trim();
        
        if (!title || !content) {
            alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        var noteData = {
            title: title,
            category: category,
            content: content
        };
        
        var url = currentNoteId ? 
            '/api/teacher/notes/' + currentNoteId : 
            '/api/teacher/notes';
        var method = currentNoteId ? 'PUT' : 'POST';
        
        const token = getAuthToken();
        fetch(url, {
            method: method,
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(noteData)
        })
        .then(function(response) { 
            console.log('ë…¸íŠ¸ ì €ì¥ API ì‘ë‹µ:', response.status);
            return response.json(); 
        })
        .then(function(data) {
            if (data.success) {
                alert(currentNoteId ? 'ë©”ëª¨ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeModal('createNoteModal');
                loadNotes();
            } else {
                alert('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        })
        .catch(function(error) {
            console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', error);
            alert('ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    function viewNote(noteId) {
        var note = notesData.find(function(n) { return n.id === noteId; });
        if (!note) return;
        
        alert('ì œëª©: ' + note.title + '\n\n' + note.content);
    }

    function editNote(noteId) {
        var note = notesData.find(function(n) { return n.id === noteId; });
        if (!note) return;
        
        currentNoteId = noteId;
        document.getElementById('noteTitle').value = note.title;
        document.getElementById('noteCategory').value = note.category;
        document.getElementById('noteContent').value = note.content;
        openModal('createNoteModal');
    }

    function deleteNote(noteId) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        const token = getAuthToken();
        fetch('/api/teacher/notes/' + noteId, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadNotes();
            } else {
                alert('ë©”ëª¨ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
        })
        .catch(function(error) {
            console.error('ë©”ëª¨ ì‚­ì œ ì‹¤íŒ¨:', error);
            alert('ë©”ëª¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    function previewQuiz() {
        var title = document.getElementById('quizTitle').value.trim();
        var question = document.getElementById('quizQuestion').value.trim();
        var options = [];
        var correctAnswer = null;
        
        var optionInputs = document.querySelectorAll('.option-input');
        var radios = document.querySelectorAll('input[name="correctAnswer"]');
        
        for (var i = 0; i < optionInputs.length; i++) {
            if (optionInputs[i].value.trim()) {
                options.push(optionInputs[i].value.trim());
            }
            if (radios[i].checked) {
                correctAnswer = i;
            }
        }
        
        if (!title || !question || options.length < 2) {
            alert('ì œëª©, ë¬¸ì œ, ìµœì†Œ 2ê°œ ì„ íƒì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        document.getElementById('previewQuestion').textContent = question;
        var optionsHtml = options.map(function(option, index) {
            var isCorrect = index === correctAnswer;
            return (index + 1) + '. ' + option + (isCorrect ? ' âœ“' : '');
        }).join('<br>');
        document.getElementById('previewOptions').innerHTML = optionsHtml;
        document.getElementById('quizPreview').style.display = 'block';
    }

    function sendQuizConfirm() {
        var title = document.getElementById('quizTitle').value.trim();
        var question = document.getElementById('quizQuestion').value.trim();
        var options = [];
        var correctAnswer = null;
        
        var optionInputs = document.querySelectorAll('.option-input');
        var radios = document.querySelectorAll('input[name="correctAnswer"]');
        
        for (var i = 0; i < optionInputs.length; i++) {
            if (optionInputs[i].value.trim()) {
                options.push(optionInputs[i].value.trim());
            }
            if (radios[i].checked) {
                correctAnswer = i;
            }
        }
        
        if (!title || !question || options.length < 2) {
            alert('ì œëª©, ë¬¸ì œ, ìµœì†Œ 2ê°œ ì„ íƒì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (correctAnswer === null) {
            alert('ì •ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const token = getAuthToken();
        fetch('/api/teacher/quick-quiz', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                title: title,
                question: question,
                options: options,
                correctAnswer: correctAnswer
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('í€´ì¦ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeModal('quizModal');
            } else {
                alert('í€´ì¦ˆ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(function() {
            alert('í€´ì¦ˆ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    }

    function sendHintConfirm() {
        var message = document.getElementById('hintMessage').value.trim();
        if (!message) {
            alert('íŒíŠ¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const token = getAuthToken();
        fetch('/api/teacher/send-hint', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ studentId: currentStudentId, message: message })
        })
        .then(function() {
            alert('íŒíŠ¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeModal('hintModal');
        })
        .catch(function() {
            alert('íŒíŠ¸ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    }

    function sendGlobalHintConfirm() {
        var message = document.getElementById('globalHintMessage').value.trim();
        if (!message) {
            alert('íŒíŠ¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const token = getAuthToken();
        fetch('/api/teacher/global-hint', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ message: message })
        })
        .then(function() {
            alert('ì „ì²´ íŒíŠ¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeModal('globalHintModal');
        })
        .catch(function() {
            alert('íŒíŠ¸ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    }

    function createProblemConfirm() {
        var title = document.getElementById('problemTitle').value.trim();
        var description = document.getElementById('problemDescription').value.trim();
        
        if (!title || !description) {
            alert('ë¬¸ì œ ì œëª©ê³¼ ì„¤ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const token = getAuthToken();
        fetch('/api/teacher/create-problem', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ title: title, description: description })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('ë¬¸ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì¶œì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeModal('createProblemModal');
            } else {
                alert('ë¬¸ì œ ì¶œì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(function() {
            alert('ë¬¸ì œ ì¶œì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    }

    function monitorStudent(studentId) {
        window.open('/battle?monitor=' + studentId, '_blank');
    }

    document.addEventListener('change', function(e) {
        if (e.target.name === 'correctAnswer') {
            var optionInputs = document.querySelectorAll('.option-input');
            optionInputs.forEach(function(input) {
                input.classList.remove('correct-option');
            });
            var selectedOption = document.querySelector('.option-input[data-option="' + e.target.value + '"]');
            if (selectedOption) {
                selectedOption.classList.add('correct-option');
            }
        }
    });

    window.onclick = function(event) {
        var modals = document.querySelectorAll('.modal');
        for (var i = 0; i < modals.length; i++) {
            if (event.target === modals[i]) {
                modals[i].style.display = 'none';
            }
        }
    }

    checkTeacherAuth();
    loadUserNames();
    connect();
    refreshData();
    setInterval(refreshData, 10000);
    setInterval(loadUserNames, 30000);
    </script>
</body>
</html>